<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="{{ municipio.cor_primaria || '#1a56db' }}">
  <meta name="csrf-token" content="{{ csrfToken }}">
  <title>VotaLegis - {{ vereador.nome_parlamentar || vereador.nome }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --cor-primaria: {{ municipio.cor_primaria || '#1a56db' }};
      --cor-secundaria: {{ municipio.cor_secundaria || '#1e40af' }};
    }
    
    body {
      background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      min-height: 100vh;
    }
    
    .header-card {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .card-votacao {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      margin-bottom: 1rem;
    }
    
    .card-votacao-header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 1rem;
      text-align: center;
    }
    
    .btn-voto {
      width: 100%;
      padding: 1.5rem;
      font-size: 1.5rem;
      font-weight: bold;
      border-radius: 12px;
      border: none;
      transition: all 0.2s;
    }
    
    .btn-voto:active {
      transform: scale(0.98);
    }
    
    .btn-sim {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .btn-nao {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    .btn-abstencao {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
    }
    
    .btn-acao {
      background: rgba(255,255,255,0.95);
      border: none;
      border-radius: 12px;
      padding: 1rem;
      width: 100%;
      font-weight: 600;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    
    .btn-acao:active {
      transform: scale(0.98);
    }
    
    .btn-acao i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 0.5rem;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .voto-confirmado {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 2rem;
      text-align: center;
      border-radius: 12px;
    }
    
    .sem-sessao {
      text-align: center;
      color: white;
      padding: 3rem 1rem;
    }
    
    .sem-sessao i {
      font-size: 4rem;
      opacity: 0.7;
    }
    
    .footer-fixed {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.95);
      padding: 1rem;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body x-data="vereadorApp()" x-init="init()">
  <div class="app-container pb-5">
    {{-- Header --}}
    <div class="header-card">
      <div class="d-flex align-items-center">
        @if(vereador.foto_url)
          <img src="{{ vereador.foto_url }}" class="rounded-circle me-3" width="56" height="56" alt="">
        @else
          <div class="rounded-circle bg-primary me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
            <i class="bi bi-person-fill text-white" style="font-size: 1.5rem;"></i>
          </div>
        @endif
        <div class="flex-grow-1">
          <h5 class="mb-0">{{ vereador.nome_parlamentar || vereador.nome }}</h5>
          <small class="text-muted">{{ vereador.partido_sigla }} | {{ municipio.nome }}</small>
        </div>
        <a href="{{ route('logout') }}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-box-arrow-right"></i>
        </a>
      </div>
    </div>

    @if(!sessao)
      {{-- Sem sessão ativa --}}
      <div class="sem-sessao">
        <i class="bi bi-calendar-x"></i>
        <h4 class="mt-3">Nenhuma sessão em andamento</h4>
        <p class="opacity-75">Você será notificado quando uma sessão iniciar</p>
      </div>
    @else
      {{-- Sessão Info --}}
      <div class="header-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">Sessão {{ sessao.tipo | capitalize }} {{ sessao.numero }}/{{ sessao.ano }}</h6>
            <small class="text-muted">{{ new Date(sessao.data).toLocaleDateString('pt-BR') }}</small>
          </div>
          <div>
            @if(presenca && presenca.presente)
              <span class="status-badge" style="background: #10b981; color: white;">
                <i class="bi bi-check-circle-fill"></i> Presente
              </span>
            @else
              <span class="status-badge" style="background: #ef4444; color: white;">
                <i class="bi bi-x-circle-fill"></i> Ausente
              </span>
            @endif
          </div>
        </div>
      </div>

      {{-- Votação em Andamento --}}
      @if(votacaoEmAndamento)
        <div class="card-votacao">
          <div class="card-votacao-header">
            <i class="bi bi-hand-thumbs-up-fill me-2"></i>
            <strong>VOTAÇÃO EM ANDAMENTO</strong>
          </div>
          <div class="p-3">
            @if(votacaoEmAndamento.materia_prefixo)
              <h5 class="mb-1">
                {{ votacaoEmAndamento.materia_prefixo }} {{ votacaoEmAndamento.materia_numero }}/{{ votacaoEmAndamento.materia_ano }}
              </h5>
              <p class="text-muted small mb-3">{{ votacaoEmAndamento.materia_ementa }}</p>
            @else
              <h5 class="mb-3">{{ votacaoEmAndamento.descricao }}</h5>
            @endif

            @if(jaVotou)
              <div class="voto-confirmado">
                <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                <h4 class="mt-2 mb-0">Voto Registrado!</h4>
                <p class="mb-0 opacity-75">Aguarde o resultado</p>
              </div>
            @else
              <form action="{{ route('vereador.votar') }}" method="POST" id="formVoto">
                {{ csrfField() }}
                <div class="d-grid gap-3">
                  <button type="button" class="btn-voto btn-sim" onclick="confirmarVoto('sim')">
                    <i class="bi bi-hand-thumbs-up-fill me-2"></i>SIM
                  </button>
                  <button type="button" class="btn-voto btn-nao" onclick="confirmarVoto('nao')">
                    <i class="bi bi-hand-thumbs-down-fill me-2"></i>NÃO
                  </button>
                  <button type="button" class="btn-voto btn-abstencao" onclick="confirmarVoto('abstencao')">
                    <i class="bi bi-dash-circle-fill me-2"></i>ABSTENÇÃO
                  </button>
                </div>
                <input type="hidden" name="voto" id="inputVoto">
              </form>
            @endif
          </div>
        </div>
      @endif

      {{-- Ações Rápidas --}}
      <div class="row g-3 mb-4">
        @if(!presenca || !presenca.presente)
          <div class="col-6">
            <form action="{{ route('vereador.marcar-presenca') }}" method="POST">
              {{ csrfField() }}
              <button type="submit" class="btn-acao text-success">
                <i class="bi bi-check-circle-fill"></i>
                Marcar Presença
              </button>
            </form>
          </div>
        @endif
        
        <div class="{{ !presenca || !presenca.presente ? 'col-6' : 'col-12' }}">
          <button type="button" class="btn-acao text-primary" data-bs-toggle="modal" data-bs-target="#modalPalavra">
            <i class="bi bi-mic-fill"></i>
            Pedir Palavra
          </button>
        </div>
      </div>

      {{-- Inscrições Ativas --}}
      @if(inscricoes.length > 0)
        <div class="header-card">
          <h6 class="mb-3"><i class="bi bi-mic me-2"></i>Minhas Inscrições</h6>
          @each(i in inscricoes)
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <span class="badge bg-secondary me-2">{{ i.ordem }}º</span>
                {{ i.tipo | replace('_', ' ') | capitalize }}
              </div>
              <div>
                @if(i.status === 'falando')
                  <span class="badge bg-success">Falando</span>
                @else
                  <form action="{{ route('vereador.cancelar-palavra', { inscricaoId: i.id }) }}" method="POST" class="d-inline">
                    {{ csrfField() }}
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-x"></i> Cancelar
                    </button>
                  </form>
                @endif
              </div>
            </div>
          @endeach
        </div>
      @endif

      {{-- Criar Matéria com IA --}}
      <div class="header-card mt-3">
        <a href="{{ route('materias.criar-ia') }}" class="btn-acao text-info d-block text-decoration-none">
          <i class="bi bi-stars"></i>
          Criar Matéria com IA
        </a>
        <small class="text-muted text-center d-block mt-2">
          Crie requerimentos, indicações e projetos automaticamente
        </small>
      </div>
    @endif
  </div>

  {{-- Modal Pedir Palavra --}}
  <div class="modal fade" id="modalPalavra" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pedir Palavra</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form action="{{ route('vereador.pedir-palavra') }}" method="POST">
          {{ csrfField() }}
          <div class="modal-body">
            <div class="d-grid gap-2">
              <button type="submit" name="tipo" value="pequeno_expediente" class="btn btn-lg btn-outline-primary">
                <i class="bi bi-clock me-2"></i>Pequeno Expediente
              </button>
              <button type="submit" name="tipo" value="grande_expediente" class="btn btn-lg btn-outline-primary">
                <i class="bi bi-clock-fill me-2"></i>Grande Expediente
              </button>
              <button type="submit" name="tipo" value="explicacao_pessoal" class="btn btn-lg btn-outline-secondary">
                <i class="bi bi-chat-dots me-2"></i>Explicação Pessoal
              </button>
              <button type="submit" name="tipo" value="questao_ordem" class="btn btn-lg btn-outline-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>Questão de Ordem
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  {{-- Modal Confirmar Voto --}}
  <div class="modal fade" id="modalConfirmarVoto" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <h4 id="textoConfirmacao"></h4>
          <p class="text-muted">Esta ação não pode ser desfeita.</p>
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-lg btn-primary" onclick="enviarVoto()">
              <i class="bi bi-check-lg me-2"></i>Confirmar
            </button>
            <button type="button" class="btn btn-lg btn-outline-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    let votoSelecionado = null;
    const modalConfirmar = new bootstrap.Modal(document.getElementById('modalConfirmarVoto'));

    function confirmarVoto(voto) {
      votoSelecionado = voto;
      const textos = {
        'sim': 'Confirma seu voto SIM?',
        'nao': 'Confirma seu voto NÃO?',
        'abstencao': 'Confirma sua ABSTENÇÃO?'
      };
      document.getElementById('textoConfirmacao').textContent = textos[voto];
      modalConfirmar.show();
    }

    function enviarVoto() {
      document.getElementById('inputVoto').value = votoSelecionado;
      document.getElementById('formVoto').submit();
    }

    function vereadorApp() {
      return {
        eventSource: null,

        init() {
          @if(sessao)
            this.connectSSE();
          @endif
        },

        connectSSE() {
          this.eventSource = new EventSource('/api/sse/sessao/{{ sessao?.id || 0 }}');

          this.eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Evento:', data.type);

            if (['votacao:iniciada', 'votacao:encerrada', 'sessao:iniciada', 'sessao:encerrada'].includes(data.type)) {
              location.reload();
            }
          };

          this.eventSource.onerror = () => {
            setTimeout(() => this.connectSSE(), 5000);
          };
        }
      }
    }
  </script>
</body>
</html>
