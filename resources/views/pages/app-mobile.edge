<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ponto Mobile">

  <title>Ponto Mobile | Selfie + GPS</title>

  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    /* Desabilitar pull-to-refresh do navegador */
    html, body {
      overscroll-behavior-y: contain;
    }
    
    .app-container {
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
    }

    :root {
      --primary: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #0ea5e9;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f3f4f6;
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }

    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      max-width: 500px;
      margin: 0 auto;
      background: white;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top, 0px));
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .main-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      padding-bottom: 80px;
    }

    /* Login Form */
    .login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
    }

    .login-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 350px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .login-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 36px;
      color: white;
    }

    /* Alerta Banner */
    .alert-banner {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-banner.feriado {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
    }

    .alert-banner.facultativo {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1e40af;
    }

    .alert-banner i {
      font-size: 24px;
    }

    .alert-banner .alert-text {
      flex: 1;
    }

    .alert-banner .alert-title {
      font-weight: 600;
      font-size: 14px;
    }

    .alert-banner .alert-desc {
      font-size: 12px;
      opacity: 0.8;
    }

    /* Mensagens Section (homepage) */
    .mensagens-section {
      margin-bottom: 16px;
    }

    .mensagem-card {
      background: #fff7ed;
      border-left: 4px solid var(--warning);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .mensagem-card.info {
      background: #eff6ff;
      border-left-color: var(--info);
    }

    .mensagem-card.success {
      background: #f0fdf4;
      border-left-color: var(--success);
    }

    .mensagem-card.warning {
      background: #fef3c7;
      border-left-color: var(--warning);
    }

    .mensagem-card.danger {
      background: #fef2f2;
      border-left-color: var(--danger);
    }

    .mensagem-card .mensagem-header {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .mensagem-card .mensagem-texto {
      font-size: 13px;
      color: #1e293b;
    }

    /* Page Mensagens - Chat Style */
    .mensagens-page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .mensagens-page-header .icon-circle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .mensagens-page-header .header-text h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .mensagens-page-header .header-text p {
      margin: 0;
      font-size: 12px;
      color: #6b7280;
    }

    .mensagens-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mensagem-item {
      background: white;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e5e7eb;
    }

    .mensagem-item.unread {
      border-left: 4px solid var(--primary);
      background: #f8fafc;
    }

    .mensagem-item .msg-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .mensagem-item .msg-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .mensagem-item .msg-icon.info {
      background: #dbeafe;
      color: var(--info);
    }

    .mensagem-item .msg-icon.alerta {
      background: #fef3c7;
      color: var(--warning);
    }

    .mensagem-item .msg-icon.urgente {
      background: #fee2e2;
      color: var(--danger);
    }

    .mensagem-item .msg-icon.sucesso {
      background: #dcfce7;
      color: var(--success);
    }

    .mensagem-item .msg-meta {
      flex: 1;
    }

    .mensagem-item .msg-title {
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
    }

    .mensagem-item .msg-date {
      font-size: 11px;
      color: #9ca3af;
    }

    .mensagem-item .msg-body {
      font-size: 13px;
      color: #4b5563;
      line-height: 1.5;
    }

    .mensagem-item .msg-categoria {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 500;
      margin-top: 8px;
      background: #f3f4f6;
      color: #6b7280;
    }

    .empty-mensagens {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-mensagens .empty-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .empty-mensagens .empty-icon i {
      font-size: 36px;
      color: #9ca3af;
    }

    .empty-mensagens h4 {
      font-size: 16px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .empty-mensagens p {
      font-size: 14px;
      color: #9ca3af;
    }

    /* Mensagem item animations */
    .mensagem-item {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      position: relative;
      touch-action: pan-y;
      -webkit-user-select: none;
      user-select: none;
    }

    .mensagem-item:active {
      transform: scale(0.98);
    }

    .mensagens-list {
      animation: fadeInUp 0.3s ease;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }

    /* Prevent pull-to-refresh on messages page */
    #pageMensagens {
      overscroll-behavior: contain;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Message Actions */
    .msg-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    .msg-action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .msg-action-btn.read {
      background: #dbeafe;
      color: #2563eb;
    }

    .msg-action-btn.read:hover {
      background: #bfdbfe;
    }

    .msg-action-btn.delete {
      background: #fee2e2;
      color: #dc2626;
    }

    .msg-action-btn.delete:hover {
      background: #fecaca;
    }

    .msg-action-btn.read-indicator {
      background: #dcfce7;
      color: #16a34a;
      cursor: default;
    }

    /* Message Detail Modal */
    .msg-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }

    .msg-detail-modal.show {
      display: flex;
    }

    .msg-detail-content {
      background: white;
      width: 100%;
      max-width: 500px;
      max-height: 80vh;
      border-radius: 20px 20px 0 0;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    .msg-detail-header {
      padding: 20px;
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: white;
      position: relative;
    }

    .msg-detail-header .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .msg-detail-header .msg-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      font-size: 12px;
      margin-bottom: 12px;
    }

    .msg-detail-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .msg-detail-header .msg-date {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .msg-detail-body {
      padding: 20px;
      max-height: 50vh;
      overflow-y: auto;
    }

    .msg-detail-body .msg-text {
      font-size: 15px;
      line-height: 1.6;
      color: #374151;
    }

    .msg-detail-body .msg-categoria-badge {
      display: inline-block;
      padding: 4px 12px;
      background: #f3f4f6;
      border-radius: 20px;
      font-size: 12px;
      color: #6b7280;
      margin-top: 16px;
    }

    .msg-detail-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }

    .msg-detail-footer button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .msg-detail-footer .btn-delete {
      background: #fee2e2;
      color: #dc2626;
    }

    .msg-detail-footer .btn-close-detail {
      background: var(--primary);
      color: white;
    }

    /* Confirm Modal */
    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .confirm-modal.show {
      display: flex;
    }

    .confirm-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 320px;
      text-align: center;
      padding: 24px;
      animation: scaleIn 0.2s ease;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .confirm-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #fee2e2;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }

    .confirm-icon i {
      font-size: 28px;
      color: #dc2626;
    }

    .confirm-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .confirm-text {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .confirm-buttons {
      display: flex;
      gap: 12px;
    }

    .confirm-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .confirm-buttons .btn-cancel {
      background: #f3f4f6;
      color: #374151;
    }

    .confirm-buttons .btn-confirm-delete {
      background: #dc2626;
      color: white;
    }

    /* Presencas Page */
    .presencas-page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .presencas-page-header .icon-circle.presenca {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .presencas-map {
      height: 200px;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
      background: #e5e7eb;
    }

    .presencas-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .presenca-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e5e7eb;
    }

    .presenca-item .presenca-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    .presenca-item .presenca-info {
      flex: 1;
    }

    .presenca-item .presenca-hora {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    .presenca-item .presenca-local {
      font-size: 12px;
      color: #6b7280;
    }

    .presenca-item .presenca-foto {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
    }

    .empty-presencas {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }

    .empty-presencas i {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Nav badge */
    .nav-item .badge {
      position: absolute;
      top: 2px;
      right: 8px;
      background: var(--danger);
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 9px;
      font-weight: 600;
      min-width: 16px;
    }

    .nav-item {
      position: relative;
    }

    /* User Info Card */
    .user-info {
      background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
      border-radius: 16px;
      padding: 20px;
      color: white;
      margin-bottom: 16px;
    }

    .user-info .name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .user-info .role {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Status Cards */
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .status-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .status-card .label {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .status-card .value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
    }

    .status-card.highlight {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    }

    .status-card.highlight .value {
      color: var(--success);
    }

    /* Big Button */
    .btn-registrar {
      width: 100%;
      padding: 20px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 16px;
    }

    .btn-registrar:active {
      transform: scale(0.98);
    }

    .btn-registrar.saida {
      background: linear-gradient(135deg, var(--danger), #dc2626);
    }

    .btn-registrar i {
      font-size: 28px;
    }

    .btn-registrar:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Botao Presenca */
    .btn-presenca {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--warning), #d97706);
      color: white;
      font-size: 16px;
      font-weight: 600;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 16px;
    }

    .btn-presenca.visible {
      display: flex;
    }

    .btn-presenca:active {
      transform: scale(0.98);
    }

    .btn-presenca.atrasado {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      animation: pulse-alert 1s infinite;
    }

    .btn-presenca.aguardando {
      background: linear-gradient(135deg, #9ca3af, #6b7280);
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-presenca.aguardando .timer {
      font-size: 14px;
      font-weight: 600;
    }

    .btn-presenca.liberado {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      animation: pulse-ready 1.5s infinite;
    }

    @keyframes pulse-alert {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes pulse-ready {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .btn-presenca i {
      font-size: 24px;
    }

    .btn-presenca .timer {
      font-size: 12px;
      opacity: 0.9;
    }

    .btn-presenca .status-text {
      font-size: 11px;
      opacity: 0.8;
    }

    /* Botao Atendimento */
    .btn-atendimento-hidden {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      font-size: 16px;
      font-weight: 600;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 16px;
    }

    .btn-atendimento.visible {
      display: flex;
    }

    .btn-atendimento:active {
      transform: scale(0.98);
    }

    .btn-atendimento.em-andamento {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      animation: pulse-ready 1.5s infinite;
    }

    .btn-atendimento i {
      font-size: 24px;
    }

    .btn-atendimento .timer {
      font-size: 12px;
      opacity: 0.9;
    }

    /* Camera Permission Link */
    .camera-permission-link {
      text-align: center;
      margin: 12px 0;
    }

    .camera-permission-link a {
      color: #6b7280;
      font-size: 12px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .camera-permission-link a:hover {
      color: var(--primary);
    }

    /* Camera Permission Modal */
    .permission-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .permission-modal.show {
      display: flex;
    }

    .permission-modal-content {
      background: white;
      border-radius: 16px;
      max-width: 400px;
      width: 100%;
      overflow: hidden;
    }

    .permission-modal-header {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      padding: 20px;
      color: white;
      text-align: center;
    }

    .permission-modal-header i {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .permission-modal-header h4 {
      margin: 0;
      font-size: 18px;
    }

    .permission-modal-body {
      padding: 20px;
    }

    .permission-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .permission-status.granted {
      background: #dcfce7;
      color: #166534;
    }

    .permission-status.denied {
      background: #fee2e2;
      color: #991b1b;
    }

    .permission-status.prompt {
      background: #fef3c7;
      color: #92400e;
    }

    .permission-instructions {
      font-size: 13px;
      color: #4b5563;
      line-height: 1.6;
    }

    .permission-instructions h5 {
      font-size: 14px;
      color: #1f2937;
      margin: 16px 0 8px;
    }

    .permission-instructions ol {
      padding-left: 20px;
      margin: 0;
    }

    .permission-instructions li {
      margin-bottom: 8px;
    }

    .permission-modal-footer {
      padding: 16px 20px;
      display: flex;
      gap: 10px;
      border-top: 1px solid #e5e7eb;
    }

    .permission-modal-footer button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-permission-close {
      background: #f3f4f6;
      border: none;
      color: #374151;
    }

    .btn-permission-request {
      background: var(--primary);
      border: none;
      color: white;
    }

    /* Registros List */
    .registros-section,
    .map-section {
      background: #f1f5f9;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title i {
      font-size: 18px;
      color: #64748b;
    }

    .registro-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: #f8fafc;
      border-radius: 14px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: transform 0.2s;
    }
    
    .registro-item:active {
      transform: scale(0.98);
    }

    .registro-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      flex-shrink: 0;
    }

    .registro-icon.entrada { 
      background: linear-gradient(135deg, #10b981, #059669);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .registro-icon.saida { 
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .registro-icon.intervalo_inicio,
    .registro-icon.intervalo_fim { 
      background: linear-gradient(135deg, #f59e0b, #d97706);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .registro-info {
      flex: 1;
    }

    .registro-info .tipo {
      font-weight: 600;
      font-size: 15px;
      color: #1e293b;
      letter-spacing: 0.5px;
    }

    .registro-info .hora {
      font-size: 13px;
      color: #64748b;
      font-weight: 500;
    }

    .registro-gps {
      font-size: 11px;
      color: #64748b;
    }

    /* Map Section */
    .map-section {
      margin-top: 16px;
    }

    #mapContainer {
      height: 200px;
      border-radius: 12px;
      overflow: hidden;
      background: #e2e8f0;
      margin: 0;
    }

    /* Jornada Section */
    .jornada-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .jornada-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .jornada-item:last-child {
      border-bottom: none;
    }

    .jornada-dia {
      font-weight: 500;
      color: #1e293b;
    }

    .jornada-horarios {
      color: #64748b;
      font-size: 13px;
    }

    /* Espelho Section */
    .espelho-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .espelho-nav {
      display: flex;
      gap: 8px;
    }

    .espelho-nav button {
      background: #e2e8f0;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }

    .espelho-table {
      width: 100%;
      font-size: 12px;
    }

    .espelho-table th {
      background: #f1f5f9;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
    }

    .espelho-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .espelho-table tr.feriado td {
      background: #fef3c7;
    }

    

    /* Perfil Section */
    .perfil-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .perfil-header {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      padding: 24px;
      text-align: center;
      color: white;
    }

    .perfil-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: var(--primary);
    }

    .perfil-nome {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .perfil-cargo {
      font-size: 14px;
      opacity: 0.8;
    }

    .perfil-body {
      padding: 16px;
    }

    .perfil-item {
      display: flex;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #f1f5f9;
      gap: 12px;
    }

    .perfil-item:last-child {
      border-bottom: none;
    }

    .perfil-item > i {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      color: var(--primary);
      font-size: 16px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .perfil-item .label {
      font-size: 12px;
      color: #64748b;
    }

    .perfil-item .value {
      font-size: 14px;
      color: #1e293b;
      font-weight: 500;
    }

    /* Perfil Sections */
    .perfil-section {
      padding: 16px;
      border-top: 8px solid #f3f4f6;
    }

    .perfil-section-title {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .perfil-section-title i {
      font-size: 14px;
    }

    /* Toggle Switch */
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .setting-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .setting-icon.biometric {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .setting-icon.notification {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .setting-icon.logout {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .setting-text .setting-label {
      font-size: 14px;
      font-weight: 500;
      color: #1e293b;
    }

    .setting-text .setting-desc {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
      background: #e2e8f0;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-switch.active {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch.active::after {
      transform: translateX(22px);
    }

    .toggle-switch.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Action Buttons in Profile */
    .perfil-actions {
      padding: 20px 16px;
      background: #f8fafc;
    }

    .btn-logout {
      width: 100%;
      padding: 16px 20px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      color: white;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      cursor: pointer;
    }

    .btn-logout:hover, .btn-logout:active {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }
    /* Perfil Layout Melhorado */
    .perfil-body {
      padding: 0;
    }

    .perfil-section-inline {
      padding: 16px 20px;
      border-bottom: 1px solid #f1f5f9;
    }

    .perfil-section-inline:last-child {
      border-bottom: none;
    }

    .perfil-section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .perfil-section-header i {
      font-size: 14px;
      color: var(--primary);
    }

    .perfil-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .perfil-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .perfil-field.full {
      grid-column: 1 / -1;
    }

    .perfil-label {
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .perfil-value {
      font-size: 14px;
      color: #1e293b;
      font-weight: 500;
    }

    .perfil-biometric-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }

    .perfil-biometric-status {
      font-size: 14px;
      color: #64748b;
    }

    .perfil-logout-section {
      padding: 20px;
      background: #f8fafc;
    }

    .perfil-logout-btn {
      width: 100%;
      padding: 14px 20px;
      background: #fff;
      border: 2px solid #ef4444;
      color: #ef4444;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .perfil-logout-btn:hover,
    .perfil-logout-btn:active {
      background: #ef4444;
      color: white;
    }

    .perfil-logout-btn i {
      font-size: 18px;
    }

    .perfil-version {
      text-align: center;
      padding: 16px;
      font-size: 12px;
      color: #94a3b8;
    }

    /* Dark Mode - Perfil Melhorado */
    .dark-mode .perfil-section-inline {
      border-bottom-color: #374151;
    }

    .dark-mode .perfil-section-header {
      color: #9ca3af;
    }

    .dark-mode .perfil-label {
      color: #6b7280;
    }

    .dark-mode .perfil-value {
      color: #f3f4f6;
    }

    .dark-mode .perfil-biometric-status {
      color: #9ca3af;
    }

    .dark-mode .perfil-logout-section {
      background: #1f2937;
    }

    .dark-mode .perfil-logout-btn {
      background: transparent;
      border-color: #f87171;
      color: #f87171;
    }

    .dark-mode .perfil-logout-btn:hover,
    .dark-mode .perfil-logout-btn:active {
      background: #f87171;
      color: #1f2937;
    }

    .dark-mode .perfil-version {
      color: #6b7280;
    }

    
    .btn-logout i {
      font-size: 18px;
    }

    /* App Version */
    .app-version {
      text-align: center;
      padding: 20px 16px;
      color: #94a3b8;
      font-size: 13px;
      background: #f8fafc;
      font-size: 12px;
    }

    /* Modal de Captura */
    .modal-capture {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 99999;
      display: none;
      flex-direction: column;
    }

    .modal-capture.show {
      display: flex;
    }

    .modal-capture-header {
      padding: 16px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-capture-header h2 {
      font-size: 18px;
      margin: 0;
    }

    .modal-capture-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .camera-container {
      position: relative;
      width: 100%;
      max-width: 300px;
      aspect-ratio: 3/4;
      border-radius: 16px;
      overflow: hidden;
      background: #1e293b;
    }

    .camera-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }

    .camera-container canvas {
      display: none;
    }

    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 180px;
      height: 220px;
      border: 3px dashed rgba(255,255,255,0.5);
      border-radius: 50%;
    }

    .gps-status {
      margin-top: 16px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 30px;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .gps-status.success {
      background: rgba(16, 185, 129, 0.3);
    }

    .gps-status.error {
      background: rgba(239, 68, 68, 0.3);
    }

    .gps-status.warning {
      background: rgba(245, 158, 11, 0.3);
    }

    .gps-status i {
      font-size: 18px;
    }

    .modal-capture-footer {
      padding: 24px;
      display: flex;
      gap: 16px;
    }

    .btn-capture {
      flex: 1;
      padding: 16px;
      border-radius: 30px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-capture.primary {
      background: white;
      color: var(--primary);
    }

    .btn-capture.secondary {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .btn-capture:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Feedback de Sucesso */
    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(16, 185, 129, 0.95);
      z-index: 99999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .success-overlay.show {
      display: flex;
    }

    .success-overlay i {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .success-overlay .message {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .success-overlay .submessage {
      font-size: 16px;
      opacity: 0.9;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      background: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 8px));
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      z-index: 10000;
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    
    .bottom-nav::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 500;
      color: #64748b;
      text-decoration: none;
      padding: 8px 12px;
      cursor: pointer;
      border: none;
      background: none;
      flex: 1;
      max-width: 80px;
      transition: color 0.2s;
      position: relative;
    }

    .nav-item i {
      font-size: 22px;
      margin-bottom: 4px;
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
    }

    /* Install Banner */
    .install-banner {
      position: fixed;
      bottom: 70px;
      left: 16px;
      right: 16px;
      max-width: 468px;
      margin: 0 auto;
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 99;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .install-banner.show {
      display: flex;
    }

    .install-banner i {
      font-size: 24px;
    }

    .install-banner .install-text {
      flex: 1;
    }

    .install-banner .install-title {
      font-weight: 600;
      font-size: 14px;
    }

    .install-banner .install-desc {
      font-size: 12px;
      opacity: 0.8;
    }

    .install-banner .btn-install {
      background: white;
      color: var(--primary);
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }

    .install-banner .btn-close-install {
      background: none;
      border: none;
      color: white;
      opacity: 0.7;
      cursor: pointer;
      padding: 4px;
    }

    /* Hide/Show states */
    .hidden { display: none !important; }

    /* Page views */
    .page-view {
      display: none;
    }

    .page-view.active {
      display: block;
    }

    /* Leaflet fixes */
    .leaflet-container {
      font-family: inherit;
    }

    /* Loading spinner */
    .loading-spinner {
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    /* Offline Indicator */
    .offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 8px 16px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    .offline-indicator.show {
      transform: translateY(0);
    }

    .offline-indicator i {
      font-size: 16px;
    }

    /* Sync Toast */
    .toast-sync {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 9998;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast-sync.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast-sync i {
      font-size: 18px;
    }

    /* Pending Badge */
    .pending-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #f59e0b;
      color: white;
      font-size: 10px;
      font-weight: 700;
      min-width: 18px;
      height: 18px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Offline saved message */
    .offline-saved-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
      padding: 20px;
    }

    .offline-saved-overlay i {
      font-size: 64px;
      color: #f59e0b;
      margin-bottom: 20px;
    }

    .offline-saved-overlay h3 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .offline-saved-overlay p {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .header-top {
      position: relative;
    }
    /* ========== OFFLINE MODE STYLES ========== */
    .offline-container { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh; padding: 20px; }
    .offline-container.active { display: flex; }
    .offline-card { background: white; border-radius: 16px; padding: 32px; width: 100%; max-width: 350px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
    .offline-icon { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 36px; color: white; }
    .offline-status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #fef3c7; color: #92400e; border-radius: 20px; font-size: 12px; font-weight: 500; margin-bottom: 16px; }
    .offline-time { font-size: 48px; font-weight: 700; color: var(--primary); margin: 16px 0; }
    .offline-date { font-size: 14px; color: #6b7280; margin-bottom: 20px; }
    .offline-user { font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 8px; }
    .offline-pending { background: #fef3c7; border-radius: 8px; padding: 12px; margin-top: 16px; font-size: 13px; color: #92400e; }
    .btn-offline-ponto { width: 120px; height: 120px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white; font-size: 16px; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; margin: 20px auto; cursor: pointer; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); transition: transform 0.2s, box-shadow 0.2s; }
    .btn-offline-ponto:active { transform: scale(0.95); }
    .btn-offline-ponto i { font-size: 32px; }
    .offline-success { background: #dcfce7; color: #166534; padding: 12px; border-radius: 8px; margin-top: 16px; display: none; }
    .offline-success.show { display: block; }

    
    /* Safe Area para dispositivos com notch/gesture bar */
    :root {
      --safe-area-bottom: env(safe-area-inset-bottom, 20px);
    }

    .bottom-nav {
      padding-bottom: calc(8px + var(--safe-area-bottom));
      padding-bottom: calc(8px + env(safe-area-inset-bottom, 20px));
    }

    .main-content {
      padding-bottom: calc(80px + env(safe-area-inset-bottom, 20px));
    }

    .app-container {
      padding-bottom: calc(70px + env(safe-area-inset-bottom, 20px));
    }

    /* Fallback para dispositivos sem safe-area */
    @supports not (padding-bottom: env(safe-area-inset-bottom)) {
      .bottom-nav {
        padding-bottom: 24px;
      }
      .main-content {
        padding-bottom: 100px;
      }
      .app-container {
        padding-bottom: 90px;
      }
    }


    /* Dark Mode */
    
    /* Prevenir pull-to-refresh indesejado */
    html, body {
      overscroll-behavior-y: contain;
    }
    
    /* Garantir que mapa fique abaixo do bottom-nav */
    .leaflet-container {
      z-index: 1 !important;
    }
    
    .leaflet-pane {
      z-index: 1 !important;
    }
    
    .leaflet-top, .leaflet-bottom {
      z-index: 2 !important;
    }
    
    /* Safe area para topo (notch/barra de status) */
    @supports (padding-top: env(safe-area-inset-top)) {
      .header {
        padding-top: calc(16px + env(safe-area-inset-top, 0px));
      }
    }

    
    


    
    /* Espelho de Ponto - Estilos */
    .espelho-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .espelho-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .espelho-nav button {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 14px;
      color: #475569;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .espelho-nav button:active {
      background: #e2e8f0;
    }
    
    .espelho-mes {
      font-weight: 600;
      font-size: 16px;
      color: #1e293b;
      min-width: 90px;
      text-align: center;
    }
    
    .espelho-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .espelho-table th {
      background: #f8fafc;
      color: #475569;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .espelho-table td {
      padding: 10px 8px;
      border-top: 1px solid #f1f5f9;
      color: #334155;
    }
    
    .espelho-table tr.falta td {
      background: #fff8f8;
      color: #be123c;
    }
    
    .espelho-table tr.folga td,
    .espelho-table tr.feriado td {
      background: #f0f9ff;
      color: #0369a1;
      font-style: italic;
    }
    
    /* Dark Mode - Espelho */
    .dark-mode .espelho-nav button {
      background: #334155;
      border-color: #475569;
      color: #e2e8f0;
    }
    
    .dark-mode .espelho-mes {
      color: #f1f5f9;
    }
    
    .dark-mode .espelho-table {
      background: #1e293b;
    }
    
    .dark-mode .espelho-table th {
      background: #334155;
      color: #94a3b8;
    }
    
    .dark-mode .espelho-table td {
      border-color: #334155;
      color: #e2e8f0;
    }
    
    .dark-mode .espelho-table tr.falta td {
      background: rgba(190, 18, 60, 0.15);
      color: #fda4af;
    }
    
    .dark-mode .espelho-table tr.folga td,
    .dark-mode .espelho-table tr.feriado td {
      background: rgba(3, 105, 161, 0.15);
      color: #7dd3fc;
    }


    body.dark-mode {
      background: #0f172a;
    }

    .dark-mode .app-container {
      background: #1e293b;
    }

    .dark-mode .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
    }

    .dark-mode .main-content {
      background: #1e293b;
    }

    .dark-mode .user-card,
    .dark-mode .login-card {
      background: #334155;
      color: #f1f5f9;
    }

    .dark-mode .user-card .name,
    .dark-mode .user-name {
      color: #f1f5f9;
    }

    .dark-mode .user-card .role,
    .dark-mode .user-role,
    .dark-mode .date-display {
      color: #94a3b8;
    }

    .dark-mode .clock-display {
      color: #60a5fa;
    }

    .dark-mode .status-card {
      background: #475569;
    }

    .dark-mode .status-card .label {
      color: #94a3b8;
    }

    .dark-mode .status-card .value {
      color: #f1f5f9;
    }

    
    .dark-mode .registros-section,
    .dark-mode .map-section {
      background: #1e293b;
    }
    
    .dark-mode .section-title {
      color: #94a3b8;
    }
    
    .dark-mode .section-title i {
      color: #64748b;
    }



    
    .dark-mode .registro-item {
      background: #334155;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .dark-mode .registro-info .tipo {
      color: #f1f5f9;
    }
    
    .dark-mode .registro-info .hora {
      color: #94a3b8;
    }
    
    .dark-mode .registro-gps {
      color: #94a3b8;
    }

    .dark-mode .REMOVIDO-registro-item {
      background: #475569;
      border-color: #64748b;
    }

    .dark-mode .registro-item .hora {
      color: #f1f5f9;
    }

    .dark-mode .registro-item .tipo {
      color: #94a3b8;
    }

    .dark-mode .bottom-nav {
      background: #0f172a;
      border-top: 1px solid #334155;
    }

    .dark-mode .bottom-nav .nav-item {
      color: #94a3b8;
    }

    .dark-mode .bottom-nav .nav-item.active {
      color: #60a5fa;
    }

    .dark-mode .alert-banner {
      background: #334155;
      color: #f1f5f9;
    }

    .dark-mode .mensagem-card {
      background: #334155;
      color: #f1f5f9;
    }

    .dark-mode .form-control,
    .dark-mode .form-select {
      background: #475569;
      border-color: #64748b;
      color: #f1f5f9;
    }

    .dark-mode .form-control::placeholder {
      color: #94a3b8;
    }

    .dark-mode .form-label {
      color: #e2e8f0;
    }

    .dark-mode .modal-content,
    .dark-mode .modal-fullscreen {
      background: #1e293b;
      color: #f1f5f9;
    }

    .dark-mode .modal-header-app {
      background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
    }

    .dark-mode .modal-content-app {
      background: #1e293b;
    }

    .dark-mode .jornada-card,
    .dark-mode .espelho-card {
      background: #334155;
      color: #f1f5f9;
    }

    .dark-mode .camera-permission-link a {
      color: #60a5fa;
    }

    .dark-mode .text-muted {
      color: #94a3b8 !important;
    }

    /* Toggle Button */
    .dark-mode-toggle {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 18px;
      transition: all 0.3s;
    }

    .dark-mode-toggle:active {
      transform: scale(0.95);
    }

    .dark-mode .dark-mode-toggle {
      background: rgba(255,255,255,0.1);
    }


    /* Dark Mode - Espelho de Ponto */
    .dark-mode .espelho-header {
      color: #f1f5f9;
    }
    
    .dark-mode .espelho-nav button {
      background: #475569;
      color: #f1f5f9;
      border-color: #64748b;
    }
    
    .dark-mode .espelho-mes {
      color: #f1f5f9;
    }
    
    .dark-mode .espelho-table {
      background: #334155;
    }
    
    .dark-mode .espelho-table th {
      background: #475569;
      color: #f1f5f9;
      border-color: #64748b;
    }
    
    .dark-mode .espelho-table td {
      background: #334155;
      color: #e2e8f0;
      border-color: #475569;
    }
    
    .dark-mode .espelho-table tr.feriado td,
    .dark-mode .espelho-table tr.folga td {
      background: #1e3a5f;
      color: #93c5fd;
    }
    
    .dark-mode 
    
    .dark-mode .espelho-table tr:nth-child(even) td {
      background: #3d4f65;
    }
    
    /* Dark Mode - Jornada */
    .dark-mode .jornada-card {
      background: #334155;
    }
    
    .dark-mode .jornada-card strong,
    .dark-mode .jornada-card b {
      color: #f1f5f9;
    }
    
    .dark-mode .jornada-item {
      border-color: #475569;
    }
    
    .dark-mode .jornada-dia {
      color: #cbd5e1;
    }
    
    .dark-mode .jornada-horarios {
      color: #94a3b8;
    }
    
    /* Dark Mode - Mensagens */
    .dark-mode .mensagem-item {
      background: #334155;
      border-color: #475569;
    }
    
    .dark-mode .mensagem-item.unread {
      border-left-color: #3b82f6;
    }
    
    .dark-mode .msg-title {
      color: #f1f5f9;
    }
    
    .dark-mode .msg-body {
      color: #cbd5e1;
    }
    
    .dark-mode .msg-date {
      color: #94a3b8;
    }
    
    .dark-mode .msg-categoria {
      background: #475569;
      color: #94a3b8;
    }
    
    .dark-mode .msg-action-btn {
      background: #475569;
      color: #94a3b8;
    }
    
    .dark-mode .msg-action-btn.read {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }
    
    .dark-mode .msg-action-btn.delete {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    
    /* Dark Mode - Perfil */
    
    /* Dark Mode - Perfil Completo */
    .dark-mode .perfil-card {
      background: #1e293b;
    }
    
    .dark-mode .perfil-header {
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
    }
    
    .dark-mode .perfil-section {
      background: #1e293b;
      border-top-color: #0f172a;
    }
    
    .dark-mode .perfil-actions {
      background: #0f172a;
    }
    
    .dark-mode .app-version {
      background: #0f172a;
    }
    
    .dark-mode .perfil-item > i {
      background: linear-gradient(135deg, #1e3a5f, #1e293b);
    }
    
    .dark-mode .perfil-section-title {
      color: #94a3b8;
    }
    
    .dark-mode .perfil-item {
      border-bottom-color: #334155;
    }
    
    .dark-mode .perfil-item .label {
      color: #94a3b8;
    }
    
    .dark-mode .perfil-item .value {
      color: #f1f5f9;
    }
    
    .dark-mode .perfil-item i {
      color: #60a5fa;
    }
    
    .dark-mode .setting-item {
      border-bottom-color: #334155;
    }
    
    .dark-mode .setting-text .setting-label {
      color: #f1f5f9;
    }
    
    .dark-mode .setting-text .setting-desc {
      color: #94a3b8;
    }


    .dark-mode .setting-item {
      background: #334155;
      border-color: #475569;
    }
    
    .dark-mode .setting-name {
      color: #f1f5f9;
    }
    
    .dark-mode .setting-desc {
      color: #94a3b8;
    }
    
    /* Dark Mode - Geral */
    .dark-mode h1, .dark-mode h2, .dark-mode h3, 
    .dark-mode h4, .dark-mode h5, .dark-mode h6 {
      color: #f1f5f9;
    }
    
    .dark-mode p {
      color: #cbd5e1;
    }
    
    .dark-mode .card {
      background: #334155;
      border-color: #475569;
    }
    
    .dark-mode .btn-outline-primary {
      color: #60a5fa;
      border-color: #60a5fa;
    }
    
    .dark-mode .btn-outline-secondary {
      color: #94a3b8;
      border-color: #64748b;
    }
    
    .dark-mode small {
      color: #94a3b8;
    }


    /* Dark Mode - Perfil FORCE */
    .dark-mode .perfil-card,
    .dark-mode #perfilContent {
      background: #1e293b !important;
    }
    
    .dark-mode .perfil-section {
      background: #1e293b !important;
      border-top: 8px solid #0f172a !important;
    }
    
    .dark-mode .perfil-section-title {
      color: #94a3b8 !important;
    }
    
    .dark-mode .perfil-item {
      border-bottom-color: #334155 !important;
    }
    
    .dark-mode .perfil-item .label {
      color: #94a3b8 !important;
    }
    
    .dark-mode .perfil-item .value {
      color: #f1f5f9 !important;
    }
    
    .dark-mode .perfil-item > i {
      color: #60a5fa !important;
    }
    
    .dark-mode .perfil-body {
      background: #1e293b !important;
    }


    /* Dark Mode - Modal de Mensagens */
    .dark-mode .modal-mensagem,
    .dark-mode .mensagem-modal,
    .dark-mode .msg-modal {
      background: #1e293b !important;
    }
    
    .dark-mode .modal-mensagem .modal-content,
    .dark-mode .msg-detail-modal {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }
    
    .dark-mode .msg-detail-body {
      background: #1e293b !important;
      color: #e2e8f0 !important;
    }
    
    .dark-mode .msg-detail-content {
      color: #e2e8f0 !important;
    }
    
    /* Botes de ao em mensagens */
    .dark-mode .actions-bar {
      background: #334155 !important;
    }
    
    .dark-mode .btn-action-delete,
    .dark-mode .btn-delete {
      background: rgba(239, 68, 68, 0.2) !important;
      color: #fca5a5 !important;
    }
    
    .dark-mode .btn-action-read,
    .dark-mode .btn-read {
      background: rgba(16, 185, 129, 0.2) !important;
      color: #6ee7b7 !important;
    }
    
    /* Cards de mensagens melhorados */
    .dark-mode .mensagem-card,
    .dark-mode .msg-card {
      background: #334155 !important;
      border-color: #475569 !important;
    }
    
    .dark-mode .mensagem-card .msg-title,
    .dark-mode .msg-card .msg-title {
      color: #f1f5f9 !important;
    }
    
    .dark-mode .mensagem-card .msg-body,
    .dark-mode .msg-card .msg-body,
    .dark-mode .mensagem-card .msg-preview {
      color: #cbd5e1 !important;
    }
    
    .dark-mode .mensagem-card .msg-date,
    .dark-mode .msg-card .msg-date {
      color: #94a3b8 !important;
    }
    
    /* Barra de seleo */
    .dark-mode .selection-bar {
      background: #334155 !important;
      border-color: #475569 !important;
    }
    
    .dark-mode .selection-bar label {
      color: #e2e8f0 !important;
    }

  
    /* Modal de Logout */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      backdrop-filter: blur(4px);
    }

    .modal-logout-container {
      background: white;
      border-radius: 20px;
      padding: 32px 24px;
      width: 100%;
      max-width: 320px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideUp 0.3s ease;
    }

    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-logout-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .modal-logout-icon i {
      font-size: 28px;
      color: #ef4444;
    }

    .modal-logout-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 8px;
    }

    .modal-logout-text {
      font-size: 14px;
      color: #64748b;
      margin: 0 0 24px;
      line-height: 1.5;
    }

    .modal-logout-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-logout-btn-cancel,
    .modal-logout-btn-confirm {
      flex: 1;
      padding: 14px 16px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .modal-logout-btn-cancel {
      background: #f1f5f9;
      color: #475569;
    }

    .modal-logout-btn-cancel:hover {
      background: #e2e8f0;
    }

    .modal-logout-btn-confirm {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .modal-logout-btn-confirm:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.5);
    }

    /* Dark Mode - Modal Logout */
    .dark-mode .modal-logout-container {
      background: #1f2937;
    }

    .dark-mode .modal-logout-icon {
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
    }

    .dark-mode .modal-logout-icon i {
      color: #fca5a5;
    }

    .dark-mode .modal-logout-title {
      color: #f3f4f6;
    }

    .dark-mode .modal-logout-text {
      color: #9ca3af;
    }

    .dark-mode .modal-logout-btn-cancel {
      background: #374151;
      color: #d1d5db;
    }

    .dark-mode .modal-logout-btn-cancel:hover {
      background: #4b5563;
    }

    </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <h1><i class="bi bi-geo-alt"></i> Ponto Mobile</h1>
      <div class="header-buttons" style="display: flex; gap: 15px; align-items: center;">
        <button class="btn btn-link text-white p-0" id="btnDarkMode" onclick="toggleDarkMode()" title="Modo Noturno">
          <i class="bi bi-moon-stars fs-5" id="darkModeIcon"></i>
        </button>
        <button class="btn btn-link text-white p-0" id="btnRefresh" onclick="location.reload()" title="Atualizar">
          <i class="bi bi-arrow-clockwise fs-5"></i>
        </button>
        <button class="btn btn-link text-white p-0" id="btnLogout" style="display:none;">
          <i class="bi bi-box-arrow-right fs-5"></i>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Offline Section -->
      <div id="offlineSection" class="offline-container">
        <div class="offline-card">
          <div class="offline-icon"><i class="bi bi-wifi-off"></i></div>
          <div class="offline-status"><i class="bi bi-exclamation-circle"></i><span>Modo Offline</span></div>
          <div class="offline-user" id="offlineUserName">Carregando...</div>
          <div class="offline-time" id="offlineTime">--:--</div>
          <div class="offline-date" id="offlineDate">--</div>
          <button class="btn-offline-ponto" id="btnOfflinePonto" onclick="registrarPontoOffline()">
            <i class="bi bi-hand-index-thumb"></i>
            <span id="offlineTipoLabel">ENTRADA</span>
          </button>
          <div class="offline-success" id="offlineSuccess">
            <i class="bi bi-check-circle me-2"></i>
            <span>Ponto registrado! Sera sincronizado quando houver conexao.</span>
          </div>
          <div class="offline-pending" id="offlinePending" style="display:none;">
            <i class="bi bi-clock-history me-2"></i>
            <span id="offlinePendingCount">0</span> registro(s) pendente(s)
          </div>
        </div>
      </div>

      <!-- Login Section -->
      <div id="loginSection" class="login-container">
        <div class="login-card">
          <div class="login-logo">
            <i class="bi bi-person-badge"></i>
          </div>
          <h4 class="text-center mb-4">Entrar</h4>

          <!-- Botao de biometria (visivel apenas se disponivel) -->
          <div id="biometricLoginSection" class="mb-4 text-center" style="display: none;">
            <button type="button" class="btn btn-outline-primary btn-lg w-100" id="btnBiometricLogin" onclick="loginComBiometria()">
              <i class="bi bi-fingerprint me-2" style="font-size: 1.5rem;"></i>
              <span>Entrar com Digital</span>
            </button>
            <div class="text-muted small mt-2">ou use CPF e senha abaixo</div>
            <hr class="my-3">
          </div>

          <form id="formLogin">
            <div class="mb-3">
              <input type="text" class="form-control" id="loginCpf" placeholder="CPF" inputmode="numeric" maxlength="14" required>
            </div>
            <div class="mb-3">
              <input type="text" class="form-control" id="loginMatricula" placeholder="Matrcula" required>
            </div>
            <div class="mb-3">
              <input type="password" class="form-control" id="loginSenha" placeholder="Senha" required>
              <small class="text-muted">Primeiro acesso: ltimos 4 dgitos do CPF</small>
            </div>
            <div class="mb-3 d-flex align-items-center">
              <input type="checkbox" id="rememberMe" class="form-check-input me-2" style="width: 18px; height: 18px;">
              <label for="rememberMe" class="form-check-label small" style="color: #94a3b8;">Lembrar meus dados</label>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="btnLogin">
              <i class="bi bi-box-arrow-in-right me-2"></i>Entrar
            </button>
            <div class="text-center mt-3 small text-muted" id="loginMsg"></div>
          </form>
        </div>
      </div>

      <!-- App Section (after login) -->
      <div id="appSection" class="hidden">
        <!-- Page: Inicio -->
        <div id="pageInicio" class="page-view active">
          <!-- Alerta Feriado/Facultativo -->
          <div id="alertaBanner" class="alert-banner hidden"></div>

          <!-- User Info -->
          <div class="user-info">
            <div class="name" id="userName">Carregando...</div>
            <div class="role" id="userRole">Funcionario</div>
          </div>

          <!-- Status Cards -->
          <div class="status-grid">
            <div class="status-card highlight">
              <div class="label">Horas Hoje</div>
              <div class="value" id="horasHoje">--:--</div>
            </div>
            <div class="status-card">
              <div class="label">Banco de Horas</div>
              <div class="value" id="bancoHoras">--:--</div>
            </div>
          </div>

          <!-- Big Register Button -->
          <button class="btn-registrar" id="btnRegistrar" onclick="abrirCaptura()">
            <i class="bi bi-camera"></i>
            <span>REGISTRAR PONTO</span>
          </button>

          <!-- Botao Marcar Presenca -->
          <button class="btn-presenca" id="btnPresenca" onclick="abrirCapturaPresenca()">
            <i class="bi bi-shield-check"></i>
            <span>MARCAR PRESENCA</span>
            <span class="timer" id="presencaTimer">Proxima: --:--</span>
            <span class="status-text" id="presencaStatus"></span>
          </button>

          <!-- Boto Iniciar Visita na Home -->
          <button id="btnIniciarVisitaHome" onclick="abrirAtendimento()" style="display:none;width:100%;background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;border-radius:12px;padding:16px;margin-bottom:16px;color:white;font-weight:600;font-size:16px;">
            <i class="bi bi-geo-alt me-2"></i> INICIAR VISITA
          </button>
          
          <!-- Card Visita em Andamento na Home -->
          <div id="visitaEmAndamentoHome" style="display:none;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-radius:12px;padding:16px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div>
                <div style="font-size:12px;color:rgba(255,255,255,0.8);">Visita em andamento</div>
                <div style="font-size:24px;font-weight:700;color:white;" id="visitaTimerHome">00:00:00</div>
              </div>
              <button onclick="abrirAtendimento()" style="background:white;color:#6366f1;border:none;border-radius:10px;padding:10px 16px;font-weight:600;font-size:14px;">
                Finalizar
              </button>
            </div>
          </div>

          <!-- Card de Metas de Visitas -->
          <div id="metasVisitasCard" style="background:#1e293b;border-radius:12px;padding:12px;margin-bottom:16px;display:none;">
            <div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;align-items:center;gap:6px;">
              <i class="bi bi-graph-up-arrow" style="color:#10b981;"></i> Metas de Visitas
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
              <div style="background:#1e3a5f;border-radius:10px;padding:10px 6px;text-align:center;">
                <div style="width:28px;height:28px;border-radius:50%;background:rgba(59,130,246,0.3);color:#3b82f6;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;font-size:12px;"><i class="bi bi-calendar-day"></i></div>
                <div style="margin-bottom:2px;"><span id="metaHojeAtual" style="font-size:18px;font-weight:700;color:#e2e8f0;">0</span><span style="font-size:10px;color:#64748b;">/<span id="metaHojeTotal">0</span></span></div>
                <div style="font-size:9px;color:#64748b;text-transform:uppercase;margin-bottom:4px;">Hoje</div>
                <div style="height:3px;background:#334155;border-radius:2px;overflow:hidden;"><div id="metaHojeBar" style="height:100%;background:#3b82f6;border-radius:2px;width:0%;transition:width 0.3s;"></div></div>
                <div id="metaHojePercent" style="font-size:9px;color:#64748b;margin-top:2px;">0%</div>
              </div>
              <div style="background:#1a3d2e;border-radius:10px;padding:10px 6px;text-align:center;">
                <div style="width:28px;height:28px;border-radius:50%;background:rgba(16,185,129,0.3);color:#10b981;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;font-size:12px;"><i class="bi bi-calendar-week"></i></div>
                <div style="margin-bottom:2px;"><span id="metaSemanaAtual" style="font-size:18px;font-weight:700;color:#e2e8f0;">0</span><span style="font-size:10px;color:#64748b;">/<span id="metaSemanaTotal">0</span></span></div>
                <div style="font-size:9px;color:#64748b;text-transform:uppercase;margin-bottom:4px;">Semana</div>
                <div style="height:3px;background:#334155;border-radius:2px;overflow:hidden;"><div id="metaSemanaBar" style="height:100%;background:#10b981;border-radius:2px;width:0%;transition:width 0.3s;"></div></div>
                <div id="metaSemanaPercent" style="font-size:9px;color:#64748b;margin-top:2px;">0%</div>
              </div>
              <div style="background:#2d1f4e;border-radius:10px;padding:10px 6px;text-align:center;">
                <div style="width:28px;height:28px;border-radius:50%;background:rgba(139,92,246,0.3);color:#8b5cf6;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;font-size:12px;"><i class="bi bi-calendar-month"></i></div>
                <div style="margin-bottom:2px;"><span id="metaMesAtual" style="font-size:18px;font-weight:700;color:#e2e8f0;">0</span><span style="font-size:10px;color:#64748b;">/<span id="metaMesTotal">0</span></span></div>
                <div style="font-size:9px;color:#64748b;text-transform:uppercase;margin-bottom:4px;">Ms</div>
                <div style="height:3px;background:#334155;border-radius:2px;overflow:hidden;"><div id="metaMesBar" style="height:100%;background:#8b5cf6;border-radius:2px;width:0%;transition:width 0.3s;"></div></div>
                <div id="metaMesPercent" style="font-size:9px;color:#64748b;margin-top:2px;">0%</div>
              </div>
            </div>
          </div>

          <!-- Link Permissao Camera -->
          <div class="camera-permission-link">
            <a href="#" onclick="verificarPermissaoCamera(); return false;">
              <i class="bi bi-camera-video"></i> Problemas com a camera? Clique aqui
            </a>
          </div>

          <!-- Today's Records -->
          <div class="registros-section">
            <h3 class="section-title"><i class="bi bi-clock-history"></i> Registros de Hoje</h3>
            <div id="registrosList">
              <div class="text-center text-muted py-3">Nenhum registro hoje</div>
            </div>
          </div>

          <!-- Map Section -->
          <div class="map-section">
            <h3 class="section-title"><i class="bi bi-map"></i> Localizacao dos Registros</h3>
            <div id="mapContainer"></div>
          </div>
        </div>

        <!-- Page: Jornada -->
        <div id="pageJornada" class="page-view">
          <h3 class="section-title"><i class="bi bi-calendar-week"></i> Minha Jornada de Trabalho</h3>
          <div id="jornadaContent" class="jornada-card">
            <div class="loading-spinner">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
          </div>
        </div>

        <!-- Page: Espelho -->
        <div id="pageEspelho" class="page-view">
          <div class="espelho-header">
            <h3 class="section-title mb-0"><i class="bi bi-table"></i> Espelho de Ponto</h3>
            <div class="espelho-nav">
              <button onclick="navegarEspelho(-1)"><i class="bi bi-chevron-left"></i></button>
              <span id="espelhoMesAno">Dez/2025</span>
              <button onclick="navegarEspelho(1)"><i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
          <div id="espelhoContent" style="overflow-x: auto;">
            <div class="loading-spinner">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
          </div>
        </div>

        <!-- Page: Visitas -->
        <div id="pageVisitas" class="page-view">
          <h3 class="section-title"><i class="bi bi-geo-alt"></i> Minhas Visitas</h3>
          
          <!-- Card Visita em Andamento -->
          <div id="visitaEmAndamentoCard" style="display:none;background:linear-gradient(135deg,#059669,#10b981);border-radius:12px;padding:16px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div>
                <div style="font-size:12px;color:rgba(255,255,255,0.8);">Visita em andamento</div>
                <div style="font-size:28px;font-weight:700;color:white;" id="visitaTimerDisplay">00:00:00</div>
              </div>
              <button onclick="abrirAtendimento()" style="background:white;color:#059669;border:none;border-radius:10px;padding:12px 20px;font-weight:600;">
                <i class="bi bi-check-circle me-1"></i> Finalizar
              </button>
            </div>
          </div>
          
          <!-- Resumo -->
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;">
            <div style="background:#1e293b;border-radius:12px;padding:12px 8px;text-align:center;">
              <div style="width:32px;height:32px;border-radius:50%;background:rgba(59,130,246,0.2);color:#3b82f6;display:flex;align-items:center;justify-content:center;margin:0 auto 6px;font-size:14px;"><i class="bi bi-calendar-day"></i></div>
              <div style="font-size:22px;font-weight:700;color:#e2e8f0;"><span id="visitaHojePg">0</span><span style="font-size:12px;color:#64748b;">/<span id="visitaMetaDiaPg">0</span></span></div>
              <div style="font-size:10px;color:#64748b;text-transform:uppercase;margin:4px 0;">Hoje</div>
              <div style="height:4px;background:#334155;border-radius:2px;overflow:hidden;"><div id="visitaBarDiaPg" style="height:100%;background:#3b82f6;width:0%;"></div></div>
              <div id="visitaPercentDiaPg" style="font-size:10px;color:#64748b;margin-top:4px;">0%</div>
            </div>
            <div style="background:#1e293b;border-radius:12px;padding:12px 8px;text-align:center;">
              <div style="width:32px;height:32px;border-radius:50%;background:rgba(16,185,129,0.2);color:#10b981;display:flex;align-items:center;justify-content:center;margin:0 auto 6px;font-size:14px;"><i class="bi bi-calendar-week"></i></div>
              <div style="font-size:22px;font-weight:700;color:#e2e8f0;"><span id="visitaSemanaPg">0</span><span style="font-size:12px;color:#64748b;">/<span id="visitaMetaSemanaPg">0</span></span></div>
              <div style="font-size:10px;color:#64748b;text-transform:uppercase;margin:4px 0;">Semana</div>
              <div style="height:4px;background:#334155;border-radius:2px;overflow:hidden;"><div id="visitaBarSemanaPg" style="height:100%;background:#10b981;width:0%;"></div></div>
              <div id="visitaPercentSemanaPg" style="font-size:10px;color:#64748b;margin-top:4px;">0%</div>
            </div>
            <div style="background:#1e293b;border-radius:12px;padding:12px 8px;text-align:center;">
              <div style="width:32px;height:32px;border-radius:50%;background:rgba(139,92,246,0.2);color:#8b5cf6;display:flex;align-items:center;justify-content:center;margin:0 auto 6px;font-size:14px;"><i class="bi bi-calendar-month"></i></div>
              <div style="font-size:22px;font-weight:700;color:#e2e8f0;"><span id="visitaMesPg">0</span><span style="font-size:12px;color:#64748b;">/<span id="visitaMetaMesPg">0</span></span></div>
              <div style="font-size:10px;color:#64748b;text-transform:uppercase;margin:4px 0;">Ms</div>
              <div style="height:4px;background:#334155;border-radius:2px;overflow:hidden;"><div id="visitaBarMesPg" style="height:100%;background:#8b5cf6;width:0%;"></div></div>
              <div id="visitaPercentMesPg" style="font-size:10px;color:#64748b;margin-top:4px;">0%</div>
            </div>
          </div>
          
          <!-- Mapa de Visitas -->
          <div style="background:#1e293b;border-radius:12px;overflow:hidden;margin-bottom:16px;">
            <div style="padding:12px 16px;border-bottom:1px solid #334155;">
              <span style="font-size:14px;color:#e2e8f0;"><i class="bi bi-map me-2"></i>Localizao das Visitas</span>
            </div>
            <div id="mapaVisitasContainer" style="height:200px;background:#0f172a;"></div>
          </div>
          
          <!-- Lista -->
          <div style="background:#1e293b;border-radius:12px;overflow:hidden;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #334155;">
              <span style="font-size:14px;color:#e2e8f0;"><i class="bi bi-list-ul me-2"></i>Histrico</span>
              <select id="filtroVisitasPeriodo" onchange="carregarVisitas()" style="background:#0f172a;border:1px solid #334155;color:#e2e8f0;border-radius:6px;padding:4px 8px;font-size:12px;">
                <option value="hoje">Hoje</option>
                <option value="semana" selected>Esta semana</option>
                <option value="mes">Este ms</option>
              </select>
            </div>
            <div id="listaVisitas">
              <div style="padding:40px 20px;text-align:center;color:#64748b;">
                <i class="bi bi-geo-alt" style="font-size:40px;opacity:0.5;display:block;margin-bottom:8px;"></i>
                <p style="margin:0;">Nenhuma visita registrada</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Page: Perfil -->
        <div id="pagePerfil" class="page-view">
          <div id="perfilContent" class="perfil-card">
            <div class="loading-spinner">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
          </div>
        </div>

        <!-- Page: Mensagens -->
        <div id="pageMensagens" class="page-view">
          <div class="mensagens-page-header">
            <div class="icon-circle">
              <i class="bi bi-chat-dots"></i>
            </div>
            <div class="header-text">
              <h3>Mensagens</h3>
              <p id="mensagensCount">Carregando...</p>
            </div>
          </div>
          <div id="mensagensPageContent" class="mensagens-list">
            <div class="loading-spinner">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
          </div>
        </div>

        <!-- Page: Presencas/Rondas -->
        <div id="pagePresencas" class="page-view">
          <div class="presencas-page-header">
            <div class="icon-circle presenca">
              <i class="bi bi-shield-check"></i>
            </div>
            <div class="header-text">
              <h3>Rondas/Presencas</h3>
              <p id="presencasCount">Carregando...</p>
            </div>
          </div>
          <div id="presencasMapContainer" class="presencas-map"></div>
          <div id="presencasListContent" class="presencas-list">
            <div class="loading-spinner">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav" style="display:none;">
      <button class="nav-item active" data-page="pageInicio">
        <i class="bi bi-house-door"></i>
        Inicio
      </button>
      <button class="nav-item" data-page="pageJornada">
        <i class="bi bi-calendar-week"></i>
        Jornada
      </button>
      <button class="nav-item" data-page="pageEspelho">
        <i class="bi bi-table"></i>
        Espelho
      </button>
      <button class="nav-item" data-page="pageMensagens" id="navMensagens">
        <i class="bi bi-chat-dots"></i>
        <span class="badge" id="msgBadge" style="display:none;">0</span>
        Msgs
      </button>
      <button class="nav-item" data-page="pagePresencas" id="navPresencas" style="display:none;">
        <i class="bi bi-shield-check"></i>
        Rondas
      </button>
      <button class="nav-item" data-page="pageVisitas" id="navVisitas" style="display:none;">
        <i class="bi bi-geo-alt"></i>
        Visitas
      </button>
      <button class="nav-item" data-page="pagePerfil">
        <i class="bi bi-person"></i>
        Perfil
      </button>
    </div>

    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
      <i class="bi bi-download"></i>
      <div class="install-text">
        <div class="install-title">Instalar App</div>
        <div class="install-desc">Acesse mais rapido</div>
      </div>
      <button class="btn-install" id="btnInstall">Instalar</button>
      <button class="btn-close-install" onclick="fecharInstallBanner()"><i class="bi bi-x-lg"></i></button>
    </div>

    <!-- Modal de Detalhe da Mensagem -->
    <div class="msg-detail-modal" id="msgDetailModal" onclick="fecharMsgDetail(event)">
      <div class="msg-detail-content" onclick="event.stopPropagation()">
        <div class="msg-detail-header">
          <button class="close-btn" onclick="fecharMsgDetail()">
            <i class="bi bi-x"></i>
          </button>
          <div class="msg-type-badge" id="msgDetailType">
            <i class="bi bi-info-circle"></i>
            <span>Informacao</span>
          </div>
          <h3 id="msgDetailTitle">Titulo da mensagem</h3>
          <div class="msg-date" id="msgDetailDate">28 dez 2024, 15:30</div>
        </div>
        <div class="msg-detail-body">
          <div class="msg-text" id="msgDetailText">
            Conteudo da mensagem aqui...
          </div>
          <div class="msg-categoria-badge" id="msgDetailCategoria">Sistema</div>
        </div>
        <div class="msg-detail-footer">
          <button class="btn-delete" onclick="excluirMensagemAtual()">
            <i class="bi bi-trash"></i>
            Excluir
          </button>
          <button class="btn-close-detail" onclick="fecharMsgDetail()">
            <i class="bi bi-check"></i>
            Fechar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmacao -->
    <div class="confirm-modal" id="confirmModal">
      <div class="confirm-content">
        <div class="confirm-icon">
          <i class="bi bi-trash"></i>
        </div>
        <div class="confirm-title">Excluir mensagem?</div>
        <div class="confirm-text">Esta acao nao pode ser desfeita.</div>
        <div class="confirm-buttons">
          <button class="btn-cancel" onclick="fecharConfirmModal()">Cancelar</button>
          <button class="btn-confirm-delete" onclick="confirmarExclusao()">Excluir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Captura -->
  <div class="modal-capture" id="modalCaptura">
    <div class="modal-capture-header">
      <h2><i class="bi bi-camera me-2"></i>Registrar Ponto</h2>
      <button class="btn btn-link text-white p-0" onclick="fecharCaptura()">
        <i class="bi bi-x-lg fs-4"></i>
      </button>
    </div>
    <div class="modal-capture-content">
      <div class="camera-container">
        <video id="videoCaptura" autoplay playsinline></video>
        <canvas id="canvasCaptura"></canvas>
        <div class="camera-overlay"></div>
      </div>
      <div class="gps-status" id="gpsStatus">
        <i class="bi bi-geo-alt"></i>
        <span>Obtendo localizacao...</span>
      </div>
    </div>
    <div class="modal-capture-footer">
      <button class="btn-capture secondary" onclick="fecharCaptura()">
        <i class="bi bi-x-lg"></i> Cancelar
      </button>
      <button class="btn-capture primary" id="btnTirarFoto" onclick="tirarFoto()" disabled>
        <i class="bi bi-camera"></i> Tirar Foto
      </button>
    </div>
  </div>

  <!-- Success Overlay -->
  <div class="success-overlay" id="successOverlay">
    <i class="bi bi-check-circle"></i>
    <div class="message" id="successMessage">Registro realizado!</div>
    <div class="submessage" id="successSubmessage">ENTRADA as 08:00</div>
  </div>

  <!-- Modal Permissao Camera -->
  <div class="permission-modal" id="permissionModal">
    <div class="permission-modal-content">
      <div class="permission-modal-header">
        <i class="bi bi-camera-video"></i>
        <h4>Permissao da Camera</h4>
      </div>
      <div class="permission-modal-body">
        <div class="permission-status" id="permissionStatus">
          <i class="bi bi-hourglass"></i>
          <span>Verificando...</span>
        </div>
        <div class="permission-instructions" id="permissionInstructions">
        </div>
      </div>
      <div class="permission-modal-footer">
        <button class="btn-permission-close" onclick="fecharPermissionModal()">Fechar</button>
        <button class="btn-permission-request" id="btnRequestPermission" onclick="solicitarPermissaoCamera()">
          <i class="bi bi-camera"></i> Solicitar Permissao
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Estado global
    let usuario = null;
    let ultimoRegistro = null;
    let gpsCoords = null;
    let videoStream = null;
    let map = null;
    let mapaVisitas = null;
    let markersVisitas = [];
    let markers = [];
    let deferredPrompt = null;
    let espelhoMes = new Date().getMonth() + 1;
    let espelhoAno = new Date().getFullYear();

    // =====================
    // FILA OFFLINE - Registros pendentes
    // =====================
    const OFFLINE_QUEUE_KEY = 'ponto_offline_queue';
    const OFFLINE_PRESENCA_KEY = 'presenca_offline_queue';
    const OFFLINE_ATENDIMENTO_KEY = 'atendimento_offline_queue';

    
    // Verifica se esta online (dispositivo E servidor)
    let servidorOnline = true;
    let ultimaVerificacao = 0;
    
    function estaOnline() {
      // Se dispositivo offline, retorna false
      if (!navigator.onLine) return false;
      // Retorna estado do servidor (atualizado periodicamente)
      return servidorOnline;
    }
    
    // Verifica se o servidor esta respondendo
    async function verificarServidor() {
      // Evita verificar muito frequentemente
      const agora = Date.now();
      if (agora - ultimaVerificacao < 10000) return servidorOnline; // 10 segundos
      ultimaVerificacao = agora;
      
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 5000); // 5s timeout
        
        const res = await fetch('/api/health', { 
          method: 'GET',
          signal: controller.signal,
          cache: 'no-store'
        });
        clearTimeout(timeout);
        
        servidorOnline = res.ok;
      } catch (e) {
        servidorOnline = false;
      }
      
      // Atualiza indicador visual
      atualizarIndicadorConexao();
      return servidorOnline;
    }
    
    // Atualiza indicador de conexao na interface
    function atualizarIndicadorConexao() {
      const indicator = document.getElementById('offlineIndicator');
      if (indicator) {
        if (!navigator.onLine) {
          indicator.classList.add('show');
          indicator.innerHTML = '<i class="bi bi-wifi-off"></i> Sem Internet';
        } else if (!servidorOnline) {
          indicator.classList.add('show');
          indicator.innerHTML = '<i class="bi bi-cloud-slash"></i> Servidor Indisponvel';
        } else {
          indicator.classList.remove('show');
        }
      }
    }
    
    // Verifica periodicamente
    setInterval(verificarServidor, 30000); // A cada 30 segundos
    
    // Verifica ao mudar estado de conexao
    window.addEventListener('online', () => {
      verificarServidor();
    });
    window.addEventListener('offline', () => {
      servidorOnline = false;
      atualizarIndicadorConexao();
    });

    // Detecta se  erro de rede/servidor
    function isNetworkError(e) {
      return !navigator.onLine || 
        e.name === 'AbortError' ||
        e.name === 'TypeError' ||
        (e.message && (
          e.message.includes('NetworkError') || 
          e.message.includes('fetch') ||
          e.message.includes('Failed to fetch') ||
          e.message.includes('Network request failed') ||
          e.message.includes('ERR_CONNECTION') ||
          e.message.includes('ECONNREFUSED') ||
          e.message.includes('Load failed')
        ));
    }
    
    // Marca servidor como offline e salva registro
    function handleNetworkError(key, payload, successCallback) {
      servidorOnline = false;
      atualizarIndicadorConexao();
      
      const salvo = salvarFilaOffline(key, payload);
      if (salvo && successCallback) {
        successCallback();
        return true;
      }
      return false;
    }



    // Salva registro na fila offline
    function salvarFilaOffline(key, dados) {
      try {
        const fila = JSON.parse(localStorage.getItem(key) || '[]');
        dados.timestamp = new Date().toISOString();
        dados.id_local = Date.now();
        fila.push(dados);
        localStorage.setItem(key, JSON.stringify(fila));
        console.log('[Offline] Salvo na fila:', key, dados.id_local);
        return true;
      } catch (e) {
        console.error('[Offline] Erro ao salvar:', e);
        return false;
      }
    }

    // Obtem fila offline
    function obterFilaOffline(key) {
      try {
        return JSON.parse(localStorage.getItem(key) || '[]');
      } catch (e) {
        return [];
      }
    }

    // Remove item da fila
    function removerDaFilaOffline(key, idLocal) {
      try {
        let fila = JSON.parse(localStorage.getItem(key) || '[]');
        fila = fila.filter(item => item.id_local !== idLocal);
        localStorage.setItem(key, JSON.stringify(fila));
      } catch (e) {
        console.error('[Offline] Erro ao remover:', e);
      }
    }

    // Limpa fila
    function limparFilaOffline(key) {
      localStorage.removeItem(key);
    }

    // Sincroniza registros pendentes quando voltar online
    async function sincronizarFilaOffline() {
      if (!estaOnline()) return;

      // Sincroniza registros de ponto
      const filaPonto = obterFilaOffline(OFFLINE_QUEUE_KEY);
      for (const registro of filaPonto) {
        try {
          const res = await fetch('/api/app/registrar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              foto_base64: registro.foto_base64,
              latitude: registro.latitude,
              longitude: registro.longitude,
              precisao_gps: registro.precisao_gps,
              data_hora_offline: registro.timestamp,
              offline: true
            })
          });

          if (res.ok) {
            removerDaFilaOffline(OFFLINE_QUEUE_KEY, registro.id_local);
            console.log('[Offline] Ponto sincronizado:', registro.id_local);
          }
        } catch (e) {
          console.error('[Offline] Erro ao sincronizar ponto:', e);
        }
      }

      // Sincroniza presencas
      const filaPresenca = obterFilaOffline(OFFLINE_PRESENCA_KEY);
      for (const presenca of filaPresenca) {
        try {
          const res = await fetch('/api/app/marcar-presenca', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              foto_base64: presenca.foto_base64,
              latitude: presenca.latitude,
              longitude: presenca.longitude,
              precisao_gps: presenca.precisao_gps,
              data_hora_offline: presenca.timestamp,
              offline: true
            })
          });

          if (res.ok) {
            removerDaFilaOffline(OFFLINE_PRESENCA_KEY, presenca.id_local);
            console.log('[Offline] Presenca sincronizada:', presenca.id_local);
          }
        } catch (e) {
          console.error('[Offline] Erro ao sincronizar presenca:', e);
        }
      }

      // Sincroniza atendimentos
      const filaAtendimento = obterFilaOffline(OFFLINE_ATENDIMENTO_KEY);
      for (const atend of filaAtendimento) {
        try {
          let endpoint, body;
          if (atend.tipo === 'inicio') {
            endpoint = '/api/app/atendimentos/iniciar';
            body = {
              foto_inicio: atend.foto_inicio,
              latitude_inicio: atend.latitude_inicio,
              longitude_inicio: atend.longitude_inicio,
              precisao_gps_inicio: atend.precisao_gps_inicio,
              data_hora_offline: atend.timestamp,
              offline: true
            };
          } else {
            endpoint = `/api/app/atendimentos/${atend.atendimento_id}/finalizar`;
            body = {
              foto_fim: atend.foto_fim,
              latitude_fim: atend.latitude_fim,
              longitude_fim: atend.longitude_fim,
              precisao_gps_fim: atend.precisao_gps_fim,
              data_hora_offline: atend.timestamp,
              offline: true
            };
          }

          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          if (res.ok) {
            removerDaFilaOffline(OFFLINE_ATENDIMENTO_KEY, atend.id_local);
            console.log('[Offline] Atendimento sincronizado:', atend.id_local);
          }
        } catch (e) {
          console.error('[Offline] Erro ao sincronizar atendimento:', e);
        }
      }

      // Atualiza interface se sincronizou algo
      const totalSincronizado = filaPonto.length + filaPresenca.length + filaAtendimento.length;
      if (totalSincronizado > 0) {
        mostrarMensagemSincronizacao(totalSincronizado);
        carregarStatus();
        carregarRegistros();
        verificarAtendimentoEmAndamento();
      }
    }

    // Mostra mensagem de sincronizacao
    function mostrarMensagemSincronizacao(quantidade) {
      const toast = document.createElement('div');
      toast.className = 'toast-sync';
      toast.innerHTML = `<i class="bi bi-cloud-check"></i> ${quantidade} registro(s) sincronizado(s)`;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Mostra indicador offline
    function mostrarIndicadorOffline() {
      let indicator = document.getElementById('offlineIndicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'offlineIndicator';
        indicator.className = 'offline-indicator';
        indicator.innerHTML = '<i class="bi bi-wifi-off"></i> Offline';
        document.body.appendChild(indicator);
      }
      indicator.classList.add('show');
    }

    function esconderIndicadorOffline() {
      const indicator = document.getElementById('offlineIndicator');
      if (indicator) {
        indicator.classList.remove('show');
      }
    }

    // Conta registros pendentes
    function contarPendentes() {
      const ponto = obterFilaOffline(OFFLINE_QUEUE_KEY).length;
      const presenca = obterFilaOffline(OFFLINE_PRESENCA_KEY).length;
      const atendimento = obterFilaOffline(OFFLINE_ATENDIMENTO_KEY).length;
      return ponto + presenca + atendimento;
    }

    // Atualiza badge de pendentes
    function atualizarBadgePendentes() {
      const total = contarPendentes();
      let badge = document.getElementById('pendingBadge');

      if (total > 0) {
        if (!badge) {
          badge = document.createElement('span');
          badge.id = 'pendingBadge';
          badge.className = 'pending-badge';
          document.querySelector('.header-top')?.appendChild(badge);
        }
        badge.textContent = total;
        badge.style.display = 'flex';
      } else if (badge) {
        badge.style.display = 'none';
      }
    }

    // Listeners de conexao
    window.addEventListener('online', () => {
      console.log('[Offline] Voltou online!');
      esconderIndicadorOffline();
      sincronizarFilaOffline();
    });

    window.addEventListener('offline', () => {
      console.log('[Offline] Ficou offline!');
      mostrarIndicadorOffline();
    });

    // Verifica estado inicial
    if (!estaOnline()) {
      mostrarIndicadorOffline();
    }

    // Verifica servidor e tenta sincronizar ao carregar
    verificarServidor().then(() => {
      setTimeout(sincronizarFilaOffline, 2000);
    });

    // =====================
    // ATENDIMENTO (Agentes de Saude)
    // =====================
    
    // Timer para visita em andamento
    let timerVisitaInterval = null;
    
    function atualizarTimerVisita() {
      if (timerVisitaInterval) clearInterval(timerVisitaInterval);
      if (!atendimentoEmAndamento) return;
      
      // Garante que temos uma data vlida (API pode retornar 'inicio' ou 'data_hora_inicio')
      const dataInicio = atendimentoEmAndamento.inicio || atendimentoEmAndamento.data_hora_inicio;
      if (!dataInicio) {
        console.log('[Timer] Sem data de inicio');
        return;
      }
      
      const inicio = new Date(dataInicio);
      if (isNaN(inicio.getTime())) {
        console.log('[Timer] Data invalida:', dataInicio);
        return;
      }
      
      console.log('[Timer] Iniciando timer, inicio:', inicio);
      
      function update() {
        const agora = new Date();
        const diff = agora - inicio;
        if (diff < 0 || isNaN(diff)) {
          console.log('[Timer] Diff invalido:', diff);
          return;
        }
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        const timer = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
        const el = document.getElementById('visitaTimerDisplay');
        const elHome = document.getElementById('visitaTimerHome');
        if (el) el.textContent = timer;
        if (elHome) elHome.textContent = timer;
      }
      
      update();
      timerVisitaInterval = setInterval(update, 1000);
    }

    
    // Atualizar botes de visita na home e pgina
    function atualizarBotoesVisita() {
      const btnHome = document.getElementById('btnIniciarVisitaHome');
      const cardHome = document.getElementById('visitaEmAndamentoHome');
      const cardPg = document.getElementById('visitaEmAndamentoCard');
      const btnPg = document.getElementById('btnIniciarVisitaPg');
      
      if (atendimentoEmAndamento) {
        // Visita em andamento - mostrar cards de andamento
        if (btnHome) btnHome.style.display = 'none';
        if (cardHome) cardHome.style.display = 'block';
        if (btnPg) btnPg.style.display = 'none';
        if (cardPg) cardPg.style.display = 'flex';
        atualizarTimerVisita();
      } else if (atendimentoConfig?.ativo) {
        // Sem visita, mas config ativa - mostrar botes
        if (btnHome) btnHome.style.display = 'block';
        if (cardHome) cardHome.style.display = 'none';
        if (btnPg) btnPg.style.display = 'flex';
        if (cardPg) cardPg.style.display = 'none';
      } else {
        // Sem config - esconder tudo
        if (btnHome) btnHome.style.display = 'none';
        if (cardHome) cardHome.style.display = 'none';
      }
    }

    
    // Confirmacao customizada
    function showConfirm(message, onConfirm, onCancel) {
      const oldModal = document.getElementById('confirmModal');
      if (oldModal) oldModal.remove();
      
      const modal = document.createElement('div');
      modal.id = 'confirmModal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;';
      
      modal.innerHTML = '<div style="background:#1e293b;border-radius:16px;padding:24px;margin:20px;max-width:320px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.5);"><div style="text-align:center;margin-bottom:20px;"><i class="bi bi-question-circle" style="font-size:48px;color:#6366f1;"></i></div><p style="color:#e2e8f0;text-align:center;font-size:16px;margin-bottom:24px;">' + message + '</p><div style="display:flex;gap:12px;"><button id="confirmCancel" style="flex:1;padding:12px;border:1px solid #334155;background:transparent;color:#94a3b8;border-radius:10px;font-weight:600;">Cancelar</button><button id="confirmOk" style="flex:1;padding:12px;border:none;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;border-radius:10px;font-weight:600;">Confirmar</button></div></div>';
      
      document.body.appendChild(modal);
      
      document.getElementById('confirmCancel').onclick = function() {
        modal.remove();
        if (onCancel) onCancel();
      };
      
      document.getElementById('confirmOk').onclick = function() {
        modal.remove();
        if (onConfirm) onConfirm();
      };
      
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.remove();
          if (onCancel) onCancel();
        }
      };
    }

    
    // Buscar endereo via geocoding reverso (Nominatim/OpenStreetMap)
    async function buscarEndereco(lat, lng) {
      try {
        const res = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&addressdetails=1', {
          headers: { 'Accept-Language': 'pt-BR' }
        });
        if (!res.ok) return null;
        const data = await res.json();
        if (!data.address) return null;
        
        const a = data.address;
        return {
          endereco: a.road || a.pedestrian || a.street || a.hamlet || '',
          numero: a.house_number || '',
          bairro: a.suburb || a.neighbourhood || a.district || '',
          cidade: a.city || a.town || a.village || a.municipality || '',
          cep: a.postcode || '',
          display: data.display_name || ''
        };
      } catch (e) {
        console.log('[Geocoding] Erro:', e);
        return null;
      }
    }

    let temPontoHoje = false;
    let atendimentoConfig = null;

    // Toast notification bonito
    function showToast(message, type = 'success') {
      // Remove toast anterior se existir
      const oldToast = document.getElementById('customToast');
      if (oldToast) oldToast.remove();
      
      const colors = {
        success: 'linear-gradient(135deg, #10b981, #059669)',
        error: 'linear-gradient(135deg, #ef4444, #dc2626)',
        info: 'linear-gradient(135deg, #3b82f6, #2563eb)',
        warning: 'linear-gradient(135deg, #f59e0b, #d97706)'
      };
      
      const icons = {
        success: 'bi-check-circle-fill',
        error: 'bi-x-circle-fill',
        info: 'bi-info-circle-fill',
        warning: 'bi-exclamation-triangle-fill'
      };
      
      const toast = document.createElement('div');
      toast.id = 'customToast';
      toast.innerHTML = '<i class="bi ' + icons[type] + '"></i> ' + message;
      toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:' + colors[type] + ';color:white;padding:14px 24px;border-radius:12px;font-weight:600;font-size:14px;z-index:99999;display:flex;align-items:center;gap:10px;box-shadow:0 10px 40px rgba(0,0,0,0.3);animation:slideDown 0.3s ease;';
      
      // Adicionar animao
      if (!document.getElementById('toastStyle')) {
        const style = document.createElement('style');
        style.id = 'toastStyle';
        style.textContent = '@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}@keyframes slideUp{from{opacity:1;transform:translateX(-50%) translateY(0);}to{opacity:0;transform:translateX(-50%) translateY(-20px);}}';
        document.head.appendChild(style);
      }
      
      document.body.appendChild(toast);
      
      // Remover aps 3 segundos
      setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }



    // Obter GPS
    async function obterGPS() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('GPS no suportado'));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            gpsCoords = {
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
              precisao: pos.coords.accuracy
            };
            resolve(gpsCoords);
          },
          (err) => {
            console.warn('Erro GPS:', err);
            resolve(null);
          },
          { enableHighAccuracy: true, timeout: 30000, maximumAge: 60000 }
        );
      });
    }


    let atendimentoEmAndamento = null;

    
    // Carregar metas de visitas do funcionrio
    async function carregarMetasVisitas() {
      try {
        console.log('[Metas] Carregando...');
        const res = await fetch('/api/app/atendimentos/resumo');
        console.log('[Metas] Response status:', res.status);
        if (!res.ok) {
          console.log('[Metas] Response not ok');
          return;
        }
        
        const data = await res.json();
        console.log('[Metas] Data recebida:', JSON.stringify(data));
        const card = document.getElementById('metasVisitasCard');
        console.log('[Metas] Card encontrado:', !!card);
        
        // S mostra se tiver metas configuradas
        const temMeta = data.hoje?.meta || data.semana?.meta || data.mes?.meta;
        console.log('[Metas] Tem meta?', temMeta, 'hoje.meta:', data.hoje?.meta);
        if (!temMeta) {
          console.log('[Metas] Sem metas, escondendo card');
          if (card) card.style.display = 'none';
          return;
        }
        
        card.style.display = 'block';
        
        // Atualizar valores
        document.getElementById('metaHojeAtual').textContent = data.hoje?.realizado || 0;
        document.getElementById('metaHojeTotal').textContent = data.hoje?.meta || 0;
        document.getElementById('metaSemanaAtual').textContent = data.semana?.realizado || 0;
        document.getElementById('metaSemanaTotal').textContent = data.semana?.meta || 0;
        document.getElementById('metaMesAtual').textContent = data.mes?.realizado || 0;
        document.getElementById('metaMesTotal').textContent = data.mes?.meta || 0;
        
        // Calcular percentuais
        const percentHoje = Math.min(100, data.hoje?.percentual || 0);
        const percentSemana = Math.min(100, data.semana?.percentual || 0);
        const percentMes = Math.min(100, data.mes?.percentual || 0);
        
        // Atualizar barras de progresso
        document.getElementById('metaHojeBar').style.width = percentHoje + '%';
        document.getElementById('metaSemanaBar').style.width = percentSemana + '%';
        document.getElementById('metaMesBar').style.width = percentMes + '%';
        
        // Atualizar percentuais
        const hojePercent = document.getElementById('metaHojePercent');
        const semanaPercent = document.getElementById('metaSemanaPercent');
        const mesPercent = document.getElementById('metaMesPercent');
        
        hojePercent.textContent = percentHoje + '%';
        semanaPercent.textContent = percentSemana + '%';
        mesPercent.textContent = percentMes + '%';
        
        // Marcar como batida se atingiu meta
        if (data.hoje?.realizado >= data.hoje?.meta && data.hoje?.meta > 0) {
          document.getElementById('metaHojeBar').classList.add('batida');
          hojePercent.classList.add('batida');
          hojePercent.innerHTML = '<i class="bi bi-check-circle"></i> Batida!';
        }
        if (data.semana?.realizado >= data.semana?.meta && data.semana?.meta > 0) {
          document.getElementById('metaSemanaBar').classList.add('batida');
          semanaPercent.classList.add('batida');
          semanaPercent.innerHTML = '<i class="bi bi-check-circle"></i> Batida!';
        }
        if (data.mes?.realizado >= data.mes?.meta && data.mes?.meta > 0) {
          document.getElementById('metaMesBar').classList.add('batida');
          mesPercent.classList.add('batida');
          mesPercent.innerHTML = '<i class="bi bi-check-circle"></i> Batida!';
        }
      } catch (e) {
        console.error('[Metas] Erro ao carregar:', e);
      }
    }

    // Carregar dados da pgina de visitas
    async function carregarPaginaVisitas() {
      try {
        // Carregar resumo
        const resResumo = await fetch('/api/app/atendimentos/resumo');
        if (resResumo.ok) {
          const data = await resResumo.json();
          
          // Atualizar valores
          document.getElementById('visitaHoje').textContent = data.hoje?.realizado || 0;
          document.getElementById('visitaMetaDia').textContent = data.hoje?.meta || 0;
          document.getElementById('visitaSemana').textContent = data.semana?.realizado || 0;
          document.getElementById('visitaMetaSemana').textContent = data.semana?.meta || 0;
          document.getElementById('visitaMes').textContent = data.mes?.realizado || 0;
          document.getElementById('visitaMetaMes').textContent = data.mes?.meta || 0;
          
          // Barras de progresso
          const percentDia = Math.min(100, data.hoje?.percentual || 0);
          const percentSemana = Math.min(100, data.semana?.percentual || 0);
          const percentMes = Math.min(100, data.mes?.percentual || 0);
          
          document.getElementById('visitaBarDia').style.width = percentDia + '%';
          document.getElementById('visitaBarSemana').style.width = percentSemana + '%';
          document.getElementById('visitaBarMes').style.width = percentMes + '%';
          
          document.getElementById('visitaPercentDia').textContent = percentDia + '%';
          document.getElementById('visitaPercentSemana').textContent = percentSemana + '%';
          document.getElementById('visitaPercentMes').textContent = percentMes + '%';
          
          // Marcar metas batidas
          if (data.hoje?.realizado >= data.hoje?.meta && data.hoje?.meta > 0) {
            document.getElementById('visitaPercentDia').classList.add('batida');
            document.getElementById('visitaPercentDia').innerHTML = '<i class="bi bi-check-circle"></i> Batida!';
          }
          if (data.semana?.realizado >= data.semana?.meta && data.semana?.meta > 0) {
            document.getElementById('visitaPercentSemana').classList.add('batida');
            document.getElementById('visitaPercentSemana').innerHTML = '<i class="bi bi-check-circle"></i> Batida!';
          }
          if (data.mes?.realizado >= data.mes?.meta && data.mes?.meta > 0) {
            document.getElementById('visitaPercentMes').classList.add('batida');
            document.getElementById('visitaPercentMes').innerHTML = '<i class="bi bi-check-circle"></i> Batida!';
          }
        }
        
        // Carregar lista de visitas
        await carregarVisitas();
      } catch (e) {
        console.error('[Visitas] Erro ao carregar pgina:', e);
      }
    }
    
    // Carregar lista de visitas
    async function carregarVisitas() {
      const periodo = document.getElementById('filtroVisitasPeriodo')?.value || 'semana';
      const lista = document.getElementById('listaVisitas');
      
      // Verificar visita em andamento
      const cardEmAndamento = document.getElementById('visitaEmAndamentoCard');
      const btnIniciar = document.getElementById('btnIniciarVisitaPg');
      
      if (atendimentoEmAndamento) {
        if (cardEmAndamento) cardEmAndamento.style.display = 'flex';
        if (btnIniciar) btnIniciar.style.display = 'none';
        atualizarTimerVisita();
      } else {
        if (cardEmAndamento) cardEmAndamento.style.display = 'none';
        if (btnIniciar) btnIniciar.style.display = 'flex';
      }
      
      // Carregar resumo de metas
      try {
        const resResumo = await fetch('/api/app/atendimentos/resumo');
        if (resResumo.ok) {
          const dataResumo = await resResumo.json();
          // Atualizar valores
          const hojeEl = document.getElementById('visitaHojePg');
          const semanaEl = document.getElementById('visitaSemanaPg');
          const mesEl = document.getElementById('visitaMesPg');
          const metaDiaEl = document.getElementById('visitaMetaDiaPg');
          const metaSemanaEl = document.getElementById('visitaMetaSemanaPg');
          const metaMesEl = document.getElementById('visitaMetaMesPg');
          
          if (hojeEl) hojeEl.textContent = dataResumo.hoje?.realizado || 0;
          if (semanaEl) semanaEl.textContent = dataResumo.semana?.realizado || 0;
          if (mesEl) mesEl.textContent = dataResumo.mes?.realizado || 0;
          if (metaDiaEl) metaDiaEl.textContent = dataResumo.hoje?.meta || 0;
          if (metaSemanaEl) metaSemanaEl.textContent = dataResumo.semana?.meta || 0;
          if (metaMesEl) metaMesEl.textContent = dataResumo.mes?.meta || 0;
          
          // Barras de progresso
          const barDia = document.getElementById('visitaBarDiaPg');
          const barSemana = document.getElementById('visitaBarSemanaPg');
          const barMes = document.getElementById('visitaBarMesPg');
          const percentDia = document.getElementById('visitaPercentDiaPg');
          const percentSemana = document.getElementById('visitaPercentSemanaPg');
          const percentMes = document.getElementById('visitaPercentMesPg');
          
          const pctHoje = Math.min(100, dataResumo.hoje?.percentual || 0);
          const pctSemana = Math.min(100, dataResumo.semana?.percentual || 0);
          const pctMes = Math.min(100, dataResumo.mes?.percentual || 0);
          
          if (barDia) barDia.style.width = pctHoje + '%';
          if (barSemana) barSemana.style.width = pctSemana + '%';
          if (barMes) barMes.style.width = pctMes + '%';
          if (percentDia) percentDia.textContent = pctHoje + '%';
          if (percentSemana) percentSemana.textContent = pctSemana + '%';
          if (percentMes) percentMes.textContent = pctMes + '%';
        }
      } catch (e) {
        console.log('[Visitas] Erro ao carregar resumo:', e);
      }
      
      try {
        const res = await fetch('/api/app/atendimentos?periodo=' + periodo);
        if (!res.ok) throw new Error('Erro ao buscar');
        
        const data = await res.json();
        
        // Inicializar e atualizar mapa
        inicializarMapaVisitas();
        if (data.atendimentos && data.atendimentos.length > 0) {
          atualizarMapaVisitas(data.atendimentos);
        }
        
        if (!data.atendimentos || data.atendimentos.length === 0) {
          lista.innerHTML = '<div class="visitas-empty"><i class="bi bi-geo-alt"></i><p>Nenhuma visita registrada</p></div>';
          return;
        }
        
        lista.innerHTML = data.atendimentos.map(v => {
          // Tratar data com fallback
          let hora = '--:--';
          if (v.data_hora_inicio) {
            try {
              const d = new Date(v.data_hora_inicio);
              if (!isNaN(d.getTime())) {
                hora = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
              }
            } catch(e) {}
          }
          
          const isAndamento = v.status === 'EM_ANDAMENTO';
          const isCancelado = v.status === 'CANCELADO';
          const iconBg = isCancelado ? 'rgba(239,68,68,0.15)' : (isAndamento ? 'rgba(99,102,241,0.15)' : 'rgba(16,185,129,0.15)');
          const iconColor = isCancelado ? '#ef4444' : (isAndamento ? '#6366f1' : '#10b981');
          const iconName = isCancelado ? 'bi-x-circle' : (isAndamento ? 'bi-clock' : 'bi-check-circle');
          
          return '<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #334155;">' +
            '<div style="width:40px;height:40px;border-radius:50%;background:' + iconBg + ';color:' + iconColor + ';display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;"><i class="bi ' + iconName + '"></i></div>' +
            '<div style="flex:1;min-width:0;">' +
              '<div style="font-size:13px;color:#e2e8f0;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (v.endereco || 'Sem endereo') + '</div>' +
              '<div style="font-size:11px;color:#64748b;margin-top:2px;">' + (v.nome_atendido || '-') + '  ' + (v.tipo_atendimento || v.tipo || 'DOMICILIAR') + '</div>' +
            '</div>' +
            '<div style="text-align:right;">' +
              '<div style="font-size:13px;color:#e2e8f0;font-weight:500;">' + hora + '</div>' +
              '<div style="font-size:11px;color:#64748b;">' + (v.duracao_minutos ? v.duracao_minutos + ' min' : '-') + '</div>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch (e) {
        console.error('[Visitas] Erro ao carregar lista:', e);
        lista.innerHTML = '<div class="visitas-empty"><i class="bi bi-exclamation-triangle"></i><p>Erro ao carregar</p></div>';
      }
    }


    
    // Carregar lista de visitas na pgina
    async function carregarListaVisitas() {
      try {
        // Verificar se tem visita em andamento
        const emAndamentoCard = document.getElementById('visitaEmAndamentoCard');
        const btnIniciar = document.getElementById('btnIniciarVisitaPg');
        
        if (atendimentoEmAndamento) {
          emAndamentoCard.style.display = 'block';
          btnIniciar.style.display = 'none';
          // Iniciar timer
          atualizarTimerVisita();
        } else {
          emAndamentoCard.style.display = 'none';
          btnIniciar.style.display = 'block';
        }
        
        // Carregar resumo
        const resResumo = await fetch('/api/app/atendimentos/resumo');
        if (resResumo.ok) {
          const data = await resResumo.json();
          document.getElementById('visitaHojePg').textContent = data.hoje?.realizado || 0;
          document.getElementById('visitaSemanaPg').textContent = data.semana?.realizado || 0;
          document.getElementById('visitaMesPg').textContent = data.mes?.realizado || 0;
        }
        
        // Carregar lista
        const periodo = document.getElementById('filtroVisitasPeriodo')?.value || 'semana';
        const res = await fetch('/api/app/atendimentos?periodo=' + periodo);
        if (!res.ok) return;
        
        const data = await res.json();
        const lista = document.getElementById('listaVisitasPg');
        
        if (!data.atendimentos || data.atendimentos.length === 0) {
          lista.innerHTML = '<div style="padding:30px;text-align:center;color:var(--text-muted);"><i class="bi bi-geo-alt" style="font-size:32px;opacity:0.5;"></i><p style="margin:8px 0 0;">Nenhuma visita registrada</p></div>';
          return;
        }
        
        lista.innerHTML = data.atendimentos.map(v => {
          const data = new Date(v.data_hora_inicio);
          const hora = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          const dia = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          const statusIcon = v.status === 'FINALIZADO' ? 'bi-check-circle text-success' : (v.status === 'CANCELADO' ? 'bi-x-circle text-danger' : 'bi-clock text-primary');
          
          return `
            <div style="padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:12px;">
              <div style="width:36px;height:36px;border-radius:50%;background:rgba(16,185,129,0.15);color:#10b981;display:flex;align-items:center;justify-content:center;">
                <i class="bi ${statusIcon}"></i>
              </div>
              <div style="flex:1;min-width:0;">
                <div style="font-size:13px;color:var(--text-primary);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${v.endereco || 'Sem endereo'}</div>
                <div style="font-size:11px;color:var(--text-muted);">${v.nome_atendido || '-'}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:12px;color:var(--text-primary);">${hora}</div>
                <div style="font-size:10px;color:var(--text-muted);">${dia}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('[Visitas] Erro:', e);
      }
    }

    async function carregarAtendimentoConfig() {
      console.log('[ATEND] carregarAtendimentoConfig chamado');
      try {
        const res = await fetch('/api/app/atendimentos/config');
        console.log('[ATEND] status:', res.status);
        if (!res.ok) {
          const btnAtend = document.getElementById('btnAtendimento'); if (btnAtend) btnAtend.classList.remove('visible');
          return;
        }

        const data = await res.json();
        console.log('[ATEND] data recebida:', JSON.stringify(data));
        atendimentoConfig = data;

        const btn = document.getElementById('btnAtendimento'); // Pode ser null se boto foi removido
        console.log('[ATEND] data.ativo:', data.ativo);

        // Mostra botao se funcionario tem atendimento configurado
        if (data.ativo) {
          console.log('[ATEND] Config ativa');
          if (btn) btn.classList.add('visible');
          
          // Mostra menu de visitas
          const navVisitas = document.getElementById('navVisitas');
          if (navVisitas) navVisitas.style.display = 'flex';

          // Verifica se tem atendimento em andamento
          await verificarAtendimentoEmAndamento();
          
          // Carrega metas de visitas
          await carregarMetasVisitas();
        } else {
          if (btn) btn.classList.remove('visible');
        }
      } catch (e) {
        console.log('[Atendimento] Config nao disponivel:', e.message);
        const btnCatch = document.getElementById('btnAtendimento');
        if (btnCatch) btnCatch.classList.remove('visible');
      }
    }

    async function verificarAtendimentoEmAndamento() {
      try {
        const res = await fetch('/api/app/atendimentos/em-andamento');
        const data = await res.json();
        console.log('[VISITA] verificarAtendimentoEmAndamento:', data);

        if (data.em_andamento) {
          atendimentoEmAndamento = data.atendimento;
          console.log('[VISITA] Atendimento em andamento encontrado');
        } else {
          atendimentoEmAndamento = null;
          console.log('[VISITA] Nenhum atendimento em andamento');
        }
        
        // Atualizar botes
        atualizarBotoesVisita();
      } catch (e) {
        console.error('[Atendimento] Erro ao verificar:', e);
        atendimentoEmAndamento = null;
        atualizarBotoesVisita();
      }
    }

    function abrirAtendimento() {
      if (atendimentoEmAndamento) {
        // Confirmar antes de finalizar
        showConfirm('Deseja finalizar esta visita?', function() {
          abrirFinalizarAtendimento();
        });
      } else {
        // Verificar se tem ponto registrado hoje
        if (!temPontoHoje) {
          showToast('Voce precisa registrar o ponto antes de iniciar uma visita!', 'warning');
          return;
        }
        // Confirmar antes de iniciar
        showConfirm('Deseja iniciar uma nova visita?', function() {
          abrirIniciarAtendimento();
        });
      }
    }

    function abrirIniciarAtendimento() {
      // Verifica se precisa de foto
      if (atendimentoConfig && atendimentoConfig.exige_foto === false) {
        // No precisa de foto, inicia direto com GPS
        iniciarAtendimentoSemFoto();
      } else {
        // Precisa de foto, abre captura
        modoCaptura = 'atendimento-inicio';
        abrirCaptura();
      }
    }
    
    async function iniciarAtendimentoSemFoto() {
      try {
        // Obter GPS
        if (atendimentoConfig?.exige_gps !== false) {
          await obterGPS();
        }
        
        // Buscar endereo via geocoding
        let enderecoData = null;
        if (gpsCoords?.latitude && gpsCoords?.longitude) {
          showToast('Buscando endereo...', 'info');
          enderecoData = await buscarEndereco(gpsCoords.latitude, gpsCoords.longitude);
          console.log('[Visita] Endereo encontrado:', enderecoData);
        }
        
        const payload = {
          foto_inicio: null,
          latitude_inicio: gpsCoords?.latitude,
          longitude_inicio: gpsCoords?.longitude,
          precisao_gps_inicio: gpsCoords?.precisao,
          endereco: enderecoData?.endereco || null,
          numero: enderecoData?.numero || null,
          bairro: enderecoData?.bairro || null,
          cidade: enderecoData?.cidade || null,
          cep: enderecoData?.cep || null
        };

        if (!estaOnline()) {
          const salvo = salvarFilaOffline(OFFLINE_ATENDIMENTO_KEY, {
            ...payload,
            tipo: 'inicio'
          });
          if (salvo) {
            mostrarSucessoOffline('Atendimento');
            atualizarBadgePendentes();
            atendimentoEmAndamento = { local: true, data_hora_inicio: new Date().toISOString() };
            verificarAtendimentoEmAndamento();
          }
          return;
        }

        const res = await fetch('/api/app/atendimentos/iniciar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Erro ao iniciar atendimento');
        }

        showToast('Visita iniciada!', 'success');
        verificarAtendimentoEmAndamento();
        carregarMetasVisitas();

      } catch (e) {
        showToast('Erro: ' + e.message);
      }
    }

    function abrirFinalizarAtendimento() {
      // Verifica se precisa de foto
      if (atendimentoConfig && atendimentoConfig.exige_foto === false) {
        finalizarAtendimentoSemFoto();
      } else {
        modoCaptura = 'atendimento-fim';
        abrirCaptura();
      }
    }
    
    async function finalizarAtendimentoSemFoto() {
      try {
        if (!atendimentoEmAndamento) {
          showToast('Nenhuma visita em andamento', 'info');
          return;
        }

        // Obter GPS
        if (atendimentoConfig?.exige_gps !== false) {
          await obterGPS();
        }

        const payload = {
          foto_fim: null,
          latitude_fim: gpsCoords?.latitude,
          longitude_fim: gpsCoords?.longitude,
          precisao_gps_fim: gpsCoords?.precisao
        };

        if (!estaOnline()) {
          const salvo = salvarFilaOffline(OFFLINE_ATENDIMENTO_KEY, {
            ...payload,
            tipo: 'fim',
            atendimento_id: atendimentoEmAndamento.id
          });
          if (salvo) {
            mostrarSucessoOffline('Atendimento');
            atualizarBadgePendentes();
            atendimentoEmAndamento = null;
            verificarAtendimentoEmAndamento();
          }
          return;
        }

        const res = await fetch(`/api/app/atendimentos/${atendimentoEmAndamento.id}/finalizar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Erro ao finalizar');
        }

        showToast('Visita finalizada com sucesso!', 'success');
        atendimentoEmAndamento = null;
        verificarAtendimentoEmAndamento();
        carregarMetasVisitas();

      } catch (e) {
        showToast('Erro: ' + e.message);
      }
    }

    async function iniciarAtendimento(fotoBase64) {
      try {
        const payload = {
          foto_inicio: fotoBase64,
          latitude_inicio: gpsCoords?.latitude,
          longitude_inicio: gpsCoords?.longitude,
          precisao_gps_inicio: gpsCoords?.precisao
        };

        // Verifica se esta offline
        if (!estaOnline()) {
          const salvo = salvarFilaOffline(OFFLINE_ATENDIMENTO_KEY, {
            ...payload,
            tipo: 'inicio'
          });
          if (salvo) {
            fecharCaptura();
            mostrarSucessoOffline('Atendimento');
            atualizarBadgePendentes();
            atendimentoEmAndamento = { local: true, data_hora_inicio: new Date().toISOString() };
            verificarAtendimentoEmAndamento();
          }
          return;
        }

        const res = await fetch('/api/app/atendimentos/iniciar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Erro ao iniciar atendimento');
        }

        fecharCaptura();
        mostrarSucessoAtendimento('Atendimento iniciado!');
        verificarAtendimentoEmAndamento();

      } catch (e) {
        showToast('Erro: ' + e.message);
      }
    }

    async function finalizarAtendimento(fotoBase64) {
      try {
        if (!atendimentoEmAndamento) {
          showToast('Nenhum atendimento em andamento', 'info');
          return;
        }

        const payload = {
          foto_fim: fotoBase64,
          latitude_fim: gpsCoords?.latitude,
          longitude_fim: gpsCoords?.longitude,
          precisao_gps_fim: gpsCoords?.precisao
        };

        // Verifica se esta offline
        if (!estaOnline()) {
          const salvo = salvarFilaOffline(OFFLINE_ATENDIMENTO_KEY, {
            ...payload,
            tipo: 'fim',
            atendimento_id: atendimentoEmAndamento.id
          });
          if (salvo) {
            fecharCaptura();
            mostrarSucessoOffline('Atendimento');
            atualizarBadgePendentes();
            atendimentoEmAndamento = null;
            verificarAtendimentoEmAndamento();
          }
          return;
        }

        const res = await fetch(`/api/app/atendimentos/${atendimentoEmAndamento.id}/finalizar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Erro ao finalizar atendimento');
        }

        fecharCaptura();
        mostrarSucessoAtendimento(`Atendimento finalizado! Duracao: ${data.atendimento.duracao_minutos} min`);
        atendimentoEmAndamento = null;
        verificarAtendimentoEmAndamento();

      } catch (e) {
        showToast('Erro: ' + e.message);
      }
    }

    function mostrarSucessoAtendimento(mensagem) {
      const overlay = document.getElementById('successOverlay');
      document.getElementById('successMessage').textContent = mensagem;
      document.getElementById('successSubmessage').textContent = '';

      overlay.classList.add('show');
      if (navigator.vibrate) navigator.vibrate(200);

      setTimeout(() => {
        overlay.classList.remove('show');
      }, 2000);
    }

    // Carrega config ao iniciar
    setTimeout(carregarAtendimentoConfig, 1500);

    // =====================
    // PWA INSTALL
    // =====================
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Mostra banner de instalacao
      setTimeout(() => {
        document.getElementById('installBanner').classList.add('show');
      }, 3000);
    });

    document.getElementById('btnInstall').addEventListener('click', async () => {
      if (!deferredPrompt) return;

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        document.getElementById('installBanner').classList.remove('show');
      }
      deferredPrompt = null;
    });

    function fecharInstallBanner() {
      document.getElementById('installBanner').classList.remove('show');
    }

    window.addEventListener('appinstalled', () => {
      document.getElementById('installBanner').classList.remove('show');
      deferredPrompt = null;
    });

    // =====================
    // NAVEGACAO
    // =====================
    document.querySelectorAll('.nav-item[data-page]').forEach(btn => {
      btn.addEventListener('click', () => {
        const pageId = btn.dataset.page;

        // Atualiza nav
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');

        // Mostra pagina
        document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');

        // Carrega dados se necessario
        if (pageId === 'pageJornada') carregarJornada();
        if (pageId === 'pageEspelho') carregarEspelho();
        if (pageId === 'pagePerfil') carregarPerfil();
        if (pageId === 'pageMensagens') carregarMensagensPage();
        if (pageId === 'pagePresencas') carregarPresencasPage();
        if (pageId === 'pageVisitas') carregarVisitas();
      });
    });

    // =====================
    // LOGIN
    // =====================
    // Mscara de CPF
    document.getElementById('loginCpf').addEventListener('input', function(e) {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length > 11) v = v.slice(0, 11);
      if (v.length > 9) {
        v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
      } else if (v.length > 6) {
        v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
      } else if (v.length > 3) {
        v = v.replace(/(\d{3})(\d{1,3})/, '$1.$2');
      }
      e.target.value = v;
    });

    document.getElementById('formLogin').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('btnLogin');
      const msg = document.getElementById('loginMsg');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Entrando...';
      msg.textContent = '';

      try {
        const res = await fetch('/api/app/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cpf: document.getElementById('loginCpf').value,
            matricula: document.getElementById('loginMatricula').value,
            senha: document.getElementById('loginSenha').value
          })
        });

        const data = await res.json();

        if (!res.ok) {
          msg.textContent = data.error || 'CPF, matrcula ou senha incorretos';
          msg.className = 'text-center mt-3 small text-danger';
          return;
        }

        // Verifica se  primeiro acesso (precisa trocar senha)
        if (data.primeiroAcesso) {
          mostrarModalTrocarSenha();
          return;
        }

        // Login OK - guarda credenciais para oferecer biometria
        const cpfUsado = document.getElementById('loginCpf').value;
        const matriculaUsada = document.getElementById('loginMatricula').value;
        const senhaUsada = document.getElementById('loginSenha').value;
        
        // Salvar credenciais se "Lembrar meus dados" estiver marcado
        const rememberCheckbox = document.getElementById('rememberMe');
        if (rememberCheckbox && rememberCheckbox.checked) {
          localStorage.setItem('savedCpf', cpfUsado);
          localStorage.setItem('savedMatricula', matriculaUsada);
          localStorage.setItem('savedSenha', btoa(senhaUsada)); // base64 bsico
          localStorage.setItem('rememberMe', 'true');
        } else if (rememberCheckbox) {
          localStorage.removeItem('savedCpf');
          localStorage.removeItem('savedMatricula');
          localStorage.removeItem('savedSenha');
          localStorage.removeItem('rememberMe');
        }

        // Carrega usuario e depois oferece biometria
        await carregarUsuario();

        // Oferece salvar biometria se disponivel e ainda nao configurado
        oferecerBiometria(cpfUsado, senhaUsada);
      } catch (e) {
        msg.textContent = 'Erro de conexao. Tente novamente.';
        msg.className = 'text-center mt-3 small text-danger';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Entrar';
      }
    });

    // Modal de troca de senha obrigatria
    function mostrarModalTrocarSenha() {
      const modal = document.createElement('div');
      modal.id = 'modalTrocarSenha';
      modal.className = 'modal fade show';
      modal.style.cssText = 'display: block; background: rgba(0,0,0,0.5);';
      modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>Primeiro Acesso</h5>
            </div>
            <div class="modal-body">
              <p class="text-muted mb-3">Para sua segurana, crie uma nova senha:</p>
              <form id="formTrocarSenha">
                <div class="mb-3">
                  <input type="password" class="form-control" id="novaSenha" placeholder="Nova senha (mnimo 6 caracteres)" minlength="6" required>
                </div>
                <div class="mb-3">
                  <input type="password" class="form-control" id="confirmarSenha" placeholder="Confirmar nova senha" minlength="6" required>
                </div>
                <div id="msgTrocarSenha" class="small text-danger mb-2"></div>
                <button type="submit" class="btn btn-primary w-100" id="btnTrocarSenha">
                  <i class="bi bi-check-lg me-2"></i>Salvar Nova Senha
                </button>
              </form>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('formTrocarSenha').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const novaSenha = document.getElementById('novaSenha').value;
        const confirmarSenha = document.getElementById('confirmarSenha').value;
        const msgEl = document.getElementById('msgTrocarSenha');
        const btn = document.getElementById('btnTrocarSenha');

        if (novaSenha !== confirmarSenha) {
          msgEl.textContent = 'As senhas no coincidem';
          return;
        }

        if (novaSenha.length < 6) {
          msgEl.textContent = 'A senha deve ter no mnimo 6 caracteres';
          return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';

        try {
          const res = await fetch('/api/app/alterar-senha', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ novaSenha, confirmarSenha })
          });

          const data = await res.json();

          if (!res.ok) {
            msgEl.textContent = data.error || 'Erro ao alterar senha';
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Salvar Nova Senha';
            return;
          }

          // Sucesso - remove modal e carrega usurio
          modal.remove();
          await carregarUsuario();

          // Oferece biometria
          const cpfUsado = document.getElementById('loginCpf').value;
          oferecerBiometria(cpfUsado, novaSenha);
        } catch (err) {
          msgEl.textContent = 'Erro de conexo';
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Salvar Nova Senha';
        }
      });
    }

    // =====================
    // CARREGAR USUARIO
    // =====================
    async function carregarUsuario() {
      try {
        const res = await fetch('/api/app/me');
        if (!res.ok) {
          mostrarLogin();
          return;
        }

        usuario = await res.json();

        document.getElementById('userName').textContent = usuario.nome;
        document.getElementById('userRole').textContent = usuario.cargo || 'Funcionario';
// Salva info do usuario para modo offline (Android)        if (window.AndroidApp && window.AndroidApp.saveUserInfo) {          try {            window.AndroidApp.saveUserInfo(usuario.nome, usuario.cpf || '', usuario.matricula || '');            console.log('[Android] Info do usuario salva para modo offline');          } catch(e) {            console.error('[Android] Erro ao salvar info:', e);          }        }

        mostrarApp();
        carregarStatus();
        carregarRegistros();
        carregarDiaInfo();
        carregarMensagens();
        carregarPresencaConfig();
        carregarAtendimentoConfig();
      } catch (e) {
        console.error('Erro ao carregar usuario:', e);
        mostrarLogin();
      }
    }

    function mostrarLogin() {
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('appSection').classList.add('hidden');
      document.getElementById('bottomNav').style.display = 'none';
      document.getElementById('btnLogout').style.display = 'none';

      // Verifica se biometria esta disponivel
      verificarBiometriaDisponivel();
    }

    function mostrarApp() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('appSection').classList.remove('hidden');
      document.getElementById('bottomNav').style.display = 'flex';
      document.getElementById('btnLogout').style.display = 'block';
    }

    // =====================
    // BIOMETRIA
    // =====================

    function verificarBiometriaDisponivel() {
      const biometricSection = document.getElementById('biometricLoginSection');
      if (!biometricSection) return;

      // Verifica se esta no app nativo e tem biometria
      if (window.AndroidApp && window.AndroidApp.isBiometricAvailable) {
        try {
          const disponivel = window.AndroidApp.isBiometricAvailable();
          const temCredenciais = window.AndroidApp.hasBiometricCredentials();

          if (disponivel && temCredenciais) {
            biometricSection.style.display = 'block';
            console.log('[Biometria] Disponivel e com credenciais salvas');
          } else {
            biometricSection.style.display = 'none';
            console.log('[Biometria] Disponivel:', disponivel, 'Credenciais:', temCredenciais);
          }
        } catch(e) {
          console.error('[Biometria] Erro:', e);
          biometricSection.style.display = 'none';
        }
      } else {
        biometricSection.style.display = 'none';
      }
    }

    function loginComBiometria() {
      if (!window.AndroidApp || !window.AndroidApp.authenticateWithBiometric) {
        showToast('Biometria nao disponivel', 'info');
        return;
      }

      const msg = document.getElementById('loginMsg');
      msg.textContent = 'Aguardando autenticacao...';
      msg.className = 'text-center mt-3 small text-info';

      // Define callbacks globais
      window._biometricSuccess = async function(cpf, senha) {
        msg.textContent = 'Autenticado! Entrando...';
        try {
          const res = await fetch('/api/app/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cpf, senha })
          });

          if (res.ok) {
            carregarUsuario();
          } else {
            msg.textContent = 'Credenciais salvas invlidas. Faa login com CPF e senha para atualizar.';
            msg.className = 'text-center mt-3 small text-danger';
          }
        } catch(e) {
          msg.textContent = 'Erro de conexao.';
          msg.className = 'text-center mt-3 small text-danger';
        }
      };

      window._biometricError = function(error) {
        if (error === 'cancelled') {
          msg.textContent = '';
        } else {
          msg.textContent = 'Erro: ' + error;
          msg.className = 'text-center mt-3 small text-danger';
        }
      };

      window.AndroidApp.authenticateWithBiometric('_biometricSuccess', '_biometricError');
    }

    function oferecerBiometria(cpf, senha) {
      // Verifica se esta no app nativo
      if (!window.AndroidApp || !window.AndroidApp.isBiometricAvailable) return;

      try {
        const disponivel = window.AndroidApp.isBiometricAvailable();
        const jaTemCredenciais = window.AndroidApp.hasBiometricCredentials();

        if (disponivel && !jaTemCredenciais) {
          // Mostra modal bonito
          setTimeout(() => {
            mostrarModalBiometria(cpf, senha);
          }, 1000);
        }
      } catch(e) {
        console.error('[Biometria] Erro ao oferecer:', e);
      }
    }

    function mostrarModalBiometria(cpf, senha) {
      const modal = document.createElement('div');
      modal.id = 'biometricModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 20px;
          padding: 30px;
          max-width: 320px;
          width: 100%;
          text-align: center;
          box-shadow: 0 10px 40px rgba(0,0,0,0.3);
          animation: slideUp 0.3s ease;
        ">
          <div style="
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
          ">
            <i class="bi bi-fingerprint" style="font-size: 40px; color: white;"></i>
          </div>
          <h4 style="margin: 0 0 10px; color: #1f2937; font-size: 20px;">
            Ativar Login por Digital?
          </h4>
          <p style="color: #6b7280; margin: 0 0 25px; font-size: 14px; line-height: 1.5;">
            Use sua digital para fazer login mais rapido nos proximos acessos.
          </p>
          <div style="display: flex; gap: 12px;">
            <button id="btnBiometricNo" style="
              flex: 1;
              padding: 14px;
              border: 2px solid #e5e7eb;
              background: white;
              color: #6b7280;
              border-radius: 12px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
            ">Agora nao</button>
            <button id="btnBiometricYes" style="
              flex: 1;
              padding: 14px;
              border: none;
              background: linear-gradient(135deg, #3b82f6, #1d4ed8);
              color: white;
              border-radius: 12px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
            ">Ativar</button>
          </div>
        </div>
      `;

      // Adiciona estilos de animacao se nao existirem
      if (!document.getElementById('biometricModalStyles')) {
        const style = document.createElement('style');
        style.id = 'biometricModalStyles';
        style.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }

      document.body.appendChild(modal);

      // Event listeners
      document.getElementById('btnBiometricNo').onclick = () => {
        modal.remove();
      };

      document.getElementById('btnBiometricYes').onclick = () => {
        window.AndroidApp.saveBiometricCredentials(cpf, senha);
        modal.remove();

        // Mostra confirmacao
        mostrarToast('Login por digital ativado!', 'success');
      };
    }

    function mostrarToast(mensagem, tipo = 'info') {
      const toast = document.createElement('div');
      const cores = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6'
      };
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: ${cores[tipo] || cores.info};
        color: white;
        padding: 14px 24px;
        border-radius: 30px;
        font-size: 14px;
        font-weight: 600;
        z-index: 99999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease;
      `;
      toast.textContent = mensagem;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'fadeIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }

    // =====================
    // INFORMACOES DO DIA
    // =====================
    async function carregarDiaInfo() {
      try {
        const res = await fetch('/api/app/dia-info');
        const data = await res.json();

        const banner = document.getElementById('alertaBanner');

        if (data.feriado) {
          banner.className = 'alert-banner feriado';
          banner.innerHTML = `
            <i class="bi bi-calendar-x"></i>
            <div class="alert-text">
              <div class="alert-title">Feriado</div>
              <div class="alert-desc">${data.feriado.descricao}</div>
            </div>
          `;
          banner.classList.remove('hidden');
        } else if (data.ponto_facultativo) {
          banner.className = 'alert-banner facultativo';
          banner.innerHTML = `
            <i class="bi bi-calendar-check"></i>
            <div class="alert-text">
              <div class="alert-title">Ponto Facultativo</div>
              <div class="alert-desc">${data.ponto_facultativo.descricao}</div>
            </div>
          `;
          banner.classList.remove('hidden');
        } else {
          banner.classList.add('hidden');
        }
      } catch (e) {
        console.error('Erro ao carregar info do dia:', e);
      }
    }

    // =====================
    // MENSAGENS
    // =====================
    let mensagensCache = [];

    async function carregarMensagens() {
      console.log('[MSG] carregarMensagens chamado');
      try {
        const res = await fetch('/api/app/mensagens');
        console.log('[MSG] status:', res.status);
        const data = await res.json();
        console.log('[MSG] data:', JSON.stringify(data));

        mensagensCache = data.mensagens || [];

        const badge = document.getElementById('msgBadge');

        // Atualiza badge de mensagens nao lidas
        const naoLidas = mensagensCache.filter(m => !m.lida).length;
        if (naoLidas > 0) {
          badge.textContent = naoLidas > 9 ? '9+' : naoLidas;
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }
      } catch (e) {
        console.error('Erro ao carregar mensagens:', e);
      }
    }

    // Mensagens selecionadas para exclusao em lote
    let mensagensSelecionadas = new Set();

    async function carregarMensagensPage() {
      try {
        // Se ja tem cache, usa; senao busca
        if (mensagensCache.length === 0) {
          const res = await fetch('/api/app/mensagens');
          const data = await res.json();
          mensagensCache = data.mensagens || [];
        }

        const container = document.getElementById('mensagensPageContent');
        const countEl = document.getElementById('mensagensCount');
        mensagensSelecionadas.clear();

        if (mensagensCache.length === 0) {
          countEl.textContent = 'Nenhuma mensagem';
          container.innerHTML = `
            <div class="empty-mensagens">
              <div class="empty-icon">
                <i class="bi bi-chat-dots"></i>
              </div>
              <h4>Nenhuma mensagem</h4>
              <p>Voce nao tem mensagens no momento.<br>Fique tranquilo, avisaremos se houver novidades!</p>
            </div>
          `;
          return;
        }

        const naoLidas = mensagensCache.filter(m => !m.lida).length;
        const lidas = mensagensCache.filter(m => m.lida).length;
        countEl.textContent = naoLidas > 0
          ? naoLidas + ' nao lida(s)'
          : mensagensCache.length + ' mensagem(ns)';

        const tipoIcon = {
          'INFO': 'bi-info-circle',
          'ALERTA': 'bi-exclamation-triangle',
          'URGENTE': 'bi-exclamation-octagon',
          'SUCESSO': 'bi-check-circle',
          'ERRO': 'bi-x-circle'
        };

        const tipoIconClass = {
          'INFO': 'info',
          'ALERTA': 'alerta',
          'URGENTE': 'urgente',
          'SUCESSO': 'sucesso',
          'ERRO': 'urgente'
        };

        const categoriaLabel = {
          'SISTEMA': 'Sistema',
          'PONTO': 'Ponto',
          'BANCO_HORAS': 'Banco de Horas',
          'FERIAS': 'Ferias',
          'APROVACAO': 'Aprovacao'
        };

        // Header com selecionar todas e excluir selecionadas
        let html = '';
        if (lidas > 0) {
          html += `
            <div class="msg-select-header" style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#f8fafc;border-bottom:1px solid #e2e8f0;margin-bottom:8px;border-radius:8px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;color:#475569;">
                <input type="checkbox" id="selectAllMsgs" onchange="toggleSelectAllMensagens()" style="width:18px;height:18px;cursor:pointer;">
                Selecionar todas lidas
              </label>
              <button id="btnExcluirSelecionadas" onclick="excluirMensagensSelecionadas()" disabled
                style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer;opacity:0.5;">
                <i class="bi bi-trash"></i> Excluir selecionadas
              </button>
              <button onclick="limparMensagensTeste()"
                style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:#f97316;color:white;border:none;border-radius:6px;font-size:13px;cursor:pointer;">
                <i class="bi bi-trash3"></i> Limpar Testes
              </button>
            </div>
          `;
        }

        html += mensagensCache.map((m, index) => {
          const dataFormatada = m.created_at
            ? new Date(m.created_at).toLocaleDateString('pt-BR', {
                day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
              })
            : '';
          const icon = tipoIcon[m.tipo] || 'bi-chat';
          const iconClass = tipoIconClass[m.tipo] || 'info';
          const categoria = categoriaLabel[m.categoria] || m.categoria || 'Sistema';
          const unreadClass = !m.lida ? 'unread' : '';

          return `
            <div class="mensagem-item ${unreadClass}" data-msg-id="${m.id}" data-msg-index="${index}">
              <div class="msg-header" onclick="abrirMensagem(${index})">
                ${m.lida ? `
                  <input type="checkbox" class="msg-checkbox" data-id="${m.id}" onclick="event.stopPropagation(); toggleMensagemSelecionada(${m.id})"
                    style="width:18px;height:18px;margin-right:10px;cursor:pointer;">
                ` : ''}
                <div class="msg-icon ${iconClass}">
                  <i class="bi ${icon}"></i>
                </div>
                <div class="msg-meta">
                  <div class="msg-title">${m.titulo || 'Aviso'}${!m.lida ? ' <span style="color:#2563eb;font-size:10px;"> NOVA</span>' : ''}</div>
                  <div class="msg-date">${dataFormatada}</div>
                </div>
              </div>
              <div class="msg-body" onclick="abrirMensagem(${index})">${(m.mensagem || '').substring(0, 100)}${(m.mensagem || '').length > 100 ? '...' : ''}</div>
              <div class="msg-actions">
                ${!m.lida ? `
                  <button class="msg-action-btn read" onclick="event.stopPropagation(); marcarMensagemLida(${m.id}, ${index})">
                    <i class="bi bi-check2"></i> Marcar como lida
                  </button>
                ` : `
                  <span class="msg-action-btn read-indicator">
                    <i class="bi bi-check2-all"></i> Lida
                  </span>
                  <button class="msg-action-btn delete" onclick="event.stopPropagation(); excluirMensagem(${m.id}, ${index})">
                    <i class="bi bi-trash"></i> Excluir
                  </button>
                `}
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;

      } catch (e) {
        console.error('Erro ao carregar pagina de mensagens:', e);
      }
    }

    // Toggle selecao de mensagem individual
    function toggleMensagemSelecionada(id) {
      if (mensagensSelecionadas.has(id)) {
        mensagensSelecionadas.delete(id);
      } else {
        mensagensSelecionadas.add(id);
      }
      atualizarBotaoExcluirSelecionadas();
    }

    // Toggle selecionar todas
    function toggleSelectAllMensagens() {
      const selectAll = document.getElementById('selectAllMsgs');
      const checkboxes = document.querySelectorAll('.msg-checkbox');

      mensagensSelecionadas.clear();
      checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
        if (selectAll.checked) {
          mensagensSelecionadas.add(parseInt(cb.dataset.id));
        }
      });
      atualizarBotaoExcluirSelecionadas();
    }

    // Atualizar estado do botao excluir selecionadas
    function atualizarBotaoExcluirSelecionadas() {
      const btn = document.getElementById('btnExcluirSelecionadas');
      if (btn) {
        btn.disabled = mensagensSelecionadas.size === 0;
        btn.style.opacity = mensagensSelecionadas.size === 0 ? '0.5' : '1';
      }
    }

    // Excluir mensagens selecionadas
    async function excluirMensagensSelecionadas() {
      if (mensagensSelecionadas.size === 0) return;

      const ids = Array.from(mensagensSelecionadas);

      try {
        const res = await fetch('/api/app/mensagens/excluir-lote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });

        if (res.ok) {
          const data = await res.json();
          // Remove do cache
          mensagensCache = mensagensCache.filter(m => !mensagensSelecionadas.has(m.id));
          mensagensSelecionadas.clear();

          // Atualiza UI
          carregarMensagensPage();
          carregarMensagens();

          mostrarToast(data.excluidas + ' mensagem(ns) excluida(s)', 'success');
        } else {
          const data = await res.json();
          mostrarToast(data.error || 'Erro ao excluir mensagens', 'error');
        }
      } catch (e) {
        console.error('Erro ao excluir mensagens:', e);
        mostrarToast('Erro ao excluir mensagens', 'error');
      }
    }

    // Variavel para armazenar mensagem atual sendo visualizada
    let mensagemAtualId = null;
    let mensagemAtualIndex = null;

    // Abrir mensagem no modal
    function abrirMensagem(index) {
      const m = mensagensCache[index];
      if (!m) return;

      mensagemAtualId = m.id;
      mensagemAtualIndex = index;

      const tipoIcon = {
        'INFO': 'bi-info-circle',
        'ALERTA': 'bi-exclamation-triangle',
        'URGENTE': 'bi-exclamation-octagon',
        'SUCESSO': 'bi-check-circle'
      };
      const tipoLabel = {
        'INFO': 'Informacao',
        'ALERTA': 'Alerta',
        'URGENTE': 'Urgente',
        'SUCESSO': 'Sucesso'
      };
      const categoriaLabel = {
        'SISTEMA': 'Sistema',
        'PONTO': 'Ponto',
        'BANCO_HORAS': 'Banco de Horas',
        'FERIAS': 'Ferias',
        'APROVACAO': 'Aprovacao'
      };

      const dataFormatada = m.created_at
        ? new Date(m.created_at).toLocaleDateString('pt-BR', {
            day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
          })
        : '';

      document.getElementById('msgDetailType').innerHTML = `
        <i class="bi ${tipoIcon[m.tipo] || 'bi-chat'}"></i>
        <span>${tipoLabel[m.tipo] || 'Mensagem'}</span>
      `;
      document.getElementById('msgDetailTitle').textContent = m.titulo || 'Aviso';
      document.getElementById('msgDetailDate').textContent = dataFormatada;
      document.getElementById('msgDetailText').textContent = m.mensagem || '';
      document.getElementById('msgDetailCategoria').textContent = categoriaLabel[m.categoria] || m.categoria || 'Sistema';

      document.getElementById('msgDetailModal').classList.add('show');

      // Marca como lida automaticamente ao abrir
      if (!m.lida) {
        marcarMensagemLida(m.id, index, true);
      }
    }

    // Fechar modal de mensagem
    function fecharMsgDetail(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('msgDetailModal').classList.remove('show');
      mensagemAtualId = null;
      mensagemAtualIndex = null;
    }

    // Marcar mensagem como lida
    async function marcarMensagemLida(id, index, silencioso = false) {
      try {
        const res = await fetch(`/api/app/mensagens/${id}/lida`, {
          method: 'POST'
        });

        if (res.ok) {
          // Atualiza cache local
          if (mensagensCache[index]) {
            mensagensCache[index].lida = true;
          }

          // Atualiza UI
          carregarMensagensPage();

          // Atualiza badge
          carregarMensagens();

          if (!silencioso) {
            mostrarToast('Mensagem marcada como lida', 'success');
          }
        }
      } catch (e) {
        console.error('Erro ao marcar como lida:', e);
        if (!silencioso) {
          mostrarToast('Erro ao marcar mensagem', 'error');
        }
      }
    }

    // Variaveis para exclusao
    let excluirId = null;
    let excluirIndex = null;

    // Mostrar modal de confirmacao

    // Limpar mensagens de teste
    async function limparMensagensTeste() {
      if (!confirm('Remover todas as mensagens de TESTE?')) return;
      
      try {
        const res = await fetch('/api/app/mensagens/limpar-testes', { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          // Recarregar mensagens
          carregarMensagens();
          showToast('Mensagens de teste removidas!', 'success');
        } else {
          showToast(data.error || 'Erro ao limpar', 'error');
        }
      } catch (e) {
        showToast('Erro ao limpar mensagens', 'error');
      }
    }

    function excluirMensagem(id, index) {
      excluirId = id;
      excluirIndex = index;
      document.getElementById('confirmModal').classList.add('show');
    }

    // Fechar modal de confirmacao
    function fecharConfirmModal() {
      document.getElementById('confirmModal').classList.remove('show');
      excluirId = null;
      excluirIndex = null;
    }

    // Confirmar exclusao
    async function confirmarExclusao() {
      if (excluirId === null) return;

      // Salva os valores antes de fechar o modal (que reseta as variveis)
      const idParaExcluir = excluirId;
      const indexParaExcluir = excluirIndex;

      fecharConfirmModal();

      try {
        const res = await fetch(`/api/app/mensagens/${idParaExcluir}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          // Remove do cache
          if (indexParaExcluir !== null) {
            mensagensCache.splice(indexParaExcluir, 1);
          }

          // Atualiza UI
          carregarMensagensPage();

          // Atualiza badge
          carregarMensagens();

          mostrarToast('Mensagem excluida', 'success');
        } else {
          const data = await res.json();
          mostrarToast(data.error || 'Erro ao excluir mensagem', 'error');
        }
      } catch (e) {
        console.error('Erro ao excluir:', e);
        mostrarToast('Erro ao excluir mensagem', 'error');
      }
    }

    // Excluir mensagem atual (do modal de detalhe)
    function excluirMensagemAtual() {
      if (mensagemAtualId !== null && mensagemAtualIndex !== null) {
        fecharMsgDetail();
        excluirMensagem(mensagemAtualId, mensagemAtualIndex);
      }
    }

    // =====================
    // PERMISSAO CAMERA
    // =====================
    async function verificarPermissaoCamera() {
      const modal = document.getElementById('permissionModal');
      const statusEl = document.getElementById('permissionStatus');
      const instructionsEl = document.getElementById('permissionInstructions');
      const btnRequest = document.getElementById('btnRequestPermission');

      modal.classList.add('show');

      // Detecta dispositivo
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);
      const isChrome = /Chrome/.test(navigator.userAgent);
      const isSafari = /Safari/.test(navigator.userAgent) && !isChrome;

      try {
        // Verifica se API de permissoes esta disponivel
        if (navigator.permissions && navigator.permissions.query) {
          const result = await navigator.permissions.query({ name: 'camera' });

          if (result.state === 'granted') {
            statusEl.className = 'permission-status granted';
            statusEl.innerHTML = '<i class="bi bi-check-circle-fill"></i> <span>Camera PERMITIDA</span>';
            btnRequest.style.display = 'none';
            instructionsEl.innerHTML = `
              <p>A camera ja esta permitida! Voce pode usar normalmente os botoes de registro.</p>
              <p style="margin-top: 12px; color: #059669;"><i class="bi bi-check2"></i> Tudo certo!</p>
            `;
          } else if (result.state === 'denied') {
            statusEl.className = 'permission-status denied';
            statusEl.innerHTML = '<i class="bi bi-x-circle-fill"></i> <span>Camera BLOQUEADA</span>';
            btnRequest.style.display = 'none';
            instructionsEl.innerHTML = getInstrucoesBloqueada(isIOS, isAndroid, isChrome, isSafari);
          } else {
            statusEl.className = 'permission-status prompt';
            statusEl.innerHTML = '<i class="bi bi-question-circle-fill"></i> <span>Permissao pendente</span>';
            btnRequest.style.display = 'block';
            instructionsEl.innerHTML = `
              <p>Clique no botao abaixo para solicitar acesso a camera.</p>
              <p style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                Quando aparecer o popup, clique em <strong>"Permitir"</strong>.
              </p>
            `;
          }

          // Escuta mudancas na permissao
          result.onchange = () => verificarPermissaoCamera();
        } else {
          // API nao disponivel, tenta solicitar diretamente
          statusEl.className = 'permission-status prompt';
          statusEl.innerHTML = '<i class="bi bi-question-circle-fill"></i> <span>Verificacao nao disponivel</span>';
          btnRequest.style.display = 'block';
          instructionsEl.innerHTML = `
            <p>Clique no botao abaixo para testar a camera.</p>
            ${getInstrucoesBloqueada(isIOS, isAndroid, isChrome, isSafari)}
          `;
        }
      } catch (e) {
        console.error('Erro ao verificar permissao:', e);
        statusEl.className = 'permission-status prompt';
        statusEl.innerHTML = '<i class="bi bi-question-circle-fill"></i> <span>Clique para testar</span>';
        btnRequest.style.display = 'block';
      }
    }

    function getInstrucoesBloqueada(isIOS, isAndroid, isChrome, isSafari) {
      if (isIOS) {
        return `
          <h5><i class="bi bi-phone"></i> Como liberar no iPhone/iPad:</h5>
          <ol>
            <li>Abra o app <strong>Ajustes</strong> do iPhone</li>
            <li>Role ate encontrar <strong>Safari</strong> (ou o navegador que usa)</li>
            <li>Toque em <strong>Camera</strong></li>
            <li>Selecione <strong>Permitir</strong></li>
            <li>Volte aqui e recarregue a pagina</li>
          </ol>
          <p style="margin-top: 12px; font-size: 11px; color: #6b7280;">
            Ou toque no <strong>AA</strong> na barra de endereco > Configuracoes do Site > Camera > Permitir
          </p>
        `;
      } else if (isAndroid && isChrome) {
        return `
          <h5><i class="bi bi-phone"></i> Como liberar no Android (Chrome):</h5>
          <ol>
            <li>Toque no <strong>cadeado</strong> ao lado do endereco</li>
            <li>Toque em <strong>Permissoes</strong></li>
            <li>Encontre <strong>Camera</strong></li>
            <li>Mude para <strong>Permitir</strong></li>
            <li>Recarregue a pagina</li>
          </ol>
          <p style="margin-top: 12px; font-size: 11px; color: #6b7280;">
            Ou: Menu (3 pontos) > Configuracoes > Configuracoes do site > Camera
          </p>
        `;
      } else {
        return `
          <h5><i class="bi bi-globe"></i> Como liberar a camera:</h5>
          <ol>
            <li>Clique no icone de <strong>cadeado</strong> ou <strong>informacoes</strong> na barra de endereco</li>
            <li>Encontre a opcao <strong>Camera</strong></li>
            <li>Altere para <strong>Permitir</strong></li>
            <li>Recarregue a pagina</li>
          </ol>
        `;
      }
    }

    async function solicitarPermissaoCamera() {
      const statusEl = document.getElementById('permissionStatus');
      const instructionsEl = document.getElementById('permissionInstructions');
      const btnRequest = document.getElementById('btnRequestPermission');

      statusEl.className = 'permission-status prompt';
      statusEl.innerHTML = '<i class="bi bi-hourglass-split"></i> <span>Solicitando...</span>';

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });

        // Sucesso!
        statusEl.className = 'permission-status granted';
        statusEl.innerHTML = '<i class="bi bi-check-circle-fill"></i> <span>Camera PERMITIDA!</span>';
        btnRequest.style.display = 'none';
        instructionsEl.innerHTML = `
          <p style="color: #059669;"><i class="bi bi-check2"></i> Camera liberada com sucesso!</p>
          <p style="margin-top: 8px;">Agora voce pode fechar esta janela e usar os botoes de registro normalmente.</p>
        `;

        // Para o stream de teste
        stream.getTracks().forEach(track => track.stop());
      } catch (e) {
        console.error('Erro ao solicitar camera:', e);

        if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
          statusEl.className = 'permission-status denied';
          statusEl.innerHTML = '<i class="bi bi-x-circle-fill"></i> <span>Permissao NEGADA</span>';
          btnRequest.style.display = 'none';

          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isAndroid = /Android/.test(navigator.userAgent);
          const isChrome = /Chrome/.test(navigator.userAgent);
          const isSafari = /Safari/.test(navigator.userAgent) && !isChrome;

          instructionsEl.innerHTML = `
            <p style="color: #dc2626; margin-bottom: 12px;">Voce negou o acesso a camera. Siga as instrucoes abaixo para liberar manualmente:</p>
            ${getInstrucoesBloqueada(isIOS, isAndroid, isChrome, isSafari)}
          `;
        } else {
          statusEl.className = 'permission-status denied';
          statusEl.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> <span>Erro ao acessar camera</span>';
          instructionsEl.innerHTML = `
            <p style="color: #dc2626;">Erro: ${e.message || 'Nao foi possivel acessar a camera'}</p>
            <p style="margin-top: 8px;">Verifique se seu dispositivo possui camera e se nenhum outro app esta usando.</p>
          `;
        }
      }
    }

    function fecharPermissionModal() {
      document.getElementById('permissionModal').classList.remove('show');
    }

    // =====================
    // STATUS E REGISTROS
    // =====================
    async function carregarStatus() {
      try {
        const res = await fetch('/api/app/status');
        const data = await res.json();

        document.getElementById('horasHoje').textContent = data.horas_hoje || '00:00';
        document.getElementById('bancoHoras').textContent = data.banco_horas || '00:00';

        ultimoRegistro = data.ultimo_registro;
      } catch (e) {
        console.error('Erro ao carregar status:', e);
      }
    }

    async function carregarRegistros() {
      try {
        const res = await fetch('/api/app/registros-hoje');
        const data = await res.json();

        const lista = document.getElementById('registrosList');

        // Verificar se tem ponto de ENTRADA hoje
        temPontoHoje = data.registros && data.registros.some(r => r.tipo === 'ENTRADA');
        console.log('[Registros] Tem ponto ENTRADA hoje:', temPontoHoje);
        
        if (!data.registros || data.registros.length === 0) {
          lista.innerHTML = '<div class="text-center text-muted py-3">Nenhum registro hoje</div>';
          return;
        }

        lista.innerHTML = data.registros.map(r => `
          <div class="registro-item">
            <div class="registro-icon ${r.tipo.toLowerCase()}">
              <i class="bi bi-${r.tipo === 'ENTRADA' ? 'arrow-right-circle-fill' : 'arrow-left-circle-fill'}"></i>
            </div>
            <div class="registro-info">
              <div class="tipo">${r.tipo}</div>
              <div class="hora">${r.hora}</div>
            </div>
            ${r.latitude ? `<div class="registro-gps"><i class="bi bi-geo-alt"></i></div>` : ''}
          </div>
        `).join('');

        // Atualiza mapa com registros que tem GPS
        // Sempre inicializar o mapa, mesmo sem dados
      inicializarMapa();
      
      // Atualizar com marcadores se tiver dados
      const registrosComGPS = data.registros.filter(r => r.latitude && r.longitude);
      if (registrosComGPS.length > 0) {
        atualizarMapa(registrosComGPS);
      }
      } catch (e) {
        console.error('Erro ao carregar registros:', e);
      }
    }

    // =====================
    // JORNADA
    // =====================
    async function carregarJornada() {
      try {
        const res = await fetch('/api/app/jornada');
        const data = await res.json();

        const container = document.getElementById('jornadaContent');

        if (!data || data.error) {
          container.innerHTML = '<div class="text-center text-muted py-3">Jornada nao definida</div>';
          return;
        }

        let html = `
          <div class="mb-3">
            <strong>Jornada:</strong> ${data.nome || 'Padrao'}
          </div>
          <div class="mb-3">
            <strong>Carga Horaria Diaria:</strong> ${data.carga_horaria || '08:00'}
          </div>
        `;

        if (data.horarios && data.horarios.length > 0) {
          html += '<div class="mt-3"><strong>Horarios por Dia:</strong></div>';
          html += data.horarios.map(h => {
            if (h.folga) {
              return `
                <div class="jornada-item">
                  <span class="jornada-dia">${h.dia}</span>
                  <span class="jornada-horarios text-muted">Folga</span>
                </div>
              `;
            }
            const horario1 = h.entrada_1 && h.saida_1 ? `${h.entrada_1} - ${h.saida_1}` : '';
            const horario2 = h.entrada_2 && h.saida_2 ? ` / ${h.entrada_2} - ${h.saida_2}` : '';
            return `
              <div class="jornada-item">
                <span class="jornada-dia">${h.dia}</span>
                <span class="jornada-horarios">${horario1}${horario2 || ''}</span>
              </div>
            `;
          }).join('');
        } else {
          html += `
            <div class="alert alert-info mt-3" style="font-size: 13px;">
              <i class="bi bi-info-circle me-2"></i>
              Horarios detalhados nao cadastrados. Consulte o RH.
            </div>
          `;
        }

        container.innerHTML = html;
      } catch (e) {
        console.error('Erro ao carregar jornada:', e);
        document.getElementById('jornadaContent').innerHTML = '<div class="text-center text-danger py-3">Erro ao carregar</div>';
      }
    }

    // =====================
    // ESPELHO DE PONTO
    // =====================
    function navegarEspelho(direcao) {
      espelhoMes += direcao;
      if (espelhoMes > 12) {
        espelhoMes = 1;
        espelhoAno++;
      } else if (espelhoMes < 1) {
        espelhoMes = 12;
        espelhoAno--;
      }
      carregarEspelho();
    }

    async function carregarEspelho() {
      const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      document.getElementById('espelhoMesAno').textContent = `${meses[espelhoMes-1]}/${espelhoAno}`;

      const container = document.getElementById('espelhoContent');
      container.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-primary" role="status"></div></div>';

      try {
        const res = await fetch(`/api/app/espelho/${espelhoMes}/${espelhoAno}`);
        const data = await res.json();

        if (!data.dias || data.dias.length === 0) {
          container.innerHTML = '<div class="text-center text-muted py-3">Nenhum registro neste mes</div>';
          return;
        }

        let html = `
          <table class="espelho-table">
            <thead>
              <tr>
                <th>Dia</th>
                <th>Entrada</th>
                <th>Saida</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.dias.forEach(d => {
          const rowClass = d.feriado ? 'feriado' : (d.falta ? 'falta' : '');
          html += `
            <tr class="${rowClass}">
              <td>${d.dia} ${d.dia_semana || ''}</td>
              <td>${d.entrada || '--:--'}</td>
              <td>${d.saida || '--:--'}</td>
              <td>${d.total || '--:--'}</td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>
          <div class="mt-3 p-3 bg-light rounded">
            <strong>Total do Mes:</strong> ${data.total_mes || '00:00'}
            ${data.banco_horas ? `<br><strong>Banco de Horas:</strong> ${data.banco_horas}` : ''}
          </div>
        `;

        container.innerHTML = html;
      } catch (e) {
        console.error('Erro ao carregar espelho:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Erro ao carregar</div>';
      }
    }

    // =====================
    // PERFIL
    // =====================
    async function carregarPerfil() {
      try {
        const res = await fetch('/api/app/perfil');
        const data = await res.json();

        const container = document.getElementById('perfilContent');

        if (!data || data.error) {
          container.innerHTML = '<div class="text-center text-muted py-3">Dados no disponveis</div>';
          return;
        }

        const f = data;

        // Verificar se biometria est disponvel
        let biometricAvailable = false;
        let biometricEnabled = false;

        if (window.AndroidApp && window.AndroidApp.isBiometricAvailable) {
          try {
            biometricAvailable = window.AndroidApp.isBiometricAvailable();
            biometricEnabled = window.AndroidApp.hasBiometricCredentials();
          } catch (e) {
            console.log('Erro ao verificar biometria:', e);
          }
        }

        container.innerHTML = `
          <div class="perfil-header">
            <div class="perfil-avatar">
              <i class="bi bi-person-fill"></i>
            </div>
            <div class="perfil-nome">${f.nome || 'Funcionrio'}</div>
            <div class="perfil-cargo">${f.cargo || 'Servidor'}</div>
          </div>

          <div class="perfil-body">
            <!-- Informaes Pessoais -->
            <div class="perfil-section-inline">
              <div class="perfil-section-header">
                <i class="bi bi-person-vcard"></i>
                <span>Informaes Pessoais</span>
              </div>
              <div class="perfil-grid">
                <div class="perfil-field">
                  <span class="perfil-label">Matrcula</span>
                  <span class="perfil-value">${f.matricula || '-'}</span>
                </div>
                <div class="perfil-field">
                  <span class="perfil-label">CPF</span>
                  <span class="perfil-value">${f.cpf ? f.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : '-'}</span>
                </div>
              </div>
            </div>

            <!-- Vnculo -->
            <div class="perfil-section-inline">
              <div class="perfil-section-header">
                <i class="bi bi-building"></i>
                <span>Vnculo</span>
              </div>
              <div class="perfil-grid">
                <div class="perfil-field full">
                  <span class="perfil-label">Secretaria/rgo</span>
                  <span class="perfil-value">${f.secretaria || '-'}</span>
                </div>
                <div class="perfil-field full">
                  <span class="perfil-label">Setor</span>
                  <span class="perfil-value">${f.setor || '-'}</span>
                </div>
                <div class="perfil-field">
                  <span class="perfil-label">Admisso</span>
                  <span class="perfil-value">${f.data_admissao ? new Date(f.data_admissao).toLocaleDateString('pt-BR') : '-'}</span>
                </div>
                <div class="perfil-field">
                  <span class="perfil-label">Carga Horria</span>
                  <span class="perfil-value">${f.carga_horaria ? f.carga_horaria + '/dia' : '-'}</span>
                </div>
              </div>
            </div>

            ${biometricAvailable ? `
            <!-- Configuraes de Biometria -->
            <div class="perfil-section-inline">
              <div class="perfil-section-header">
                <i class="bi bi-fingerprint"></i>
                <span>Login por Digital</span>
              </div>
              <div class="perfil-biometric-toggle">
                <span class="perfil-biometric-status">${biometricEnabled ? 'Ativado' : 'Desativado'}</span>
                <div class="toggle-switch ${biometricEnabled ? 'active' : ''}" id="toggleBiometric" onclick="toggleBiometric()"></div>
              </div>
            </div>
            ` : ''}
          </div>

          <!-- Boto Sair -->
          <div class="perfil-logout-section">
            <button class="perfil-logout-btn" onclick="fazerLogoutConfirm()">
              <i class="bi bi-box-arrow-right"></i>
              <span>Sair da Conta</span>
            </button>
          </div>

          <div class="perfil-version">
            GetPonto v1.0.0
          </div>
        `;
      } catch (e) {
        console.error('Erro ao carregar perfil:', e);
        document.getElementById('perfilContent').innerHTML = '<div class="text-center text-danger py-3">Erro ao carregar</div>';
      }
    }
    
    // Funo de logout com modal bonito
    function fazerLogoutConfirm() {
      document.getElementById('modalLogout').style.display = 'flex';
    }
    
    function fecharModalLogout() {
      document.getElementById('modalLogout').style.display = 'none';
    }
    
    async function confirmarLogout() {
      fecharModalLogout();
      await logout();
    }

    // Toggle biometria
    function toggleBiometric() {
      if (!window.AndroidApp || !window.AndroidApp.isBiometricAvailable) {
        mostrarToast('Biometria nao disponivel neste dispositivo', 'error');
        return;
      }

      const toggle = document.getElementById('toggleBiometric');
      const isActive = toggle.classList.contains('active');

      if (isActive) {
        // Desativar biometria
        try {
          window.AndroidApp.clearBiometricCredentials();
          toggle.classList.remove('active');
          mostrarToast('Login por digital desativado', 'info');
          // Atualiza a descricao
          const desc = toggle.closest('.setting-item').querySelector('.setting-desc');
          if (desc) desc.textContent = 'Desativado - Use CPF e senha';
        } catch (e) {
          mostrarToast('Erro ao desativar biometria', 'error');
        }
      } else {
        // Ativar biometria - precisa fazer login novamente
        mostrarToast('Faca login novamente para ativar a digital', 'warning');
        // Faz logout para o usuario fazer login e ativar a biometria
        setTimeout(() => {
          fazerLogout();
        }, 1500);
      }
    }

    // =====================
    // MAPA
    // =====================
    
    // Mapa de Visitas
    function inicializarMapaVisitas() {
      const container = document.getElementById('mapaVisitasContainer');
      if (!container) return;
      
      if (mapaVisitas) {
        setTimeout(() => mapaVisitas.invalidateSize(), 100);
        return;
      }

      try {
        mapaVisitas = L.map('mapaVisitasContainer').setView([-6.9, -35.6], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: ' OSM'
        }).addTo(mapaVisitas);
        setTimeout(() => mapaVisitas.invalidateSize(), 200);
      } catch (e) {
        console.error('[MapaVisitas] Erro:', e);
      }
    }
    
    function atualizarMapaVisitas(visitas) {
      inicializarMapaVisitas();
      if (!mapaVisitas) return;
      
      // Remove markers antigos
      markersVisitas.forEach(m => mapaVisitas.removeLayer(m));
      markersVisitas = [];
      
      const visitasComGPS = visitas.filter(v => v.latitude_inicio && v.longitude_inicio);
      if (visitasComGPS.length === 0) return;
      
      // Adiciona markers
      visitasComGPS.forEach((v, i) => {
        const icon = L.divIcon({
          className: 'custom-marker',
          html: '<div style="background:#8b5cf6;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:11px;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">' + (i+1) + '</div>',
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        
        const marker = L.marker([v.latitude_inicio, v.longitude_inicio], { icon })
          .addTo(mapaVisitas)
          .bindPopup('<strong>' + (v.nome_atendido || 'Visita') + '</strong><br>' + (v.endereco || ''));
        markersVisitas.push(marker);
      });
      
      // Centraliza no primeiro marker
      if (visitasComGPS.length > 0) {
        mapaVisitas.setView([visitasComGPS[0].latitude_inicio, visitasComGPS[0].longitude_inicio], 14);
      }
    }


    function inicializarMapa() {
      const container = document.getElementById('mapContainer');
      if (!container) return;
      
      if (map) {
        // Fora redimensionamento caso o container tenha mudado
        setTimeout(() => map.invalidateSize(), 100);
        return;
      }

      try {
        map = L.map('mapContainer').setView([-6.9, -35.6], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        
        // Fora redimensionamento aps criar
        setTimeout(() => map.invalidateSize(), 200);
      } catch (e) {
        console.error('[Mapa] Erro ao inicializar:', e);
      }
    }

    function atualizarMapa(registros) {
      inicializarMapa();

      // Remove markers antigos
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      if (registros.length === 0) return;

      // Adiciona markers
      registros.forEach((r, index) => {
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background:${r.tipo === 'ENTRADA' ? '#10b981' : '#ef4444'};width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">${index + 1}</div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });

        const marker = L.marker([r.latitude, r.longitude], { icon })
          .addTo(map)
          .bindPopup(`<strong>${r.tipo}</strong><br>${r.hora}`);

        markers.push(marker);
      });

      // Ajusta view para mostrar todos os markers
      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.3));
      }
    }

    // =====================
    // CAPTURA (CAMERA + GPS)
    // =====================
    async function abrirCaptura() {
      document.getElementById('modalCaptura').classList.add('show');
      gpsCoords = null;

      // Inicia camera
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: 640, height: 480 }
        });
        document.getElementById('videoCaptura').srcObject = videoStream;
      } catch (e) {
        alert('Erro ao acessar camera: ' + e.message);
        fecharCaptura();
        return;
      }

      // Obtem GPS com validao de preciso
      const gpsStatus = document.getElementById('gpsStatus');
      const btnTirarFoto = document.getElementById('btnTirarFoto');
      const PRECISAO_BOA = 100; // metros
      const PRECISAO_MAXIMA = 500; // metros - acima disso  muito impreciso
      let tentativasGps = 0;
      const MAX_TENTATIVAS = 3;

      function tentarObterGps() {
        tentativasGps++;
        gpsStatus.className = 'gps-status';
        gpsStatus.innerHTML = `<i class="bi bi-geo-alt"></i><span>Obtendo localizacao...</span>`;

        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const precisao = Math.round(position.coords.accuracy);
              gpsCoords = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                precisao: precisao,
                aproximada: precisao > PRECISAO_BOA
              };

              if (precisao <= PRECISAO_BOA) {
                // GPS preciso - tudo OK
                gpsStatus.className = 'gps-status success';
                gpsStatus.innerHTML = `<i class="bi bi-check-circle"></i><span>GPS OK (${precisao}m)</span>`;
              } else if (precisao <= PRECISAO_MAXIMA) {
                // GPS aproximado via WiFi
                if (tentativasGps < MAX_TENTATIVAS) {
                  setTimeout(tentarObterGps, 1000);
                  return;
                }
                gpsStatus.className = 'gps-status success';
                gpsStatus.innerHTML = `<i class="bi bi-wifi"></i><span>Localizado via rede (${precisao}m)</span>`;
              } else {
                // Localizao por IP
                if (tentativasGps < MAX_TENTATIVAS) {
                  setTimeout(tentarObterGps, 1000);
                  return;
                }
                gpsStatus.className = 'gps-status success';
                gpsStatus.innerHTML = `<i class="bi bi-globe"></i><span>Localizado via IP</span>`;
                gpsCoords.aproximada = true;
              }
              btnTirarFoto.disabled = false;
            },
            (error) => {
              console.warn('Erro GPS:', error);
              if (tentativasGps < MAX_TENTATIVAS) {
                setTimeout(tentarObterGps, 1000);
                return;
              }
              gpsStatus.className = 'gps-status warning';
              gpsStatus.innerHTML = `<i class="bi bi-geo-alt"></i><span>Localizacao indisponivel</span>`;
              gpsCoords = { latitude: null, longitude: null, precisao: null, aproximada: true, semGps: true };
              btnTirarFoto.disabled = false;
            },
            { enableHighAccuracy: true, timeout: 30000, maximumAge: 60000 }
          );
        } else {
          gpsStatus.className = 'gps-status warning';
          gpsStatus.innerHTML = `<i class="bi bi-geo-alt"></i><span>Localizacao indisponivel</span>`;
          gpsCoords = { latitude: null, longitude: null, precisao: null, aproximada: true, semGps: true };
          btnTirarFoto.disabled = false;
        }
      }

      tentarObterGps();
    }

    function fecharCaptura() {
      document.getElementById('modalCaptura').classList.remove('show');

      // Para camera
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }

      // Restaura botao ao estado original
      const btn = document.getElementById('btnTirarFoto');
      btn.disabled = true; // Comeca desabilitado, GPS vai habilitar
      btn.innerHTML = '<i class="bi bi-camera"></i> Tirar Foto';

      // Reset modo
      modoCaptura = 'ponto';
    }

    async function tirarFoto() {
      // Verifica se  presenca ou ponto ou atendimento
      if (modoCaptura === 'presenca') {
        await tirarFotoPresenca();
        return;
      }

      if (modoCaptura === 'atendimento-inicio' || modoCaptura === 'atendimento-fim') {
        await tirarFotoAtendimento();
        return;
      }

      const video = document.getElementById('videoCaptura');
      const canvas = document.getElementById('canvasCaptura');
      const ctx = canvas.getContext('2d');

      // Configura canvas
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // Espelha a imagem (selfie)
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);

      // Converte para base64
      const fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);

      // Desabilita botao
      const btn = document.getElementById('btnTirarFoto');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';

      const gpsStatus = document.getElementById('gpsStatus');

      try {
        // Registrar ponto com GPS e foto (selfie como prova)
        gpsStatus.className = 'gps-status';
        gpsStatus.innerHTML = '<i class="bi bi-cloud-upload"></i><span>Registrando ponto...</span>';

        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registrando...';
        const payload = {
          foto_base64: fotoBase64
        };

        if (gpsCoords) {
          payload.latitude = gpsCoords.latitude;
          payload.longitude = gpsCoords.longitude;
          payload.precisao_gps = gpsCoords.precisao;
          payload.localizacao_aproximada = gpsCoords.aproximada || false;
          payload.sem_gps = gpsCoords.semGps || false;
        }

        // Verifica se esta offline
        if (!estaOnline()) {
          // Salva na fila offline
          const salvo = salvarFilaOffline(OFFLINE_QUEUE_KEY, payload);
          if (salvo) {
            fecharCaptura();
            mostrarSucessoOffline('Ponto');
            atualizarBadgePendentes();
          } else {
            throw new Error('Erro ao salvar registro offline');
          }
          return;
        }

        const res = await fetch('/api/app/registrar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Erro ao registrar');
        }

        // Sucesso!
        fecharCaptura();
        mostrarSucesso(data.registro);

        // Atualiza dados
        carregarStatus();
        carregarRegistros();
        carregarPresencaConfig(); // Atualiza botao de presenca

      } catch (e) {
        console.error('[Ponto] Erro:', e);
        
        // Detecta erro de rede/servidor
        const isNetworkError = !navigator.onLine || 
          e.name === 'AbortError' ||
          e.name === 'TypeError' ||
          e.message.includes('NetworkError') || 
          e.message.includes('fetch') ||
          e.message.includes('Failed to fetch') ||
          e.message.includes('Network request failed') ||
          e.message.includes('ERR_CONNECTION') ||
          e.message.includes('ECONNREFUSED');
        
        if (isNetworkError) {
          servidorOnline = false;
          atualizarIndicadorConexao();
          
          const salvo = salvarFilaOffline(OFFLINE_QUEUE_KEY, payload);
          if (salvo) {
            fecharCaptura();
            mostrarSucessoOffline('Ponto');
            atualizarBadgePendentes();
            return;
          }
        }
        
        showToast('Erro: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-camera"></i> Tirar Foto';
      }
    }

    function mostrarSucesso(registro) {
      const overlay = document.getElementById('successOverlay');
      document.getElementById('successMessage').textContent = 'Registro realizado!';
      document.getElementById('successSubmessage').textContent = `${registro.tipo} as ${registro.hora}`;

      overlay.classList.add('show');

      // Vibra se possivel
      if (navigator.vibrate) navigator.vibrate(200);

      // Fecha apos 2 segundos
      setTimeout(() => {
        overlay.classList.remove('show');
      }, 2000);
    }

    // Mostra sucesso para registro offline
    function mostrarSucessoOffline(tipo) {
      const overlay = document.createElement('div');
      overlay.className = 'offline-saved-overlay';
      overlay.innerHTML = `
        <i class="bi bi-cloud-arrow-up"></i>
        <h3>${tipo} Salvo Offline</h3>
        <p>Sera sincronizado automaticamente<br>quando a conexao for restabelecida.</p>
        <small style="opacity: 0.7;">${contarPendentes()} registro(s) pendente(s)</small>
      `;
      document.body.appendChild(overlay);

      // Vibra se possivel
      if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

      // Fecha apos 3 segundos
      setTimeout(() => {
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.3s ease';
        setTimeout(() => overlay.remove(), 300);
      }, 3000);
    }

    // =====================
    // PRESENCA (Rondas/Vigilancia)
    // =====================
    let presencaConfig = null;
    let presencaTimer = null;
    let presencaCronometro = null; // Timer do cronometro visual (1 segundo)
    let proximaPresencaHora = null; // Hora alvo para proxima presenca
    let modoCaptura = 'ponto'; // 'ponto' ou 'presenca'

    // Verifica se funcionario esta presente (ultima marcacao foi ENTRADA)
    async function verificarSeEstaPresente() {
      try {
        const res = await fetch('/api/app/registros-hoje');
        const data = await res.json();

        if (!data.registros || data.registros.length === 0) {
          return false; // Sem registros = nao esta presente
        }

        // Pega o ultimo registro
        const ultimoRegistro = data.registros[0]; // Ja vem ordenado desc
        return ultimoRegistro.tipo === 'ENTRADA';
      } catch (e) {
        console.error('Erro ao verificar presenca:', e);
        return false;
      }
    }

    async function carregarPresencaConfig() {
      try {
        const res = await fetch('/api/app/presenca-config');
        const data = await res.json();

        presencaConfig = data;
        const btn = document.getElementById('btnPresenca');
        const navPresencas = document.getElementById('navPresencas');

        // Mostra aba de rondas se funcionario tem presenca configurada
        if (data.ativo && data.intervalo_presenca > 0) {
          navPresencas.style.display = 'flex';
        } else {
          navPresencas.style.display = 'none';
        }

        // S mostra botao de presenca se:
        // 1. Funcionario tem intervalo_presenca configurado
        // 2. Funcionario esta "dentro" (ultima marcacao foi ENTRADA)
        const estaPresente = await verificarSeEstaPresente();

        if (data.ativo && data.intervalo_presenca > 0 && estaPresente) {
          btn.classList.add('visible');
          verificarStatusPresenca();
          // Verificar dados da API a cada 30 segundos
          if (presencaTimer) clearInterval(presencaTimer);
          presencaTimer = setInterval(verificarStatusPresenca, 30000);
          // Cronometro visual atualiza a cada segundo
          if (presencaCronometro) clearInterval(presencaCronometro);
          presencaCronometro = setInterval(atualizarCronometroPresenca, 1000);
        } else {
          btn.classList.remove('visible');
          if (presencaTimer) {
            clearInterval(presencaTimer);
            presencaTimer = null;
          }
          if (presencaCronometro) {
            clearInterval(presencaCronometro);
            presencaCronometro = null;
          }
        }
      } catch (e) {
        console.error('Erro ao carregar config presenca:', e);
      }
    }

    let ultimoEstadoPresenca = null; // Para detectar mudanca de estado
    let notificacaoEnviada = false; // Evita multiplas notificacoes

    // Funcao que busca dados da API e calcula hora alvo
    async function verificarStatusPresenca() {
      if (!presencaConfig || !presencaConfig.ativo) return;

      try {
        const res = await fetch('/api/app/ultima-presenca');
        const data = await res.json();

        if (!data.ultima_presenca) {
          // Nunca marcou presenca hoje - usa hora da ENTRADA como base
          if (!data.primeira_entrada) {
            proximaPresencaHora = null;
            return;
          }
          const horaEntrada = new Date(data.primeira_entrada);
          const intervaloMs = presencaConfig.intervalo_presenca * 60000;
          proximaPresencaHora = new Date(horaEntrada.getTime() + intervaloMs);
        } else {
          const ultimaHora = new Date(data.ultima_presenca.data_hora);
          const intervaloMs = presencaConfig.intervalo_presenca * 60000;
          proximaPresencaHora = new Date(ultimaHora.getTime() + intervaloMs);
        }

        // Atualiza cronometro imediatamente
        atualizarCronometroPresenca();
      } catch (e) {
        console.error('Erro ao verificar presenca:', e);
      }
    }

    // Funcao que atualiza o cronometro visual a cada segundo
    function atualizarCronometroPresenca() {
      const btn = document.getElementById('btnPresenca');
      const timer = document.getElementById('presencaTimer');
      const status = document.getElementById('presencaStatus');

      if (!btn || !timer || !status) return;

      // Guarda estado anterior
      const estadoAnterior = ultimoEstadoPresenca;

      // Remove classes de estado
      btn.classList.remove('atrasado', 'aguardando', 'liberado');

      // Se nao tem hora alvo, aguarda entrada
      if (!proximaPresencaHora) {
        btn.classList.add('aguardando');
        timer.textContent = 'Aguardando entrada';
        status.textContent = '';
        ultimoEstadoPresenca = 'aguardando';
        return;
      }

      const agora = new Date();
      const faltaMs = proximaPresencaHora - agora;

      if (faltaMs <= 0) {
        // ATRASADO - tempo esgotou
        const atrasoMs = Math.abs(faltaMs);
        const atrasoMin = Math.floor(atrasoMs / 60000);
        const atrasoSeg = Math.floor((atrasoMs % 60000) / 1000);

        // Se passou de 10 minutos de atraso, avanca para proximo horario futuro
        if (atrasoMin >= 10) {
          const intervaloMs = presencaConfig.intervalo_presenca * 60000;
          
          // Avanca ate encontrar um horario que ainda nao passou 10 minutos
          while (proximaPresencaHora && (agora - proximaPresencaHora) > 10 * 60000) {
            proximaPresencaHora = new Date(proximaPresencaHora.getTime() + intervaloMs);
          }
          
          notificacaoEnviada = false;
          ultimoEstadoPresenca = 'aguardando';
          console.log('[Presenca] Avancado para proximo horario valido:', proximaPresencaHora);
          // Nao chama recursivamente - deixa o proximo tick do setInterval atualizar
          return;
        }

        btn.classList.add('atrasado');
        timer.textContent = `ATRASADO -${String(atrasoMin).padStart(2, '0')}:${String(atrasoSeg).padStart(2, '0')}`;
        status.textContent = 'MARQUE AGORA!';
        ultimoEstadoPresenca = 'atrasado';

        // Envia notificacao e vibra (apenas uma vez)
        if (!notificacaoEnviada) {
          enviarNotificacaoPresenca();
          notificacaoEnviada = true;
        }
      } else if (faltaMs <= 30000) {
        // LIBERADO - faltam 30 segundos ou menos
        const faltaSeg = Math.floor(faltaMs / 1000);
        btn.classList.add('liberado');
        timer.textContent = `00:${String(faltaSeg).padStart(2, '0')}`;
        status.textContent = 'LIBERADO - Marque agora!';

        if (estadoAnterior === 'aguardando') {
          enviarAlertaLiberado();
        }
        ultimoEstadoPresenca = 'liberado';
        notificacaoEnviada = false; // Reset para proxima vez
      } else {
        // AGUARDANDO - mostra cronometro regressivo
        const faltaMin = Math.floor(faltaMs / 60000);
        const faltaSeg = Math.floor((faltaMs % 60000) / 1000);

        btn.classList.add('aguardando');
        timer.textContent = `${String(faltaMin).padStart(2, '0')}:${String(faltaSeg).padStart(2, '0')}`;
        status.textContent = 'Aguarde...';
        ultimoEstadoPresenca = 'aguardando';
        notificacaoEnviada = false;
      }
    }

    // Registra presenca nao marcada no servidor
    async function registrarFaltaPresenca(horaAlvo) {
      try {
        console.log('[Presenca] Registrando falta para hora:', horaAlvo);
        await fetch('/api/app/presencas/registrar-falta', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            hora_alvo: horaAlvo.toISOString(),
            motivo: 'NAO_MARCADA'
          })
        });
        console.log('[Presenca] Falta registrada com sucesso');
      } catch (e) {
        console.error('[Presenca] Erro ao registrar falta:', e);
      }
    }

    function enviarAlertaLiberado() {
      console.log('[Presenca] Enviando alerta LIBERADO');

      // Usa interface nativa do Android se disponivel
      if (window.AndroidApp) {
        try {
          window.AndroidApp.vibrate('200,100,200,100,200');
          window.AndroidApp.showNotification('Hora de Marcar Presenca!', 'O tempo chegou! Marque sua presenca agora.');
          console.log('[Presenca] Alerta nativo enviado');
        } catch(e) {
          console.error('[Presenca] Erro no alerta nativo:', e);
        }
      } else {
        // Fallback para navegador
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Hora de Marcar Presenca!', {
            body: 'O tempo chegou! Marque sua presenca agora.',
            icon: '/icons/icon-192.png',
            vibrate: [200, 100, 200],
            tag: 'presenca-liberada'
          });
        }
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      }
    }

    function enviarNotificacaoPresenca() {
      console.log('[Presenca] Enviando alerta ATRASADO');

      // Usa interface nativa do Android se disponivel
      if (window.AndroidApp) {
        try {
          window.AndroidApp.vibrate('500,200,500,200,500');
          window.AndroidApp.showNotification('MARCAR PRESENCA AGORA!', 'Voce esta ATRASADO para marcar presenca!');
          console.log('[Presenca] Alerta ATRASADO nativo enviado');
        } catch(e) {
          console.error('[Presenca] Erro no alerta nativo:', e);
        }
      } else {
        // Fallback para navegador
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Marcar Presenca!', {
            body: 'Voce esta atrasado para marcar presenca',
            icon: '/icons/icon-192.png',
            vibrate: [200, 100, 200, 100, 200],
            requireInteraction: true
          });
        }
        if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
      }
    }

    function abrirCapturaPresenca() {
      const btn = document.getElementById('btnPresenca');
      // Nao permite abrir se estiver aguardando
      if (btn.classList.contains('aguardando')) {
        return;
      }
      modoCaptura = 'presenca';
      abrirCaptura();
    }

    async function tirarFotoPresenca() {
      const btn = document.getElementById('btnTirarFoto');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registrando...';

      try {
        const canvas = document.getElementById('canvasCaptura');
        const video = document.getElementById('videoCaptura');
        const ctx = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0);

        const foto = canvas.toDataURL('image/jpeg', 0.8);

        const payload = {
          foto_base64: foto,
          latitude: gpsCoords?.latitude,
          longitude: gpsCoords?.longitude,
          precisao_gps: gpsCoords?.accuracy
        };

        // Verifica se esta offline
        if (!estaOnline()) {
          const salvo = salvarFilaOffline(OFFLINE_PRESENCA_KEY, payload);
          if (salvo) {
            fecharCaptura();
            mostrarSucessoOffline('Presenca');
            atualizarBadgePendentes();
            modoCaptura = 'ponto';
          } else {
            throw new Error('Erro ao salvar presenca offline');
          }
          return;
        }

        const response = await fetch('/api/app/marcar-presenca', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erro ao registrar presenca');
        }

        fecharCaptura();
        mostrarSucessoPresenca(data);

        // Fora estado aguardando imediatamente aps registrar
        const btnPresenca = document.getElementById('btnPresenca');
        const timerEl = document.getElementById('presencaTimer');
        const statusEl = document.getElementById('presencaStatus');
        btnPresenca.classList.remove('atrasado', 'liberado');
        btnPresenca.classList.add('aguardando');
        timerEl.textContent = `Aguarde ate ${data.proxima_hora}`;
        statusEl.textContent = `(${presencaConfig.intervalo_presenca} min)`;
        ultimoEstadoPresenca = 'aguardando';

        // Atualiza estado aps um delay para garantir que DB atualizou
        setTimeout(() => verificarStatusPresenca(), 2000);
        modoCaptura = 'ponto'; // Reset

      } catch (e) {
        // Se erro de rede, tenta salvar offline
        if (!estaOnline() || e.message.includes('NetworkError') || e.message.includes('fetch')) {
          const payload = {
            foto_base64: document.getElementById('canvasCaptura').toDataURL('image/jpeg', 0.8),
            latitude: gpsCoords?.latitude,
            longitude: gpsCoords?.longitude,
            precisao_gps: gpsCoords?.accuracy
          };
          const salvo = salvarFilaOffline(OFFLINE_PRESENCA_KEY, payload);
          if (salvo) {
            fecharCaptura();
            mostrarSucessoOffline('Presenca');
            atualizarBadgePendentes();
            modoCaptura = 'ponto';
            return;
          }
        }
        showToast('Erro: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-camera"></i> Tirar Foto';
        modoCaptura = 'ponto';
      }
    }

    function mostrarSucessoPresenca(data) {
      const overlay = document.getElementById('successOverlay');
      document.getElementById('successMessage').textContent = 'Presenca registrada!';
      document.getElementById('successSubmessage').textContent = `Proxima as ${data.proxima_hora}`;

      overlay.classList.add('show');
      if (navigator.vibrate) navigator.vibrate(200);

      setTimeout(() => {
        overlay.classList.remove('show');
      }, 2000);
    }

    // =====================
    // FOTO ATENDIMENTO
    // =====================
    async function tirarFotoAtendimento() {
      const btn = document.getElementById('btnTirarFoto');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registrando...';

      try {
        const canvas = document.getElementById('canvasCaptura');
        const video = document.getElementById('videoCaptura');
        const ctx = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0);

        const foto = canvas.toDataURL('image/jpeg', 0.8);

        if (modoCaptura === 'atendimento-inicio') {
          await iniciarAtendimento(foto);
        } else if (modoCaptura === 'atendimento-fim') {
          await finalizarAtendimento(foto);
        }

        modoCaptura = 'ponto'; // Reset

      } catch (e) {
        showToast('Erro: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-camera"></i> Tirar Foto';
        modoCaptura = 'ponto';
      }
    }

    // Solicitar permissao de notificacao
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // =====================
    // PAGINA DE PRESENCAS
    // =====================
    let presencasMap = null;
    let presencasMarkers = [];

    async function carregarPresencasPage() {
      try {
        const res = await fetch('/api/app/presencas-hoje');
        const data = await res.json();

        const container = document.getElementById('presencasListContent');
        const countEl = document.getElementById('presencasCount');
        const mapContainer = document.getElementById('presencasMapContainer');

        const presencas = data.presencas || [];

        if (presencas.length === 0) {
          countEl.textContent = 'Nenhuma ronda hoje';
          container.innerHTML = `
            <div class="empty-presencas">
              <i class="bi bi-shield-exclamation"></i>
              <p>Nenhuma ronda registrada hoje</p>
            </div>
          `;
          mapContainer.innerHTML = '<div class="empty-presencas"><i class="bi bi-map"></i></div>';
          return;
        }

        countEl.textContent = presencas.length + ' ronda(s) hoje';

        // Renderiza lista
        container.innerHTML = presencas.map(p => {
          const hora = new Date(p.data_hora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          const temGps = p.latitude && p.longitude;
          return `
            <div class="presenca-item" ${temGps ? `onclick="centralizarNoMapa(${p.latitude}, ${p.longitude})"` : ''}>
              <div class="presenca-icon">
                <i class="bi bi-shield-check"></i>
              </div>
              <div class="presenca-info">
                <div class="presenca-hora">${hora}</div>
                <div class="presenca-local">
                  ${temGps ? '<i class="bi bi-geo-alt"></i> Com localizacao' : '<i class="bi bi-geo-alt-fill text-muted"></i> Sem GPS'}
                </div>
              </div>
              ${p.foto_registro ? `<img src="${p.foto_registro}" class="presenca-foto" onclick="event.stopPropagation(); abrirFoto('${p.foto_registro}')" alt="Foto">` : ''}
            </div>
          `;
        }).join('');

        // Inicializa/atualiza mapa
        const presencasComGps = presencas.filter(p => p.latitude && p.longitude);

        if (presencasComGps.length > 0) {
          if (!presencasMap) {
            presencasMap = L.map('presencasMapContainer').setView(
              [presencasComGps[0].latitude, presencasComGps[0].longitude],
              15
            );
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap'
            }).addTo(presencasMap);
          }

          // Limpa markers antigos
          presencasMarkers.forEach(m => presencasMap.removeLayer(m));
          presencasMarkers = [];

          // Adiciona novos markers
          presencasComGps.forEach((p, i) => {
            const hora = new Date(p.data_hora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const marker = L.marker([p.latitude, p.longitude])
              .addTo(presencasMap)
              .bindPopup(`<b>Ronda ${i + 1}</b><br>${hora}`);
            presencasMarkers.push(marker);
          });

          // Ajusta visualizacao para mostrar todos os pontos
          if (presencasComGps.length > 1) {
            const bounds = L.latLngBounds(presencasComGps.map(p => [p.latitude, p.longitude]));
            presencasMap.fitBounds(bounds, { padding: [20, 20] });
          }

          // Forca refresh do mapa (fix para containers hidden)
          setTimeout(() => presencasMap.invalidateSize(), 100);
        } else {
          mapContainer.innerHTML = '<div class="empty-presencas" style="height:100%;display:flex;align-items:center;justify-content:center;"><i class="bi bi-map"></i></div>';
        }
      } catch (e) {
        console.error('Erro ao carregar presencas:', e);
      }
    }

    function centralizarNoMapa(lat, lng) {
      if (presencasMap) {
        presencasMap.setView([lat, lng], 17);
      }
    }

    function abrirFoto(src) {
      // Cria modal overlay para exibir a foto
      const overlay = document.createElement('div');
      overlay.id = 'fotoModal';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.95);
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;

      // Botao de fechar
      const btnFechar = document.createElement('button');
      btnFechar.innerHTML = '<i class="bi bi-x-lg"></i> Fechar';
      btnFechar.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        z-index: 100000;
        display: flex;
        align-items: center;
        gap: 8px;
      `;
      btnFechar.onclick = () => overlay.remove();

      // Imagem
      const img = document.createElement('img');
      img.src = src;
      img.style.cssText = `
        max-width: 100%;
        max-height: calc(100vh - 100px);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      `;

      // Texto de instrucao
      const texto = document.createElement('div');
      texto.textContent = 'Toque fora da imagem ou no botao para fechar';
      texto.style.cssText = `
        color: #999;
        margin-top: 15px;
        font-size: 14px;
      `;

      overlay.appendChild(btnFechar);
      overlay.appendChild(img);
      overlay.appendChild(texto);

      // Fechar ao clicar fora da imagem
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };

      document.body.appendChild(overlay);
    }

    // =====================
    // LOGOUT
    // =====================
    async function logout() {
      await fetch('/api/app/logout', { method: 'POST' });
      usuario = null;
      if (presencaTimer) clearInterval(presencaTimer);
      mostrarLogin();
    }

    document.getElementById('btnLogout').addEventListener('click', logout);

    // =====================
    
    // Prevenir pull-to-refresh
    let lastTouchY = 0;
    document.addEventListener('touchstart', function(e) {
      lastTouchY = e.touches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
      const touchY = e.touches[0].clientY;
      const touchYDelta = touchY - lastTouchY;
      
      // Se est no topo e tentando puxar para baixo
      if (window.scrollY === 0 && touchYDelta > 0) {
        // Verifica se o elemento tem scroll prprio
        const target = e.target;
        const scrollableParent = target.closest('.page-content, .modal-content, [data-scrollable]');
        if (!scrollableParent || scrollableParent.scrollTop === 0) {
          e.preventDefault();
        }
      }
      lastTouchY = touchY;
    }, { passive: false });

    // INICIALIZACAO
    // =====================
    carregarUsuario();

    // Service Worker para PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => {
        console.log('SW error:', err);
      });
    }

    // =====================
    // MODO OFFLINE (Browser)
    // =====================
    let isOfflineMode = false;
    let offlineUserInfo = null;
    let nextTipo = "ENTRADA";
    let offlineClockInterval = null;

    function checkOnlineStatus() { return navigator.onLine; }

    function updateOfflineClock() {
      const now = new Date();
      const timeEl = document.getElementById("offlineTime");
      const dateEl = document.getElementById("offlineDate");
      if (timeEl) timeEl.textContent = now.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
      if (dateEl) dateEl.textContent = now.toLocaleDateString("pt-BR", { weekday: "long", day: "numeric", month: "long" });
    }

    async function saveUserInfoToSW(userInfo) {
      if (!navigator.serviceWorker || !navigator.serviceWorker.controller) return;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        channel.port1.onmessage = (e) => { if (e.data.type === "USER_INFO_SAVED") resolve(e.data.success); };
        navigator.serviceWorker.controller.postMessage({ type: "SAVE_USER_INFO", userInfo }, [channel.port2]);
      });
    }

    async function getUserInfoFromSW() {
      if (!navigator.serviceWorker || !navigator.serviceWorker.controller) return null;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        channel.port1.onmessage = (e) => { if (e.data.type === "USER_INFO") resolve(e.data.userInfo); };
        navigator.serviceWorker.controller.postMessage({ type: "GET_USER_INFO" }, [channel.port2]);
        setTimeout(() => resolve(null), 3000);
      });
    }

    async function savePontoOfflineToSW(ponto) {
      if (!navigator.serviceWorker || !navigator.serviceWorker.controller) return null;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        channel.port1.onmessage = (e) => { if (e.data.type === "OFFLINE_PONTO_SAVED") resolve(e.data.success ? e.data.id : null); };
        navigator.serviceWorker.controller.postMessage({ type: "SAVE_OFFLINE_PONTO", ponto }, [channel.port2]);
        setTimeout(() => resolve(null), 3000);
      });
    }

    async function getLastPontoFromSW() {
      if (!navigator.serviceWorker || !navigator.serviceWorker.controller) return null;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        channel.port1.onmessage = (e) => { if (e.data.type === "LAST_PONTO") resolve(e.data.ponto); };
        navigator.serviceWorker.controller.postMessage({ type: "GET_LAST_PONTO" }, [channel.port2]);
        setTimeout(() => resolve(null), 3000);
      });
    }

    async function getPendingCountFromSW() {
      if (!navigator.serviceWorker || !navigator.serviceWorker.controller) return 0;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        channel.port1.onmessage = (e) => { if (e.data.type === "PENDING_COUNT") resolve(e.data.count); };
        navigator.serviceWorker.controller.postMessage({ type: "GET_PENDING_COUNT" }, [channel.port2]);
        setTimeout(() => resolve(0), 3000);
      });
    }

    async function mostrarOffline() {
      isOfflineMode = true;
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("appSection").classList.add("hidden");
      document.getElementById("offlineSection").classList.add("active");
      document.getElementById("bottomNav").style.display = "none";
      document.getElementById("btnLogout").style.display = "none";
      if (offlineUserInfo) document.getElementById("offlineUserName").textContent = offlineUserInfo.nome || "Usuario";
      const lastPonto = await getLastPontoFromSW();
      nextTipo = (lastPonto && lastPonto.tipo === "ENTRADA") ? "SAIDA" : "ENTRADA";
      document.getElementById("offlineTipoLabel").textContent = nextTipo;
      const pendingCount = await getPendingCountFromSW();
      const pendingEl = document.getElementById("offlinePending");
      const countEl = document.getElementById("offlinePendingCount");
      if (pendingCount > 0) { pendingEl.style.display = "block"; countEl.textContent = pendingCount; } else { pendingEl.style.display = "none"; }
      updateOfflineClock();
      if (offlineClockInterval) clearInterval(offlineClockInterval);
      offlineClockInterval = setInterval(updateOfflineClock, 1000);
      console.log("[Offline] Modo offline ativado");
    }

    function esconderOffline() {
      isOfflineMode = false;
      document.getElementById("offlineSection").classList.remove("active");
      if (offlineClockInterval) { clearInterval(offlineClockInterval); offlineClockInterval = null; }
    }

    async function registrarPontoOffline() {
      if (!offlineUserInfo) { alert("Dados do usuario nao disponiveis"); return; }
      const btn = document.getElementById("btnOfflinePonto");
      btn.disabled = true;
      try {
        const now = new Date();
        const ponto = { cpf: offlineUserInfo.cpf || "", matricula: offlineUserInfo.matricula || "", tipo: nextTipo, dataHora: now.toISOString(), latitude: 0, longitude: 0, offlineId: "browser_" + Date.now() };
        if (navigator.geolocation) {
          try {
            const pos = await new Promise((resolve, reject) => { navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 30000, maximumAge: 60000 }); });
            ponto.latitude = pos.coords.latitude;
            ponto.longitude = pos.coords.longitude;
          } catch (e) { console.log("[Offline] Nao foi possivel obter localizacao"); }
        }
        const id = await savePontoOfflineToSW(ponto);
        if (id) {
          console.log("[Offline] Ponto salvo com ID:", id);
          document.getElementById("offlineSuccess").classList.add("show");
          setTimeout(() => { document.getElementById("offlineSuccess").classList.remove("show"); }, 3000);
          nextTipo = nextTipo === "ENTRADA" ? "SAIDA" : "ENTRADA";
          document.getElementById("offlineTipoLabel").textContent = nextTipo;
          const pendingCount = await getPendingCountFromSW();
          document.getElementById("offlinePending").style.display = "block";
          document.getElementById("offlinePendingCount").textContent = pendingCount;
          if ("serviceWorker" in navigator) { navigator.serviceWorker.ready.then(reg => { if (reg.sync) reg.sync.register("sync-pontos"); }); }
        } else { alert("Erro ao salvar ponto offline"); }
      } catch (e) { console.error("[Offline] Erro ao registrar ponto:", e); alert("Erro ao registrar ponto: " + e.message); }
      finally { btn.disabled = false; }
    }

    async function handleConnectionChange() {
      const online = checkOnlineStatus();
      console.log("[Offline] Status de conexao:", online ? "Online" : "Offline");
      if (online) {
        if (isOfflineMode) {
          esconderOffline();
          if (navigator.serviceWorker && navigator.serviceWorker.controller) navigator.serviceWorker.controller.postMessage({ type: "SYNC_NOW" });
          location.reload();
        }
      } else {
        offlineUserInfo = await getUserInfoFromSW();
        if (offlineUserInfo) { mostrarOffline(); }
        else { mostrarLogin(); document.getElementById("loginMsg").textContent = "Sem conexao. Faca login quando estiver online."; }
      }
    }

    window.addEventListener("online", handleConnectionChange);
    window.addEventListener("offline", handleConnectionChange);

    if (navigator.serviceWorker) {
      navigator.serviceWorker.addEventListener("message", (event) => {
        if (event.data.type === "SYNC_COMPLETE") {
          console.log("[Offline] Sincronizacao completa:", event.data);
          getPendingCountFromSW().then(count => {
            const pendingEl = document.getElementById("offlinePending");
            const countEl = document.getElementById("offlinePendingCount");
            if (pendingEl && countEl) { if (count > 0) { pendingEl.style.display = "block"; countEl.textContent = count; } else { pendingEl.style.display = "none"; } }
          });
        }
      });
    }

    // Modifica carregarUsuario original para salvar no SW e verificar offline
    const originalCarregarUsuario = carregarUsuario;
    carregarUsuario = async function() {
      if (!checkOnlineStatus()) {
        offlineUserInfo = await getUserInfoFromSW();
        if (offlineUserInfo) { mostrarOffline(); return; }
      }
      try {
        await originalCarregarUsuario();
        if (usuario) {
          await saveUserInfoToSW({ nome: usuario.nome, cpf: usuario.cpf || "", matricula: usuario.matricula || "", cargo: usuario.cargo || "", funcionario_id: usuario.id });
        }
      } catch (e) {
        if (!checkOnlineStatus()) {
          offlineUserInfo = await getUserInfoFromSW();
          if (offlineUserInfo) { mostrarOffline(); return; }
        }
        throw e;
      }
    };

  
    // Dark Mode
    function toggleDarkMode() {
      const body = document.body;
      const icon = document.getElementById('darkModeIcon');
      
      body.classList.toggle('dark-mode');
      
      if (body.classList.contains('dark-mode')) {
        icon.className = 'bi bi-sun-fill';
        localStorage.setItem('darkMode', 'true');
      } else {
        icon.className = 'bi bi-moon-fill';
        localStorage.setItem('darkMode', 'false');
      }
    }

    // Carregar preferncia salva
    function loadDarkMode() {
      const darkMode = localStorage.getItem('darkMode');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (darkMode === 'true' || (darkMode === null && prefersDark)) {
        document.body.classList.add('dark-mode');
        const icon = document.getElementById('darkModeIcon');
        if (icon) icon.className = 'bi bi-sun-fill';
      }
    }

    // Carregar dark mode ao iniciar
    document.addEventListener('DOMContentLoaded', loadDarkMode);

</script>

    <!-- Modal de Logout -->
    <div id="modalLogout" class="modal-overlay" style="display: none;">
      <div class="modal-logout-container">
        <div class="modal-logout-icon">
          <i class="bi bi-box-arrow-right"></i>
        </div>
        <h3 class="modal-logout-title">Sair da Conta</h3>
        <p class="modal-logout-text">Deseja realmente sair da sua conta?</p>
        <div class="modal-logout-buttons">
          <button class="modal-logout-btn-cancel" onclick="fecharModalLogout()">
            Cancelar
          </button>
          <button class="modal-logout-btn-confirm" onclick="confirmarLogout()">
            Sair
          </button>
        </div>
      </div>
    </div>

  </body>
</html>
