<!DOCTYPE html>
<html lang="pt-BR">
<head>
  @include('partials/head')
</head>
<body>
  <div class="d-flex">
    @include('partials/sidebar')

    <div class="main-content flex-grow-1">
      @include('partials/navbar')

      <main class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h4 class="section-title mb-1">
              <i class="bi bi-shield-check me-2"></i>Auditoria
            </h4>
            <p class="text-muted mb-0">Registro de acoes do sistema</p>
          </div>
          <button class="btn btn-outline-primary" onclick="exportarLogs()">
            <i class="bi bi-download me-2"></i>Exportar
          </button>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
          <div class="card-body">
            <form class="row g-3" id="formFiltros">
              <div class="col-md-3">
                <label class="form-label">Usuario</label>
                <select class="form-select" name="usuario_id">
                  <option value="">Todos</option>
                  @if(usuarios)
                    @each(usuario in usuarios)
                      <option value="{{ usuario.id }}">{{ usuario.nome }}</option>
                    @end
                  @end
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Acao</label>
                <select class="form-select" name="acao">
                  <option value="">Todas</option>
                  <option value="login">Login</option>
                  <option value="logout">Logout</option>
                  <option value="criar">Criar</option>
                  <option value="editar">Editar</option>
                  <option value="excluir">Excluir</option>
                  <option value="votacao">Votacao</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Data Inicio</label>
                <input type="date" class="form-control" name="data_inicio">
              </div>
              <div class="col-md-2">
                <label class="form-label">Data Fim</label>
                <input type="date" class="form-control" name="data_fim">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                  <i class="bi bi-search me-2"></i>Filtrar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Logs -->
        <div class="card">
          <div class="card-body">
            <table class="table table-hover" id="tabelaLogs">
              <thead>
                <tr>
                  <th>Data/Hora</th>
                  <th>Usuario</th>
                  <th>Acao</th>
                  <th>Recurso</th>
                  <th>Detalhes</th>
                  <th>IP</th>
                </tr>
              </thead>
              <tbody>
                @if(logs && logs.length > 0)
                  @each(log in logs)
                    <tr>
                      <td>
                        <small>{{ log.data_formatada }}</small>
                      </td>
                      <td>{{ log.usuario?.nome || 'Sistema' }}</td>
                      <td>
                        @if(log.acao === 'login')
                          <span class="badge bg-success">Login</span>
                        @elseif(log.acao === 'logout')
                          <span class="badge bg-secondary">Logout</span>
                        @elseif(log.acao === 'criar')
                          <span class="badge bg-primary">Criar</span>
                        @elseif(log.acao === 'editar')
                          <span class="badge bg-warning">Editar</span>
                        @elseif(log.acao === 'excluir')
                          <span class="badge bg-danger">Excluir</span>
                        @elseif(log.acao === 'votacao')
                          <span class="badge bg-info">Votacao</span>
                        @else
                          <span class="badge bg-secondary">{{ log.acao }}</span>
                        @end
                      </td>
                      <td>{{ log.recurso }}</td>
                      <td>
                        @if(log.detalhes)
                          <button class="btn btn-sm btn-outline-secondary" onclick="verDetalhes('{{ log.detalhes }}')">
                            <i class="bi bi-eye"></i>
                          </button>
                        @else
                          -
                        @end
                      </td>
                      <td><small class="text-muted">{{ log.ip || '-' }}</small></td>
                    </tr>
                  @end
                @else
                  <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                      <i class="bi bi-journal-text fs-1"></i>
                      <p class="mb-0 mt-2">Nenhum registro encontrado</p>
                    </td>
                  </tr>
                @end
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  @include('partials/scripts')

  <script>
    function verDetalhes(detalhes) {
      try {
        const obj = JSON.parse(detalhes);
        alert(JSON.stringify(obj, null, 2));
      } catch {
        alert(detalhes);
      }
    }

    function exportarLogs() {
      toastr.info('Funcionalidade em desenvolvimento');
    }
  </script>
</body>
</html>
