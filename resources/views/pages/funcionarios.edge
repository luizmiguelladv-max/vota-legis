@component('layouts/main')
  @slot('content')
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="mb-1">Funcion√°rios</h4>
        <p class="text-muted mb-0">Gerenciamento de {{ entidade?.tipo === 'PRIVADA' ? 'colaboradores' : 'funcion√°rios' }}</p>
      </div>
      @if(['ADMIN', 'RH'].includes(usuario?.perfil) || isSuperAdmin)
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalFuncionario" onclick="novoFuncionario()">
          <i class="bi bi-plus-lg me-2"></i>Novo Funcion√°rio
        </button>
        <button class="btn btn-outline-success" id="btnSincronizarTudo" onclick="sincronizarTudo(this)" style="margin-left: 20px;">
          <i class="bi bi-broadcast me-2"></i>Sincronizar Coletores
        </button>
      @endif
    </div>

    {{-- Filtros com Select2 e filtragem autom√°tica --}}
    {{-- Terminologia baseada no tipo de entidade --}}
    @let(isPrivada = entidade?.tipo === 'PRIVADA')
    @let(labelUnidade = isPrivada ? 'Unidade' : 'Unidade Gestora')
    @let(labelSecretaria = isPrivada ? 'Departamento' : 'Secretaria')
    @let(labelLotacao = isPrivada ? 'Setor' : 'Lota√ß√£o')

    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label">{{ labelUnidade }}</label>
            <select class="form-select filtro-select2" id="filtroUnidadeGestora">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">{{ labelSecretaria }}</label>
            <select class="form-select filtro-select2" id="filtroSecretaria">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">{{ labelLotacao }}</label>
            <select class="form-select filtro-select2" id="filtroLotacao">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Cargo</label>
            <select class="form-select filtro-select2" id="filtroCargo">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">V√≠nculo</label>
            <select class="form-select filtro-select2" id="filtroVinculo">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Jornada</label>
            <select class="form-select filtro-select2" id="filtroJornada">
              <option value="">Todas</option>
              <option value="sem_jornada"><i class="bi bi-exclamation-triangle text-warning"></i> Sem Jornada</option>
            </select>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-2">
            <label class="form-label">Status</label>
            <select class="form-select filtro-select2" id="filtroStatus">
              <option value="">Todos</option>
              <option value="true">Ativos</option>
              <option value="false">Inativos</option>
            </select>
          </div>
          <div class="col-md-10 d-flex align-items-end">
            <button class="btn btn-outline-secondary me-2" onclick="limparFiltros()">
              <i class="bi bi-x-lg me-1"></i>Limpar
            </button>
          </div>
        </div>
      </div>
    </div>

    {{-- Barra de A√ß√µes em Massa --}}
    <div class="card mb-3 d-none" id="barraAcoesMassa">
      <div class="card-body py-2 d-flex align-items-center justify-content-between">
        <div>
          <span class="badge bg-primary me-2" id="qtdSelecionados">0</span>
          <span>funcion√°rio(s) selecionado(s)</span>
        </div>
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm" id="tipoJornadaMassa" style="width: 140px;" onchange="filtrarJornadasMassa()">
            <option value="">Tipo</option>
            <option value="NORMAL"><i class="bi bi-calendar"></i> Normal</option>
            <option value="PLANTAO">üè• Plant√£o</option>
            <option value="CORRIDA">‚ö° Corrida</option>
          </select>
          <select class="form-select form-select-sm" id="jornadaMassa" style="width: 200px;">
            <option value="">Selecione a jornada</option>
          </select>
          <button class="btn btn-primary btn-sm" onclick="vincularJornadaMassa()">
            <i class="bi bi-clock me-1"></i>Vincular √† Jornada
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="desmarcarTodos()">
            <i class="bi bi-x-lg me-1"></i>Desmarcar Todos
          </button>
        </div>
      </div>
    </div>

    {{-- Tabela --}}
    <div class="card">
      <div class="card-body">
        <table id="tabelaFuncionarios" class="table table-hover" style="width:100%">
          <thead>
            <tr>
              <th style="width:30px"><input type="checkbox" id="checkAll" onclick="toggleCheckAll(this)"></th>
              <th>Matr√≠cula</th>
              <th>Nome</th>
              <th>CPF</th>
              <th>Cargo</th>
              <th>{{ labelLotacao }}</th>
              <th>V√≠nculo</th>
              <th>Jornada</th>
              <th>REP</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    {{-- Modal de Progresso de Sincroniza√ß√£o --}}
    <div class="modal fade" id="modalProgresso" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title"><i class="bi bi-cloud-arrow-up-fill me-2"></i>Sincronizando com REP</h5>
          </div>
          <div class="modal-body text-center py-4">
            <div class="progress mb-3" style="height: 25px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   id="progressoSincronizacao" 
                   role="progressbar" 
                   style="width: 0%"
                   aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <p id="textoProgresso" class="mb-0 text-muted">Iniciando sincroniza√ß√£o...</p>
            
            <div id="logSincronizacaoContainer" class="mt-3 text-start bg-dark p-2 rounded border border-secondary" style="height: 150px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85em; display: none;">
                <div class="text-success">> Conectando...</div>
            </div>

            <small class="text-muted mt-2 d-block">Por favor, n√£o feche esta p√°gina.</small>
            
            <button id="btnFecharModalProgresso" type="button" class="btn btn-secondary btn-sm mt-3" data-bs-dismiss="modal" style="display: none;">
                Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    {{-- Modal de Digitais --}}
    <div class="modal fade" id="modalDigitais" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-fingerprint me-2"></i>Digitais - <span id="digitaisNomeFuncionario"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="digitaisFuncionarioId">

            {{-- Status do Leitor USB --}}
            <div id="statusLeitorUSB" class="alert alert-secondary small mb-3 d-flex align-items-center justify-content-between">
              <span>
                <i class="bi bi-usb-symbol me-2"></i>
                <span id="statusLeitorTexto">Verificando leitor biom√©trico...</span>
              </span>
              <span id="statusLeitorBadge" class="badge bg-secondary">Aguarde</span>
            </div>

            {{-- Dica sobre m√∫ltiplas amostras --}}
            <div class="alert alert-info small mb-3">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Dica:</strong> Cadastre 3 amostras de cada dedo para melhor reconhecimento.
              Varie a posi√ß√£o e press√£o do dedo em cada captura.
            </div>

            {{-- 3 Slots de Digitais --}}
            <div class="row g-3 mb-4" id="digitaisSlotsContainer">
              {{-- Slot 1 --}}
              <div class="col-md-4">
                <div class="card h-100 digital-slot" data-dedo="1">
                  <div class="card-body text-center py-4">
                    <div class="digital-icon mb-3">
                      <i class="bi bi-fingerprint display-1 text-muted" id="iconeDedo1"></i>
                    </div>
                    <h6 class="mb-1">Digital 1</h6>
                    <small class="text-muted d-block mb-3" id="statusDedo1">N√£o cadastrada</small>
                    <button class="btn btn-success btn-sm" id="btnCadastrarDedo1" onclick="capturarDigitalUSB(1)">
                      <i class="bi bi-plus-lg me-1"></i>Cadastrar
                    </button>
                    <button class="btn btn-outline-danger btn-sm d-none" id="btnExcluirDedo1" onclick="excluirDigital(1)">
                      <i class="bi bi-trash me-1"></i>Excluir
                    </button>
                  </div>
                </div>
              </div>

              {{-- Slot 2 --}}
              <div class="col-md-4">
                <div class="card h-100 digital-slot" data-dedo="2">
                  <div class="card-body text-center py-4">
                    <div class="digital-icon mb-3">
                      <i class="bi bi-fingerprint display-1 text-muted" id="iconeDedo2"></i>
                    </div>
                    <h6 class="mb-1">Digital 2</h6>
                    <small class="text-muted d-block mb-3" id="statusDedo2">N√£o cadastrada</small>
                    <button class="btn btn-success btn-sm" id="btnCadastrarDedo2" onclick="capturarDigitalUSB(2)">
                      <i class="bi bi-plus-lg me-1"></i>Cadastrar
                    </button>
                    <button class="btn btn-outline-danger btn-sm d-none" id="btnExcluirDedo2" onclick="excluirDigital(2)">
                      <i class="bi bi-trash me-1"></i>Excluir
                    </button>
                  </div>
                </div>
              </div>

              {{-- Slot 3 --}}
              <div class="col-md-4">
                <div class="card h-100 digital-slot" data-dedo="3">
                  <div class="card-body text-center py-4">
                    <div class="digital-icon mb-3">
                      <i class="bi bi-fingerprint display-1 text-muted" id="iconeDedo3"></i>
                    </div>
                    <h6 class="mb-1">Digital 3</h6>
                    <small class="text-muted d-block mb-3" id="statusDedo3">N√£o cadastrada</small>
                    <button class="btn btn-success btn-sm" id="btnCadastrarDedo3" onclick="capturarDigitalUSB(3)">
                      <i class="bi bi-plus-lg me-1"></i>Cadastrar
                    </button>
                    <button class="btn btn-outline-danger btn-sm d-none" id="btnExcluirDedo3" onclick="excluirDigital(3)">
                      <i class="bi bi-trash me-1"></i>Excluir
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {{-- Modal de Captura em Andamento --}}
            <div id="capturaEmAndamento" class="text-center py-4 d-none">
              <div class="fingerprint-scanner mb-4">
                <div class="fingerprint-box">
                  <svg class="fingerprint-icon" viewBox="0 0 64 64" width="120" height="120">
                    <defs>
                      <linearGradient id="scanGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#00ff88;stop-opacity:0" />
                        <stop offset="50%" style="stop-color:#00ff88;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#00ff88;stop-opacity:0" />
                      </linearGradient>
                    </defs>
                    {{-- Impress√£o digital estilizada --}}
                    <path fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" d="
                      M32 8c-13.2 0-24 10.8-24 24s10.8 24 24 24
                      M32 14c-9.9 0-18 8.1-18 18s8.1 18 18 18
                      M32 20c-6.6 0-12 5.4-12 12s5.4 12 12 12
                      M32 26c-3.3 0-6 2.7-6 6s2.7 6 6 6
                      M38 32c0-3.3-2.7-6-6-6
                      M44 32c0-6.6-5.4-12-12-12
                      M50 32c0-9.9-8.1-18-18-18
                      M56 32c0-13.2-10.8-24-24-24
                    "/>
                    {{-- Linha de escaneamento --}}
                    <rect class="scan-line" x="8" y="0" width="48" height="4" fill="url(#scanGradient)">
                      <animate attributeName="y" from="0" to="60" dur="1.5s" repeatCount="indefinite"/>
                    </rect>
                  </svg>
                </div>
              </div>
              <h5 class="mb-2 text-primary">
                <span class="scanning-dots">Lendo digital</span>
              </h5>
              <p class="text-muted mb-3">Mantenha o dedo firme no leitor</p>
              <div class="progress mb-3" style="height: 4px; max-width: 200px; margin: 0 auto;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 100%"></div>
              </div>
              <button class="btn btn-outline-danger btn-sm" onclick="cancelarCaptura()">
                <i class="bi bi-x-circle me-1"></i>Cancelar
              </button>
            </div>

            <style>
              .fingerprint-scanner {
                display: flex;
                justify-content: center;
                align-items: center;
              }
              .fingerprint-box {
                width: 150px;
                height: 150px;
                border: 3px solid var(--bs-primary);
                border-radius: 12px;
                display: flex;
                justify-content: center;
                align-items: center;
                background: rgba(var(--bs-primary-rgb), 0.05);
                position: relative;
                overflow: hidden;
                animation: pulse-border 2s ease-in-out infinite;
              }
              .fingerprint-icon {
                color: var(--bs-primary);
                opacity: 0.8;
              }
              .scan-line {
                opacity: 0.8;
              }
              @keyframes pulse-border {
                0%, 100% { border-color: var(--bs-primary); box-shadow: 0 0 10px rgba(var(--bs-primary-rgb), 0.3); }
                50% { border-color: var(--bs-success); box-shadow: 0 0 20px rgba(var(--bs-success-rgb), 0.5); }
              }
              .scanning-dots::after {
                content: '';
                animation: dots 1.5s steps(4, end) infinite;
              }
              @keyframes dots {
                0% { content: ''; }
                25% { content: '.'; }
                50% { content: '..'; }
                75% { content: '...'; }
                100% { content: ''; }
              }
            </style>

            <hr>

            {{-- Sincroniza√ß√£o com REP (se dispon√≠vel) --}}
            <div class="accordion" id="accordionREP">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseREP">
                    <i class="bi bi-router me-2"></i>Sincroniza√ß√£o com REP (Coletor de Ponto)
                  </button>
                </h2>
                <div id="collapseREP" class="accordion-collapse collapse" data-bs-parent="#accordionREP">
                  <div class="accordion-body">
                    <div class="alert alert-info small mb-3">
                      <i class="bi bi-info-circle me-1"></i>
                      <strong>Baixar do REP:</strong> Importa digitais do coletor para o sistema.<br>
                      <strong>Enviar para REPs:</strong> Envia as digitais cadastradas para todos os coletores.
                    </div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-primary flex-fill" onclick="baixarDigitaisREP()">
                        <i class="bi bi-cloud-download me-1"></i>Baixar do REP
                      </button>
                      <button class="btn btn-primary flex-fill" onclick="enviarDigitaisREP()">
                        <i class="bi bi-cloud-upload me-1"></i>Enviar para REPs
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {{-- Modal de Foto Facial --}}
    <div class="modal fade" id="modalFoto" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-camera me-2"></i>Cadastrar Foto - <span id="fotoNomeFuncionario"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="fecharModalFoto()"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="fotoFuncionarioId">
            
            <div class="row">
              <div class="col-md-8">
                <div class="position-relative bg-dark rounded overflow-hidden" style="aspect-ratio: 4/3;">
                  <video id="fotoVideo" autoplay muted playsinline style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
                  <canvas id="fotoCanvas" class="d-none"></canvas>
                  <div id="fotoPreview" class="d-none" style="width: 100%; height: 100%; background-size: cover; background-position: center;"></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="alert alert-info small">
                  <i class="bi bi-info-circle me-1"></i>
                  Posicione o rosto centralizado e com boa ilumina√ß√£o.
                </div>
                
                <div id="fotoStatus" class="mb-3">
                  <p class="text-muted small mb-1">Status:</p>
                  <span class="badge bg-secondary">Carregando c√¢mera...</span>
                </div>
                
                <button class="btn btn-primary w-100 mb-2" id="btnCapturar" onclick="capturarFotoFacial()" disabled>
                  <i class="bi bi-camera me-1"></i>Capturar Foto
                </button>
                
                <button class="btn btn-success w-100 d-none" id="btnSalvarFoto" onclick="salvarFotoFacial()">
                  <i class="bi bi-check-lg me-1"></i>Salvar Foto
                </button>
                
                <button class="btn btn-outline-secondary w-100 mt-2 d-none" id="btnNovaFoto" onclick="novaFoto()">
                  <i class="bi bi-arrow-repeat me-1"></i>Tirar Outra
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {{-- Modal Configurar Leitor Biom√©trico --}}
    <div class="modal fade" id="modalLeitorBiometrico" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="bi bi-fingerprint me-2"></i>Configurar Leitor Biom√©trico</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Leitor n√£o detectado!</strong> Siga as instru√ß√µes abaixo para configurar.
            </div>

            <div class="text-center mb-4">
              <a href="/futronic-api.zip" class="btn btn-success btn-lg" download>
                <i class="bi bi-download me-2"></i>Baixar Software do Leitor
              </a>
              <p class="text-muted small mt-2">futronic-api.zip (5 KB)</p>
            </div>

            <h6><i class="bi bi-list-ol me-2"></i>Passo a Passo:</h6>
            <ol class="mb-4">
              <li class="mb-2">Clique no bot√£o acima para <strong>baixar o arquivo</strong></li>
              <li class="mb-2"><strong>Extraia</strong> o conte√∫do para uma pasta</li>
              <li class="mb-2"><strong>Conecte o leitor</strong> Futronic FS80H na porta USB</li>
              <li class="mb-2">Clique com <strong>bot√£o direito</strong> em <code>instalar.bat</code> ‚Üí <strong>"Executar como administrador"</strong></li>
              <li class="mb-2">Pronto! O servi√ßo roda <strong>invis√≠vel em background</strong> e inicia com o Windows</li>
            </ol>

            <div class="alert alert-success small">
              <i class="bi bi-check-circle me-2"></i>
              <strong>N√£o precisa manter janela aberta!</strong> O servi√ßo roda automaticamente em background.
            </div>

            <div class="card bg-light mt-4">
              <div class="card-body">
                <h6 class="card-title"><i class="bi bi-puzzle me-2"></i>Extens√£o do Navegador (Opcional)</h6>
                <p class="card-text small text-muted mb-2">
                  Instale a extens√£o para ver o status do leitor na barra do navegador.
                </p>
                <a href="/futronic-extension.zip" class="btn btn-outline-primary btn-sm" download>
                  <i class="bi bi-download me-1"></i>Baixar Extens√£o
                </a>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
              <span id="modalLeitorStatus" class="text-muted">
                <i class="bi bi-hourglass-split me-1"></i>Verificando...
              </span>
              <button type="button" class="btn btn-outline-primary" onclick="verificarLeitorModal()">
                <i class="bi bi-arrow-clockwise me-1"></i>Verificar Novamente
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    {{-- Modal Funcion√°rio --}}
    <div class="modal fade" id="modalFuncionario" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalFuncionarioTitle">Novo Funcion√°rio</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="formFuncionario" data-parsley-validate>
            <div class="modal-body">
              <input type="hidden" name="id" id="funcionarioId">

              {{-- Dados Pessoais --}}
              <h6 class="text-muted mb-3"><i class="bi bi-person me-2"></i>Dados Pessoais</h6>
              <div class="row g-3 mb-4">
                <div class="col-md-3">
                  <label class="form-label">Matr√≠cula *</label>
                  <input type="text" class="form-control" name="matricula" id="matricula" required
                         data-parsley-required-message="Matr√≠cula √© obrigat√≥ria">
                </div>
                <div class="col-md-3">
                  <label class="form-label">CPF *</label>
                  <div class="input-group">
                    <input type="text" class="form-control" name="cpf" id="cpf" required
                           placeholder="000.000.000-00"
                           data-parsley-required-message="CPF √© obrigat√≥rio"
                           data-parsley-pattern="^\d{3}\.\d{3}\.\d{3}-\d{2}$"
                           data-parsley-pattern-message="CPF inv√°lido">
                    <span class="input-group-text" id="cpfStatus"></span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">PIS</label>
                  <div class="input-group">
                    <input type="text" class="form-control" name="pis" id="pis"
                           placeholder="000.00000.00-0">
                    <span class="input-group-text" id="pisStatus"></span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Sexo</label>
                  <select class="form-select" name="sexo" id="sexo">
                    <option value="">Selecione...</option>
                    <option value="M">Masculino</option>
                    <option value="F">Feminino</option>
                  </select>
                </div>
                <div class="col-md-9">
                  <label class="form-label">Nome Completo *</label>
                  <input type="text" class="form-control" name="nome" id="nome" required
                         data-parsley-required-message="Nome √© obrigat√≥rio"
                         data-parsley-minlength="3"
                         data-parsley-minlength-message="Nome deve ter pelo menos 3 caracteres">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Data Nascimento</label>
                  <input type="text" class="form-control datepicker-func" name="data_nascimento" id="data_nascimento" placeholder="dd/mm/aaaa">
                </div>
              </div>

              {{-- V√≠nculo e Lota√ß√£o --}}
              <h6 class="text-muted mb-3"><i class="bi bi-building me-2"></i>V√≠nculo e {{ labelLotacao }}</h6>
              <div class="row g-3 mb-4">
                <div class="col-md-4">
                  <label class="form-label">{{ labelUnidade }} *</label>
                  <select class="form-select" name="unidade_gestora_id" id="unidade_gestora_id" onchange="carregarSecretarias()" required
                          data-parsley-required-message="Selecione a {{ labelUnidade.toLowerCase() }}">
                    <option value="">Selecione...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">{{ labelSecretaria }} *</label>
                  <select class="form-select" name="secretaria_id" id="secretaria_id" onchange="carregarLotacoes()" required
                          data-parsley-required-message="Selecione o departamento">
                    <option value="">Selecione a {{ labelUnidade.toLowerCase() }} primeiro</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">{{ labelLotacao }} *</label>
                  <select class="form-select" name="lotacao_id" id="lotacao_id" required
                          data-parsley-required-message="Selecione o {{ labelLotacao.toLowerCase() }}">
                    <option value="">Selecione o {{ labelSecretaria.toLowerCase() }} primeiro</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Tipo de V√≠nculo *</label>
                  <select class="form-select" name="tipo_vinculo_id" id="tipo_vinculo_id" required
                          data-parsley-required-message="Selecione o tipo de v√≠nculo">
                    <option value="">Selecione...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Cargo *</label>
                  <select class="form-select" name="cargo_id" id="cargo_id" required
                          data-parsley-required-message="Selecione o cargo">
                    <option value="">Selecione o v√≠nculo primeiro</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Jornada *</label>
                  <select class="form-select" name="jornada_id" id="jornada_id" required
                          data-parsley-required-message="Selecione a jornada">
                    <option value="">Selecione...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Intervalo Presenca (min)</label>
                  <input type="number" class="form-control" name="intervalo_presenca" id="intervalo_presenca"
                         placeholder="Ex: 30" min="0" max="480">
                  <small class="text-muted">Para rondas/vigilancia. Deixe vazio se nao precisar.</small>
                </div>
              </div>

              {{-- Datas e Status --}}
              <h6 class="text-muted mb-3"><i class="bi bi-calendar me-2"></i>Datas e Status</h6>
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Data Admiss√£o *</label>
                  <input type="text" class="form-control datepicker-func" name="data_admissao" id="data_admissao" placeholder="dd/mm/aaaa" required
                         data-parsley-required-message="Data de admiss√£o √© obrigat√≥ria">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Data Demiss√£o</label>
                  <input type="text" class="form-control datepicker-func" name="data_demissao" id="data_demissao" placeholder="dd/mm/aaaa">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Status</label>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" role="switch" name="ativo" id="ativo" checked style="width: 3em; height: 1.5em;">
                    <label class="form-check-label ms-2" for="ativo" id="ativoLabel">Ativo</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger me-auto d-none" id="btnExcluirFuncionario" onclick="excluirFuncionario()">
                <i class="bi bi-trash me-2"></i>Excluir
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-2"></i>Salvar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  @end

  @slot('scripts')
    <script>
      let dataTable;
      let cacheData = {
        unidadesGestoras: [],
        secretarias: [],
        lotacoes: [],
        tiposVinculo: [],
        cargos: [],
        jornadas: []
      };
      
      // Cache de usu√°rios do REP e status
      let repsDisponiveis = []; // Lista de REPs { id, nome, online }
      let sincStatus = {}; // Mapa de PIS -> { [rep_id]: boolean }
      let repProxyOnline = false;

      // ============ VARI√ÅVEIS FOTO FACIAL ============
      let fotoStream = null;
      let fotoDescriptor = null;
      let fotoBase64 = null;
      let faceApiLoaded = false;
      const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/model';

      // Carrega face-api.js dinamicamente quando necess√°rio
      async function carregarFaceApi() {
        if (faceApiLoaded) return true;
        
        // Carrega script se n√£o existir
        if (!window.faceapi) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/dist/face-api.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        // Carrega modelos
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        faceApiLoaded = true;
        return true;
      }

      // Abre modal de cadastro de foto
      async function cadastrarFoto(funcionarioId, nome) {
        $('#fotoFuncionarioId').val(funcionarioId);
        $('#fotoNomeFuncionario').text(nome);
        $('#fotoStatus').html('<span class="badge bg-secondary">Verificando cadastro...</span>');
        $('#btnCapturar').prop('disabled', true);
        $('#btnSalvarFoto').addClass('d-none');
        $('#btnNovaFoto').addClass('d-none');
        
        const modal = new bootstrap.Modal(document.getElementById('modalFoto'));
        modal.show();
        
        // Verifica se j√° tem foto
        try {
          const response = await fetch(`/api/funcionarios/${funcionarioId}/foto`);
          const result = await response.json();
          
          if (result.success && result.foto_base64) {
             // Tem foto cadastrada
             fotoBase64 = result.foto_base64;
             $('#fotoPreview').css('background-image', 'url(' + fotoBase64 + ')').removeClass('d-none');
             $('#fotoVideo').addClass('d-none');
             $('#fotoStatus').html('<span class="badge bg-success">Foto j√° cadastrada</span>');
             $('#btnNovaFoto').removeClass('d-none').html('<i class="bi bi-camera me-1"></i>Atualizar Foto');
             $('#btnCapturar').addClass('d-none'); // Esconde bot√£o capturar inicial
             
             // Carrega face-api em background
             carregarFaceApi();
             return;
          }
        } catch (e) {
          // Sem foto anterior ou erro ao carregar
        }

        // Se n√£o tem foto, inicia fluxo normal
        iniciarFluxoCaptura();
      }
      
      async function iniciarFluxoCaptura() {
         $('#fotoStatus').html('<span class="badge bg-warning">Carregando modelos de IA...</span>');
         $('#fotoPreview').addClass('d-none');
         $('#btnCapturar').removeClass('d-none').prop('disabled', true);
         $('#btnNovaFoto').addClass('d-none');
         
        try {
          // Carrega face-api.js
          await carregarFaceApi();
          $('#fotoStatus').html('<span class="badge bg-info">Iniciando c√¢mera...</span>');
          
          // Inicia c√¢mera
          fotoStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
          });
          
          const video = document.getElementById('fotoVideo');
          video.srcObject = fotoStream;
          video.classList.remove('d-none');
          
          await new Promise(resolve => video.onloadedmetadata = resolve);
          
          $('#fotoStatus').html('<span class="badge bg-success">Pronto para captura</span>');
          $('#btnCapturar').prop('disabled', false);
          
        } catch (err) {
          console.error('Erro:', err);
          $('#fotoStatus').html('<span class="badge bg-danger">Erro: ' + err.message + '</span>');
        }
      }

      // Captura foto e extrai descritor
      async function capturarFotoFacial() {
        // Feedback imediato - desabilita bot√£o e mostra processando
        $('#btnCapturar').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Capturando...');
        $('#fotoStatus').html('<span class="badge bg-info"><i class="bi bi-hourglass-split me-1"></i>Processando imagem...</span>');
        
        // Pequeno delay para o feedback aparecer antes do processamento pesado
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const video = document.getElementById('fotoVideo');
        const canvas = document.getElementById('fotoCanvas');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Converte para base64
        fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
        
        // Mostra preview com anima√ß√£o flash
        const preview = $('#fotoPreview');
        preview.css('background-image', 'url(' + fotoBase64 + ')');
        video.classList.add('d-none');
        preview.removeClass('d-none').hide().fadeIn(200);
        
        // Flash effect
        const flash = $('<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:white;opacity:0.8;z-index:10;"></div>');
        preview.parent().append(flash);
        flash.fadeOut(300, function() { $(this).remove(); });
        
        $('#fotoStatus').html('<span class="badge bg-warning"><i class="bi bi-cpu me-1"></i>Analisando rosto com IA... (pode levar alguns segundos)</span>');
        
        try {
          // Detecta rosto e extrai descritor
          const detection = await faceapi
            .detectSingleFace(canvas)
            .withFaceLandmarks()
            .withFaceDescriptor();
          
          if (detection) {
            fotoDescriptor = Array.from(detection.descriptor);
            $('#fotoStatus').html('<span class="badge bg-success">‚úì Rosto detectado com sucesso!</span>');
            $('#btnSalvarFoto').removeClass('d-none');
            $('#btnNovaFoto').removeClass('d-none');
          } else {
            $('#fotoStatus').html('<span class="badge bg-danger">Nenhum rosto detectado. Tente novamente.</span>');
            $('#btnNovaFoto').removeClass('d-none');
          }
        } catch (err) {
          console.error('Erro na detec√ß√£o:', err);
          $('#fotoStatus').html('<span class="badge bg-danger">Erro na an√°lise: ' + err.message + '</span>');
          $('#btnNovaFoto').removeClass('d-none');
        } finally {
          // Restaura o bot√£o Capturar ao estado original
          $('#btnCapturar').prop('disabled', false).html('<i class="bi bi-camera me-1"></i>Capturar Foto');
        }
      }

      // Salva foto no banco
      async function salvarFotoFacial() {
        const funcionarioId = $('#fotoFuncionarioId').val();
        
        $('#btnSalvarFoto').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Salvando...');
        
        try {
          const response = await fetch(`/api/funcionarios/${funcionarioId}/foto`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              foto_base64: fotoBase64,
              descriptor: JSON.stringify(fotoDescriptor)
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            toastr.success('Foto cadastrada com sucesso!');
            fecharModalFoto();
          } else {
            toastr.error('Erro ao salvar: ' + (result.error || 'Desconhecido'));
          }
        } catch (err) {
          toastr.error('Erro de conex√£o');
        } finally {
          $('#btnSalvarFoto').prop('disabled', false).html('<i class="bi bi-check-lg me-1"></i>Salvar Foto');
        }
      }

      // Nova foto
      function novaFoto() {
        iniciarFluxoCaptura();
        fotoDescriptor = null;
        fotoBase64 = null;
      }

      // Fecha modal e para c√¢mera
      function fecharModalFoto() {
        if (fotoStream) {
          fotoStream.getTracks().forEach(track => track.stop());
          fotoStream = null;
        }
        fotoDescriptor = null;
        fotoBase64 = null;
      }

      let cpfTimeout, pisTimeout;
      let editandoId = null;
      let funcionariosData = [];
      let dataNascimentoPicker, dataAdmissaoPicker, dataDemissaoPicker;

      $(document).ready(function() {
        carregarStatusREP();
        carregarDadosAuxiliares();
        inicializarMascaras();
        inicializarValidacoes();
        inicializarFlatpickr();
        inicializarFiltrosSelect2();

        // Inicializa Select2 quando o modal abrir
        $('#modalFuncionario').on('shown.bs.modal', function() {
          inicializarSelect2();
        });

        // Limpa backdrops residuais quando o modal de funcion√°rio for fechado
        $('#modalFuncionario').on('hidden.bs.modal', function() {
          // Remove qualquer backdrop que tenha ficado
          $('.modal-backdrop').remove();
          // Remove classe do body se necess√°rio
          $('body').removeClass('modal-open').css('overflow', '').css('padding-right', '');
        });

        // Limpa backdrops residuais quando o modal de digitais for fechado
        $('#modalDigitais').on('hidden.bs.modal', function() {
          // Remove qualquer backdrop que tenha ficado
          $('.modal-backdrop').remove();
          // Remove classe do body se necess√°rio
          $('body').removeClass('modal-open').css('overflow', '');
        });
      });

      // ============ SELECT2 NOS FILTROS COM FILTRAGEM AUTOM√ÅTICA ============
      function inicializarFiltrosSelect2() {
        // Inicializa Select2 em todos os filtros
        $('.filtro-select2').select2({
          theme: 'bootstrap-5',
          width: '100%',
          placeholder: 'Selecione...',
          allowClear: true
        });

        // Usa event delegation para os eventos persistirem ap√≥s reinicializa√ß√£o
        // Evento de mudan√ßa na Unidade Gestora - carrega secretarias e filtra
        $(document).on('change', '#filtroUnidadeGestora', function() {
          carregarSecretariasFiltro();
          carregarFuncionarios();
        });

        // Evento de mudan√ßa na Secretaria - carrega lota√ß√µes, cargo/v√≠nculo e filtra
        $(document).on('change', '#filtroSecretaria', function() {
          carregarLotacoesFiltro();
          carregarFiltrosCargosVinculos();
          carregarFuncionarios();
        });

        // Evento de mudan√ßa na Lota√ß√£o - filtra e atualiza cargo/v√≠nculo
        $(document).on('change', '#filtroLotacao', function() {
          carregarFiltrosCargosVinculos();
          carregarFuncionarios();
        });

        // Evento de mudan√ßa no Status - filtra automaticamente
        $(document).on('change', '#filtroStatus', function() {
          carregarFuncionarios();
        });

        // Novos filtros: Cargo, V√≠nculo, Jornada
        $(document).on('change', '#filtroCargo', function() {
          carregarFuncionarios();
        });
        $(document).on('change', '#filtroVinculo', function() {
          carregarFuncionarios();
        });
        $(document).on('change', '#filtroJornada', function() {
          carregarFuncionarios();
        });
      }

      // Carrega cargos e v√≠nculos baseado na lota√ß√£o/secretaria selecionada
      async function carregarFiltrosCargosVinculos() {
        const lotacaoId = $('#filtroLotacao').val();
        const secretariaId = $('#filtroSecretaria').val();

        let params = new URLSearchParams();
        if (lotacaoId) params.append('lotacao_id', lotacaoId);
        else if (secretariaId) params.append('secretaria_id', secretariaId);

        // Se nenhum filtro de contexto selecionado, mant√©m os valores atuais
        if (!lotacaoId && !secretariaId) {
          return;
        }

        try {
          const response = await fetch(`/api/funcionarios/filtros-disponiveis?${params.toString()}`);
          const result = await response.json();

          // Atualiza select de Cargo
          const selectCargo = $('#filtroCargo');
          selectCargo.html('<option value="">Todos</option>');
          (result.cargos || []).forEach(c => {
            selectCargo.append(`<option value="${c.id}">${c.nome}</option>`);
          });
          reinicializarFiltroSelect2('#filtroCargo');

          // Atualiza select de V√≠nculo
          const selectVinculo = $('#filtroVinculo');
          selectVinculo.html('<option value="">Todos</option>');
          (result.vinculos || []).forEach(v => {
            selectVinculo.append(`<option value="${v.id}">${v.nome}</option>`);
          });
          reinicializarFiltroSelect2('#filtroVinculo');
        } catch (error) {
          console.error('Erro ao carregar filtros:', error);
        }
      }

      // Reinicializa Select2 dos filtros ap√≥s popular op√ß√µes
      function reinicializarFiltroSelect2(selector) {
        const $select = $(selector);
        const valorAtual = $select.val();

        // Destroy se j√° existir
        if ($select.hasClass('select2-hidden-accessible')) {
          $select.select2('destroy');
        }

        // Reinicializa
        $select.select2({
          theme: 'bootstrap-5',
          width: '100%',
          placeholder: 'Selecione...',
          allowClear: true
        });

        // Restaura valor se havia
        if (valorAtual) {
          $select.val(valorAtual).trigger('change.select2');
        }
      }

      // ============ M√ÅSCARAS ============
      function inicializarMascaras() {
        // M√°scara CPF: 000.000.000-00
        $('#cpf').mask('000.000.000-00', { reverse: false });

        // M√°scara PIS: 000.00000.00-0
        $('#pis').mask('000.00000.00-0', { reverse: false });
      }

      // Formatar CPF para exibi√ß√£o
      function formatarCPF(cpf) {
        if (!cpf) return '';
        cpf = cpf.replace(/\D/g, '');
        if (cpf.length === 11) {
          return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        return cpf;
      }

      // Formatar PIS para exibi√ß√£o
      function formatarPIS(pis) {
        if (!pis) return '';
        pis = pis.replace(/\D/g, '');
        if (pis.length === 11) {
          return pis.replace(/(\d{3})(\d{5})(\d{2})(\d{1})/, '$1.$2.$3-$4');
        }
        return pis;
      }

      // ============ FLATPICKR (DATEPICKER) ============
      function inicializarFlatpickr() {
        // Usa fun√ß√£o global com configura√ß√£o espec√≠fica para formul√°rio
        // (formato Y-m-d para salvar no banco, mas exibe d/m/Y)
        if (window.initDatepickers) {
          const pickers = window.initDatepickers('.datepicker-func', {
            dateFormat: 'Y-m-d',  // Para o banco
            allowInput: true      // Permite digitar
          });
          dataNascimentoPicker = pickers['data_nascimento'];
          dataAdmissaoPicker = pickers['data_admissao'];
          dataDemissaoPicker = pickers['data_demissao'];
        } else {
          // Fallback
          const configPadrao = {
            locale: 'pt',
            dateFormat: 'Y-m-d',
            altInput: true,
            altFormat: 'd/m/Y',
            allowInput: true
          };
          dataNascimentoPicker = flatpickr('#data_nascimento', configPadrao);
          dataAdmissaoPicker = flatpickr('#data_admissao', configPadrao);
          dataDemissaoPicker = flatpickr('#data_demissao', configPadrao);
        }
        
        // Aplica m√°scara de data nos campos alt (exibidos ao usu√°rio)
        setTimeout(() => {
          $('.datepicker-func + input').mask('00/00/0000');
        }, 100);
      }

      function reinicializarFlatpickr() {
        if (dataNascimentoPicker) dataNascimentoPicker.clear();
        if (dataAdmissaoPicker) dataAdmissaoPicker.clear();
        if (dataDemissaoPicker) dataDemissaoPicker.clear();
      }

      // ============ SELECT2 ============
      function inicializarSelect2() {
        // Inicializa Select2 em todos os selects do modal
        $('#modalFuncionario select:not(.no-select2)').select2({
          theme: 'bootstrap-5',
          dropdownParent: $('#modalFuncionario'),
          width: '100%',
          placeholder: 'Selecione...',
          allowClear: true
        });
      }

      function reinicializarSelect2() {
        // Destroy e reinicializa Select2 ap√≥s popular op√ß√µes
        $('#modalFuncionario select.select2-hidden-accessible').each(function() {
          $(this).select2('destroy');
        });
        setTimeout(inicializarSelect2, 100);
      }

      // ============ VALIDA√á√ïES EM TEMPO REAL ============
      function inicializarValidacoes() {
        // Verifica√ß√£o de CPF em tempo real
        $('#cpf').on('input', function() {
          clearTimeout(cpfTimeout);
          const cpf = $(this).val().replace(/\D/g, '');
          const $container = $(this).closest('.input-group').parent();

          if (cpf.length < 11) {
            $('#cpfStatus').html('<i class="bi bi-question-circle text-muted"></i>');
            $(this).removeClass('is-valid is-invalid');
            $('#cpfFeedback').remove();
            return;
          }

          // Valida d√≠gitos verificadores
          if (!validarCPF(cpf)) {
            $('#cpfStatus').html('<i class="bi bi-x-circle text-danger"></i>');
            $(this).removeClass('is-valid').addClass('is-invalid');
            $('#cpfFeedback').remove();
            $container.find('.input-group').after('<div id="cpfFeedback" class="text-danger small mt-1">CPF inv√°lido - d√≠gitos n√£o conferem</div>');
            return;
          }

          $('#cpfStatus').html('<i class="bi bi-hourglass-split text-warning"></i>');

          cpfTimeout = setTimeout(async () => {
            const disponivel = await verificarDisponibilidade('cpf', cpf);
            if (disponivel) {
              $('#cpfStatus').html('<i class="bi bi-check-circle text-success"></i>');
              $('#cpf').removeClass('is-invalid').addClass('is-valid');
              $('#cpfFeedback').remove();
            } else {
              $('#cpfStatus').html('<i class="bi bi-x-circle text-danger"></i>');
              $('#cpf').removeClass('is-valid').addClass('is-invalid');
              $('#cpfFeedback').remove();
              $container.find('.input-group').after('<div id="cpfFeedback" class="text-danger small mt-1">CPF j√° cadastrado</div>');
            }
          }, 500);
        });

        // Verifica√ß√£o de PIS em tempo real
        $('#pis').on('input', function() {
          clearTimeout(pisTimeout);
          const pis = $(this).val().replace(/\D/g, '');

          if (!pis || pis.length < 11) {
            $('#pisStatus').html('<i class="bi bi-question-circle text-muted"></i>');
            $(this).removeClass('is-valid is-invalid');
            return;
          }

          $('#pisStatus').html('<i class="bi bi-hourglass-split text-warning"></i>');

          pisTimeout = setTimeout(async () => {
            const disponivel = await verificarDisponibilidade('pis', pis);
            if (disponivel) {
              $('#pisStatus').html('<i class="bi bi-check-circle text-success"></i>');
              $('#pis').removeClass('is-invalid').addClass('is-valid');
            } else {
              $('#pisStatus').html('<i class="bi bi-x-circle text-danger"></i>');
              $('#pis').removeClass('is-valid').addClass('is-invalid');
            }
          }, 500);
        });

        // Switch ativo
        $('#ativo').on('change', function() {
          if ($(this).is(':checked')) {
            $('#ativoLabel').text('Ativo');
          } else {
            $('#ativoLabel').text('Inativo');
          }
        });
      }

      // Valida d√≠gitos verificadores do CPF
      function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        if (cpf.length !== 11) return false;

        // Verifica se todos os d√≠gitos s√£o iguais
        if (/^(\d)\1+$/.test(cpf)) return false;

        // Valida primeiro d√≠gito verificador
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(cpf.charAt(i)) * (10 - i);
        }
        let resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(9))) return false;

        // Valida segundo d√≠gito verificador
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(cpf.charAt(i)) * (11 - i);
        }
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.charAt(10))) return false;

        return true;
      }

      // Verifica disponibilidade de CPF ou PIS
      async function verificarDisponibilidade(campo, valor) {
        try {
          // Carrega lista de funcion√°rios se ainda n√£o tiver
          if (funcionariosData.length === 0) {
            const response = await fetch('/api/funcionarios');
            const result = await response.json();
            funcionariosData = result.data || [];
          }

          // Ignora o pr√≥prio funcion√°rio se estiver editando
          const outrosFuncionarios = funcionariosData.filter(f => f.id != editandoId);

          if (campo === 'cpf') {
            // Normaliza CPF para compara√ß√£o
            const cpfLimpo = valor.replace(/\D/g, '');
            return !outrosFuncionarios.some(f => {
              const fcpf = (f.cpf || '').replace(/\D/g, '');
              return fcpf === cpfLimpo;
            });
          } else if (campo === 'pis') {
            // Normaliza PIS para compara√ß√£o
            const pisLimpo = valor.replace(/\D/g, '');
            return !outrosFuncionarios.some(f => {
              const fpis = (f.pis || '').replace(/\D/g, '');
              return fpis && fpis === pisLimpo;
            });
          }
          return true;
        } catch {
          return true;
        }
      }
      
      // Busca status detalhado dos REPs e usu√°rios
      async function carregarStatusREP() {
        try {
          const response = await fetch('/api/rep/usuarios');
          const result = await response.json();
          
          if (result.reps) {
            repsDisponiveis = result.reps;
            sincStatus = result.sinc_status || {};
            repProxyOnline = true;

            // Mostra bot√£o de Sincronizar Tudo se houver REPs
            if (repsDisponiveis.length > 0) {
              $('#btnSincronizarTudo').show();
            }
            
            // Recarrega tabela se j√° estiver desenhada (para atualizar √≠cones)
            if (dataTable) dataTable.ajax.reload(null, false); 
          } else {
            repProxyOnline = false;
            // $('#btnSincronizarTudo').hide(); // N√ÉO ESCONDER MAIS, DEIXA VISIVEL PARA TENTAR NOVO
            $('#btnSincronizarTudo').show(); // For√ßa mostrar para debug
          }
        } catch (error) {
          console.warn('[REP] N√£o foi poss√≠vel conectar ao Proxy REP:', error.message);
          repProxyOnline = false;
          // $('#btnSincronizarTudo').hide(); // N√ÉO ESCONDER
          $('#btnSincronizarTudo').show(); // For√ßa mostrar
        }
      }

      // Sincroniza√ß√£o em massa com modal de progresso
      async function sincronizarTudo(btn) {
        if (!await confirmar('Esta a√ß√£o enviar√° TODOS os funcion√°rios do sistema para TODOS os REPs online. Pode demorar alguns minutos. Deseja continuar?', { tipo: 'warning', titulo: 'Sincronizar Funcion√°rios' })) {
          return;
        }

        // Exibe modal de progresso
        const modal = new bootstrap.Modal(document.getElementById('modalProgresso'));
        const progressBar = document.getElementById('progressoSincronizacao');
        const statusText = document.getElementById('textoProgresso');
        const totalFuncionarios = Object.keys(sincStatus).length || 313; // Estima√ß√£o
        
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
        statusText.textContent = 'Iniciando sincroniza√ß√£o...';
        modal.show();
        
        // Simula√ß√£o de progresso com logs
        const logContainer = document.getElementById('logSincronizacaoContainer');
        logContainer.style.display = 'block';
        logContainer.innerHTML = '<div class="text-success">> Iniciando processo...</div>';
        
        const addLog = (msg, color = 'text-success') => {
            logContainer.innerHTML += `<div class="${color}">> ${msg}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        };

        let progresso = 0;
        const etapas = [
            "Conectando ao Proxy REP...",
            "Verificando status dos equipamentos...",
            "Buscando novos usu√°rios nos REPs...",
            "Processando importa√ß√£o de dados...",
            "Preparando lista de sincroniza√ß√£o...",
            "Enviando atualiza√ß√µes para os REPs..."
        ];
        
        let etapaAtualIdx = 0;
        
        const intervalo = setInterval(() => {
          if (progresso < 95) {
            progresso += Math.random() * 2;
            progressBar.style.width = `${Math.min(progresso, 95)}%`;
            
            // Troca de etapa a cada ~15%
            const novaEtapaIdx = Math.floor(progresso / 16);
            if (novaEtapaIdx > etapaAtualIdx && novaEtapaIdx < etapas.length) {
                etapaAtualIdx = novaEtapaIdx;
                addLog(etapas[etapaAtualIdx]);
                statusText.textContent = etapas[etapaAtualIdx];
            }
          }
        }, 300);
        
        try {
          const response = await fetch('/api/rep/sincronizar-tudo', { method: 'POST' });
          const result = await response.json();
          
          clearInterval(intervalo);
          
          if (result.success) {
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-success');
            
            let msg = `<i class="bi bi-check-circle-fill text-success me-2"></i>Conclu√≠do!`;
            statusText.innerHTML = msg;
            
            addLog("Sincroniza√ß√£o finalizada com √™xito!", "text-white");
            addLog(`Enviados: ${result.sucessos || 0}, Erros: ${result.erros || 0}`, "text-info");
            
            // Mostra bot√£o de fechar
            $('#btnFecharModalProgresso').show();
            
            if (result.importados > 0) {
                addLog(`IMPORTA√á√ÉO: ${result.importados} novos usu√°rios recuperados do REP!`, "text-warning fw-bold");
                toastr.success(`${result.importados} usu√°rios importados do REP!`);
                
                // Reload autom√°tico cancelado - deixa o usu√°rio ler e fechar/recarregar
                addLog("Recarregue a p√°gina para ver os novos usu√°rios.", "text-white");
            } else {
                addLog("Nenhum novo usu√°rio encontrado no REP.", "text-muted");
                // Atualiza status em background
                carregarStatusREP();
            }
            
            statusText.innerHTML = msg;
            
            // Recarrega p√°gina ap√≥s 3s para mostrar novos usu√°rios
            if (result.importados > 0) {
                setTimeout(() => window.location.reload(), 3000);
            } else {
                setTimeout(carregarStatusREP, 2000);
            }
          } else {
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-danger');
            statusText.innerHTML = `<i class="bi bi-x-circle-fill text-danger me-2"></i>Erro: ${result.error || 'Desconhecido'}`;
            addLog(`ERRO CR√çTICO: ${result.error || 'Falha desconhecida'}`, 'text-danger fw-bold');
          }
        } catch (error) {
          clearInterval(intervalo);
          progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
          progressBar.classList.add('bg-danger');
          statusText.innerHTML = `<i class="bi bi-x-circle-fill text-danger me-2"></i>Erro de conex√£o`;
          if (logContainer) logContainer.innerHTML += `<div class="text-danger fw-bold">> ERRO DE CONEX√ÉO: ${error.message}</div>`;
        }
      }
      
      // Envia comando para sincronizar funcion√°rio em um REP espec√≠fico
      async function sincronizarFuncionario(btn, repId, funcionarioId) {
        const $btn = $(btn);
        const originalHtml = $btn.html();
        
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        
        try {
          const response = await fetch('/api/rep/sincronizar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rep_id: repId, funcionario_id: funcionarioId })
          });
          const result = await response.json();
          
          if (result.success) {
            toastr.success('Comando de sincroniza√ß√£o enviado!');
            // Atualiza status localmente para refletir sucesso imediato (otimista)
            // Recarrega status geral ap√≥s 2s para confirmar
            setTimeout(carregarStatusREP, 2000);
          } else {
            toastr.error('Erro ao sincronizar: ' + (result.error || 'Desconhecido'));
          }
        } catch (error) {
          toastr.error('Erro de conex√£o ao sincronizar.');
        } finally {
          $btn.prop('disabled', false).html(originalHtml);
        }
      }
      
      
      // ============ RESET DE SENHA ============
      async function resetarSenha(id, nome, cpf) {
        const ultimosDigitos = cpf ? cpf.replace(/\D/g, '').slice(-4) : '0000';
        
        const result = await Swal.fire({
          title: 'Resetar Senha',
          html: `
            <p>Deseja resetar a senha de <strong>${nome}</strong>?</p>
            <div class="alert alert-info mt-3">
              <i class="bi bi-info-circle me-2"></i>
              A nova senha ser√° os <strong>4 √∫ltimos d√≠gitos do CPF</strong>: <code>${ultimosDigitos}</code>
            </div>
            <div class="alert alert-warning mt-2">
              <i class="bi bi-exclamation-triangle me-2"></i>
              O funcion√°rio dever√° alterar a senha no primeiro acesso.
            </div>
          `,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: '<i class="bi bi-key me-1"></i> Resetar Senha',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#f59e0b'
        });

        if (result.isConfirmed) {
          try {
            const res = await fetch(`/api/funcionarios/${id}/resetar-senha`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await res.json();
            
            if (data.success) {
              Swal.fire({
                title: 'Senha Resetada!',
                html: `
                  <p>A senha de <strong>${nome}</strong> foi resetada com sucesso.</p>
                  <div class="alert alert-success mt-3">
                    <i class="bi bi-check-circle me-2"></i>
                    Nova senha: <strong><code>${data.novaSenha}</code></strong>
                  </div>
                  <small class="text-muted">Informe ao funcion√°rio que ele dever√° alterar a senha no primeiro acesso.</small>
                `,
                icon: 'success'
              });
            } else {
              toastr.error(data.error || 'Erro ao resetar senha');
            }
          } catch (e) {
            console.error('Erro:', e);
            toastr.error('Erro ao resetar senha');
          }
        }
      }

      // ============ FUN√á√ïES DE DIGITAIS ============

      let leitorUSBOnline = false;
      let capturaAbortController = null;
      const BIOMETRIC_API_URL = 'http://localhost:5001';
      const LEITOR_DIGITAL_DESABILITADO = false; // Leitor USB habilitado

      // Verifica status do leitor biom√©trico USB
      async function verificarLeitorUSB() {
        // Leitor desabilitado
        if (LEITOR_DIGITAL_DESABILITADO) {
          leitorUSBOnline = false;
          $('#statusLeitorTexto').text('Leitor digital desabilitado');
          $('#statusLeitorBadge').removeClass('bg-success bg-warning bg-danger').addClass('bg-secondary').text('Desabilitado');
          $('#statusLeitorUSB').removeClass('alert-success alert-warning alert-danger').addClass('alert-secondary');
          return false;
        }

        try {
          // Primeiro tenta o endpoint / (StatusResponse)
          const response = await fetch(`${BIOMETRIC_API_URL}/`, {
            method: 'GET',
            signal: AbortSignal.timeout(3000)
          });
          const result = await response.json();

          if (result.device_connected) {
            leitorUSBOnline = true;
            // Busca info detalhada do dispositivo
            try {
              const deviceResponse = await fetch(`${BIOMETRIC_API_URL}/device/status`);
              const deviceInfo = await deviceResponse.json();
              const deviceName = deviceInfo.manufacturer ? `${deviceInfo.manufacturer} ${deviceInfo.model}` : 'Leitor Conectado';
              $('#statusLeitorTexto').text(`Leitor: ${deviceName}`);
            } catch {
              $('#statusLeitorTexto').text('Leitor: Conectado');
            }
            $('#statusLeitorBadge').removeClass('bg-secondary bg-danger bg-warning').addClass('bg-success').text('Online');
            $('#statusLeitorUSB').removeClass('alert-secondary alert-danger alert-warning').addClass('alert-success');
            return true;
          } else {
            leitorUSBOnline = false;
            $('#statusLeitorTexto').text('Nenhum leitor biom√©trico detectado');
            $('#statusLeitorBadge').removeClass('bg-secondary bg-success').addClass('bg-warning').text('Desconectado');
            $('#statusLeitorUSB').removeClass('alert-secondary alert-success').addClass('alert-warning');
            return false;
          }
        } catch (error) {
          leitorUSBOnline = false;
          $('#statusLeitorTexto').html('Servi√ßo n√£o dispon√≠vel - <a href="#" class="alert-link" onclick="abrirModalLeitor(); return false;">Clique aqui para configurar</a>');
          $('#statusLeitorBadge').removeClass('bg-secondary bg-success bg-warning').addClass('bg-danger').text('Offline');
          $('#statusLeitorUSB').removeClass('alert-secondary alert-success alert-warning').addClass('alert-danger');
          return false;
        }
      }

      // Abre modal de configura√ß√£o do leitor
      function abrirModalLeitor() {
        const modal = new bootstrap.Modal(document.getElementById('modalLeitorBiometrico'));
        modal.show();
        verificarLeitorModal();
      }

      // Verifica status do leitor no modal
      async function verificarLeitorModal() {
        const statusEl = document.getElementById('modalLeitorStatus');
        statusEl.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Verificando...';

        try {
          const response = await fetch(`${BIOMETRIC_API_URL}/`, {
            method: 'GET',
            signal: AbortSignal.timeout(3000)
          });
          const result = await response.json();

          if (result.device_connected) {
            statusEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Leitor conectado! Pode fechar este modal.</span>';
            // Atualiza status principal
            verificarLeitorUSB();
          } else {
            statusEl.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Servi√ßo online, mas leitor n√£o detectado</span>';
          }
        } catch (error) {
          statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Servi√ßo n√£o est√° rodando</span>';
        }
      }

      // Atualiza visual dos slots de digitais (suporta m√∫ltiplas amostras por dedo)
      function atualizarSlotsDigitais(digitais) {
        // Reset todos os slots
        for (let i = 1; i <= 3; i++) {
          $(`#iconeDedo${i}`).removeClass('text-success text-warning').addClass('text-muted');
          $(`#statusDedo${i}`).text('N√£o cadastrada').removeClass('text-success');
          $(`#btnCadastrarDedo${i}`).removeClass('d-none').html('<i class="bi bi-plus-lg me-1"></i>Cadastrar');
          $(`#btnExcluirDedo${i}`).addClass('d-none');
          $(`#amostrasInfo${i}`).remove();
        }

        // Agrupa por dedo
        const porDedo = {};
        if (digitais && digitais.length > 0) {
          digitais.forEach(d => {
            if (!porDedo[d.dedo]) porDedo[d.dedo] = [];
            porDedo[d.dedo].push(d);
          });
        }

        // Atualiza slots com digitais existentes
        for (const dedo in porDedo) {
          const amostras = porDedo[dedo];
          const numAmostras = amostras.length;

          if (dedo >= 1 && dedo <= 3) {
            // Cor: verde se 3 amostras, amarelo se 1-2
            if (numAmostras >= 3) {
              $(`#iconeDedo${dedo}`).removeClass('text-muted text-warning').addClass('text-success');
            } else {
              $(`#iconeDedo${dedo}`).removeClass('text-muted text-success').addClass('text-warning');
            }

            // Status mostra quantas amostras
            const ultimaAmostra = amostras[amostras.length - 1];
            const data = new Date(ultimaAmostra.updated_at || ultimaAmostra.created_at).toLocaleDateString('pt-BR');
            const origem = ultimaAmostra.origem || 'LEITOR';

            let statusHtml = `<span class="${numAmostras >= 3 ? 'text-success' : 'text-warning'}">${numAmostras}/3 amostras</span>`;
            statusHtml += `<br><small class="text-muted">${data}</small>`;

            $(`#statusDedo${dedo}`).html(statusHtml);

            // Se < 3 amostras, mostra bot√£o para adicionar mais
            if (numAmostras < 3) {
              $(`#btnCadastrarDedo${dedo}`).removeClass('d-none').html('<i class="bi bi-plus-lg me-1"></i>Adicionar');
            } else {
              $(`#btnCadastrarDedo${dedo}`).addClass('d-none');
            }

            // Mostra bot√£o de excluir
            $(`#btnExcluirDedo${dedo}`).removeClass('d-none');

            // Adiciona badges das amostras
            const badgesHtml = amostras.map((a, idx) => {
              const origemClass = a.origem === 'SIMULADO' ? 'bg-secondary' : 'bg-primary';
              return `<span class="badge ${origemClass} me-1" title="${a.origem}">${idx + 1}</span>`;
            }).join('');

            // Insere os badges ap√≥s o status
            $(`#statusDedo${dedo}`).parent().find('#amostrasInfo' + dedo).remove();
            $(`#statusDedo${dedo}`).after(`<div id="amostrasInfo${dedo}" class="mt-1">${badgesHtml}</div>`);
          }
        }
      }

      async function gerenciarDigitais(funcionarioId, nome) {
        $('#digitaisFuncionarioId').val(funcionarioId);
        $('#digitaisNomeFuncionario').text(nome);
        $('#digitaisSlotsContainer').removeClass('d-none');
        $('#capturaEmAndamento').addClass('d-none');

        // Reset slots
        atualizarSlotsDigitais([]);

        // Usa getOrCreateInstance para evitar criar m√∫ltiplas inst√¢ncias
        const modalEl = document.getElementById('modalDigitais');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();

        // Verifica status do leitor USB
        await verificarLeitorUSB();

        // Carrega digitais do banco
        try {
          const response = await fetch(`/api/funcionarios/${funcionarioId}/digitais`);
          const result = await response.json();

          if (result.digitais) {
            atualizarSlotsDigitais(result.digitais);
          }
        } catch (error) {
          console.error('Erro ao carregar digitais:', error);
          toastr.error('Erro ao carregar digitais do funcion√°rio');
        }
      }

      // Captura 3 amostras automaticamente em sequ√™ncia
      async function capturarDigitalUSB(dedo) {
        const funcionarioId = $('#digitaisFuncionarioId').val();
        const nome = $('#digitaisNomeFuncionario').text();

        // Verifica leitor
        if (!leitorUSBOnline) {
          const online = await verificarLeitorUSB();
          if (!online) {
            toastr.error('Conecte o leitor biom√©trico USB e inicie o servi√ßo na porta 5001');
            return;
          }
        }

        // Verifica quantas amostras j√° existem para este dedo
        let amostrasExistentes = 0;
        try {
          const res = await fetch(`/api/funcionarios/${funcionarioId}/digitais`);
          const data = await res.json();
          if (data.porDedo && data.porDedo[dedo]) {
            amostrasExistentes = data.porDedo[dedo].length;
          }
        } catch (e) {}

        const amostrasRestantes = 3 - amostrasExistentes;
        if (amostrasRestantes <= 0) {
          toastr.info('Este dedo j√° tem 3 amostras cadastradas');
          return;
        }

        // Mostra tela de captura
        $('#digitaisSlotsContainer').addClass('d-none');
        $('#capturaEmAndamento').removeClass('d-none');

        let amostraAtual = amostrasExistentes + 1;
        let capturasConcluidas = 0;
        let cancelado = false;

        capturaAbortController = new AbortController();

        // Fun√ß√£o para atualizar mensagem na tela
        function atualizarMensagem(msg) {
          $('#capturaEmAndamento .fingerprint-box').next('h5').html(msg);
          // Fallback se n√£o encontrar
          const $textos = $('#capturaEmAndamento').find('h5, .mb-2, p');
          if ($textos.length) {
            $textos.first().html(msg);
          }
        }

        // Loop para capturar as amostras restantes
        for (let i = 0; i < amostrasRestantes && !cancelado; i++) {
          amostraAtual = amostrasExistentes + i + 1;

          // Aguarda tirar e colocar o dedo entre capturas
          if (i > 0) {
            atualizarMensagem(`<strong class="text-warning">RETIRE O DEDO</strong>`);
            await new Promise(resolve => setTimeout(resolve, 1500));
          }

          atualizarMensagem(`<strong>Amostra ${amostraAtual} de 3</strong><br><small>Coloque o dedo no leitor</small>`);

          try {
            const response = await fetch(`${BIOMETRIC_API_URL}/capturar`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ timeout: 30 }),
              signal: capturaAbortController.signal
            });

            let result = await response.json();

            // Captura deve ser real - N√ÉO usa simula√ß√£o
            if (result.success && (result.template || result.template_base64)) {
              const template = result.template || result.template_base64;

              // Salva no banco
              const saveResponse = await fetch(`/api/funcionarios/${funcionarioId}/digitais`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  dedo: dedo,
                  amostra: amostraAtual,
                  template: template,
                  qualidade: result.quality || 0,
                  origem: result.simulated ? 'SIMULADO' : 'LEITOR'
                })
              });

              const saveResult = await saveResponse.json();

              if (saveResult.success) {
                capturasConcluidas++;
                toastr.success(`Amostra ${amostraAtual}/3 salva!`);
              } else {
                toastr.error('Erro ao salvar: ' + (saveResult.error || 'Desconhecido'));
              }
            } else {
              toastr.warning(`Amostra ${amostraAtual} falhou: ${result.error || 'N√£o detectada'}`);
            }
          } catch (error) {
            if (error.name === 'AbortError') {
              cancelado = true;
              toastr.info('Captura cancelada');
            } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('CORS')) {
              // API caiu - aguarda rein√≠cio autom√°tico e tenta novamente
              toastr.warning('Leitor reiniciando... Aguarde 3 segundos');
              atualizarMensagem(`<strong class="text-warning">Reconectando ao leitor...</strong>`);
              await new Promise(resolve => setTimeout(resolve, 3000));

              // Verifica se API voltou
              const apiVoltou = await verificarLeitorUSB();
              if (apiVoltou) {
                toastr.info('Leitor reconectado! Tente novamente.');
                // Decrementa i para repetir esta amostra
                i--;
              } else {
                toastr.error('Leitor n√£o respondeu. Verifique a conex√£o.');
                cancelado = true;
              }
            } else {
              toastr.error('Erro: ' + error.message);
            }
          }
        }

        // Finaliza
        $('#digitaisSlotsContainer').removeClass('d-none');
        $('#capturaEmAndamento').addClass('d-none');

        if (capturasConcluidas > 0) {
          toastr.success(`${capturasConcluidas} amostra(s) cadastrada(s) para o dedo ${dedo}`);
        }

        // Recarrega digitais
        gerenciarDigitais(funcionarioId, nome);
      }

      function cancelarCaptura() {
        if (capturaAbortController) {
          capturaAbortController.abort();
        }
        $('#digitaisSlotsContainer').removeClass('d-none');
        $('#capturaEmAndamento').addClass('d-none');
      }

      async function excluirDigital(dedo) {
        const funcionarioId = $('#digitaisFuncionarioId').val();

        if (!await confirmar(`Deseja excluir a Digital ${dedo}?`, { tipo: 'danger', titulo: 'Excluir Digital' })) return;

        try {
          const response = await fetch(`/api/funcionarios/${funcionarioId}/digitais/${dedo}`, {
            method: 'DELETE'
          });
          const result = await response.json();

          if (result.success) {
            toastr.success(`Digital ${dedo} exclu√≠da`);
            gerenciarDigitais(funcionarioId, $('#digitaisNomeFuncionario').text());
          } else {
            toastr.error('Erro ao excluir: ' + (result.error || 'Desconhecido'));
          }
        } catch (error) {
          toastr.error('Erro de conex√£o');
        }
      }

      // Fun√ß√£o antiga mantida para compatibilidade (captura via REP)
      async function capturarDigital() {
        const funcionarioId = $('#digitaisFuncionarioId').val();
        const repId = $('#selectREPCaptura').val();
        const fingerType = parseInt($('#selectDedo').val());
        const btn = event.target;
        const originalHtml = btn.innerHTML;

        if (!repId) {
          toastr.warning('Selecione um REP para captura.');
          return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        toastr.info('Aguardando funcion√°rio encostar o dedo no REP...');

        try {
          const response = await fetch(`/api/funcionarios/${funcionarioId}/digitais/capturar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rep_id: repId, finger_type: fingerType })
          });
          const result = await response.json();

          if (result.success) {
            toastr.success(result.message || 'Digital capturada com sucesso!');
            // Recarrega lista
            gerenciarDigitais(funcionarioId, $('#digitaisNomeFuncionario').text());
          } else {
            toastr.error('Erro na captura: ' + (result.error || 'Desconhecido'));
          }
        } catch (error) {
          toastr.error('Erro de conex√£o.');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      }
      
      async function baixarDigitaisREP() {
        const funcionarioId = $('#digitaisFuncionarioId').val();
        const btn = event.target;
        const originalHtml = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Baixando...';
        
        try {
          const response = await fetch(`/api/funcionarios/${funcionarioId}/digitais/baixar`, { method: 'POST' });
          const result = await response.json();
          
          if (result.success && result.digitais > 0) {
            toastr.success(`${result.digitais} digital(is) baixada(s) do REP!`);
            // Recarrega lista
            gerenciarDigitais(funcionarioId, $('#digitaisNomeFuncionario').text());
          } else if (result.digitais === 0) {
            toastr.warning('Nenhuma digital encontrada no REP para este funcion√°rio.');
          } else {
            toastr.error('Erro ao baixar: ' + (result.error || 'Desconhecido'));
          }
        } catch (error) {
          toastr.error('Erro de conex√£o.');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      }
      
      async function enviarDigitaisREP() {
        const funcionarioId = $('#digitaisFuncionarioId').val();
        const btn = event.target;
        const originalHtml = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enviando...';
        
        try {
          const response = await fetch(`/api/funcionarios/${funcionarioId}/digitais/enviar`, { method: 'POST' });
          const result = await response.json();
          
          if (result.success && result.enviados > 0) {
            toastr.success(`${result.enviados} digital(is) enviada(s) para os REPs!`);
          } else if (result.enviados === 0 && result.erros === 0) {
            toastr.warning('Nenhuma digital no sistema para enviar.');
          } else {
            toastr.error('Erro ao enviar: ' + (result.error || `${result.erros} erros`));
          }
        } catch (error) {
          toastr.error('Erro de conex√£o.');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      }
      
      // Gera o HTML da coluna de status REP
      function renderStatusREP(pis, funcionarioId) {
        if (!repProxyOnline) return '<span class="text-muted" title="Sistema REP Offline"><i class="bi bi-wifi-off"></i></span>';
        if (!pis) return '<span class="text-muted" title="Sem PIS">-</span>';
        
        pis = String(pis).replace(/\D/g, '').substring(0, 11);
        const status = sincStatus[pis] || {};
        
        // Verifica status geral
        let total = repsDisponiveis.length;
        let sincronizados = 0;
        let listaDetalhes = '';
        
        repsDisponiveis.forEach(rep => {
          const isSync = status[rep.id] === true;
          if (isSync) sincronizados++;
          
          // Item do tooltip/popover
          const icone = isSync ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>';
          const style = isSync ? 'text-success' : 'text-danger';
          const acao = !isSync && rep.online 
            ? ` <a href="javascript:void(0)" onclick="sincronizarFuncionario(this, ${rep.id}, ${funcionarioId})" class="text-primary ms-2" title="Sincronizar Agora"><i class="bi bi-arrow-repeat"></i></a>` 
            : '';
            
          listaDetalhes += `<div class="d-flex justify-content-between align-items-center mb-1">
            <span>${icone} ${rep.nome}</span>
            ${acao}
          </div>`;
        });
        
        // √çcone principal da c√©lula
        let badgesHtml = '';
        if (total === 0) {
          return '<span class="text-muted">Nenhum REP</span>';
        } else if (sincronizados === total) {
          badgesHtml = `<span class="text-success"><i class="bi bi-check-circle-fill"></i> <small>${sincronizados}/${total}</small></span>`;
        } else if (sincronizados > 0) {
          badgesHtml = `<span class="text-warning"><i class="bi bi-exclamation-circle-fill"></i> <small>${sincronizados}/${total}</small></span>`;
        } else {
          badgesHtml = `<span class="text-danger"><i class="bi bi-x-circle-fill"></i> <small>0/${total}</small></span>`;
        }
        
        // Retorna com popover trigger (usando html customizado)
        // Usamos um dropdown simples do Bootstrap para interatividade
        return `
          <div class="dropdown">
            <span class="cursor-pointer" data-bs-toggle="dropdown" aria-expanded="false">
              ${badgesHtml}
            </span>
            <div class="dropdown-menu p-2" style="min-width: 250px; font-size: 0.9em;">
              <h6 class="dropdown-header">Status nos Aparelhos</h6>
              ${listaDetalhes}
              ${sincronizados < total ? '<div class="dropdown-divider"></div><small class="text-muted ps-3">Clique na setinha para sincronizar</small>' : ''}
            </div>
          </div>
        `;
      }

      // Carrega todos os dados auxiliares de uma vez
      async function carregarDadosAuxiliares() {
        try {
          const [unidades, tiposVinculo, jornadas, cargos] = await Promise.all([
            fetch('/api/unidades-gestoras').then(r => r.json()),
            fetch('/api/tipos-vinculo').then(r => r.json()),
            fetch('/api/jornadas').then(r => r.json()),
            fetch('/api/cargos').then(r => r.json())
          ]);

          cacheData.unidadesGestoras = unidades.data || [];
          cacheData.tiposVinculo = tiposVinculo.data || [];
          cacheData.jornadas = jornadas.data || [];
          cacheData.cargos = cargos.data || [];

          // Popula selects do modal
          popularSelect('#unidade_gestora_id', cacheData.unidadesGestoras, 'id', 'nome');
          popularSelect('#tipo_vinculo_id', cacheData.tiposVinculo, 'id', 'nome');
          popularSelectJornada('#jornada_id', cacheData.jornadas);
          popularSelect('#cargo_id', cacheData.cargos, 'id', 'nome');

          // Popula select de filtro de Unidade Gestora e reinicializa Select2
          popularSelectFiltro('#filtroUnidadeGestora', cacheData.unidadesGestoras, 'id', 'nome', 'Todas');
          reinicializarFiltroSelect2('#filtroUnidadeGestora');

          // Popula novos filtros: Cargo, V√≠nculo, Jornada
          popularSelectFiltro('#filtroCargo', cacheData.cargos, 'id', 'nome', 'Todos');
          reinicializarFiltroSelect2('#filtroCargo');

          popularSelectFiltro('#filtroVinculo', cacheData.tiposVinculo, 'id', 'nome', 'Todos');
          reinicializarFiltroSelect2('#filtroVinculo');

          // Jornada j√° tem op√ß√£o fixa "Sem Jornada", s√≥ adiciona as outras com tipo
          const selectJornada = $('#filtroJornada');
          const tipoLabel = { 'NORMAL': '', 'PLANTAO': 'üè• ', 'CORRIDA': '‚ö° ' };
          cacheData.jornadas.forEach(j => {
            const prefix = tipoLabel[j.tipo] || '';
            selectJornada.append(`<option value="${j.id}">${prefix}${j.nome}</option>`);
          });
          reinicializarFiltroSelect2('#filtroJornada');

          // Select de jornada em massa inicia vazio (preenchido pelo filtro de tipo)
          filtrarJornadasMassa();

          carregarFuncionarios();
        } catch (error) {
          console.error('Erro ao carregar dados auxiliares:', error);
          toastr.error('Erro ao carregar dados do sistema');
        }
      }

      function popularSelect(selector, data, valueField, textField, prependEmpty = true) {
        const select = $(selector);
        const currentValue = select.val();

        if (prependEmpty) {
          select.html('<option value="">Selecione...</option>');
        } else {
          select.html('');
        }

        data.forEach(item => {
          const matrizLabel = item.is_matriz ? ' (Matriz)' : '';
          select.append(`<option value="${item[valueField]}">${item[textField]}${matrizLabel}</option>`);
        });

        if (currentValue) select.val(currentValue);
      }

      // Popula select de filtro (usa texto personalizado para op√ß√£o vazia)
      function popularSelectFiltro(selector, data, valueField, textField, emptyText = 'Todas') {
        const select = $(selector);
        const currentValue = select.val();

        select.html(`<option value="">${emptyText}</option>`);

        data.forEach(item => {
          const matrizLabel = item.is_matriz ? ' (Matriz)' : '';
          select.append(`<option value="${item[valueField]}">${item[textField]}${matrizLabel}</option>`);
        });

        if (currentValue) select.val(currentValue);
      }

      // Popula select de jornada com agrupamento por tipo
      function popularSelectJornada(selector, data) {
        const select = $(selector);
        const currentValue = select.val();
        
        select.html('<option value="">Selecione a jornada...</option>');
        
        // Agrupa por tipo
        const grupos = {
          'NORMAL': { label: '<i class="bi bi-calendar"></i> Jornadas Normais', items: [] },
          'PLANTAO': { label: 'üè• Plant√µes', items: [] },
          'CORRIDA': { label: '‚ö° Jornadas Cont√≠nuas', items: [] }
        };
        
        data.forEach(j => {
          const tipo = j.tipo || 'NORMAL';
          if (grupos[tipo]) {
            grupos[tipo].items.push(j);
          } else {
            grupos['NORMAL'].items.push(j);
          }
        });
        
        // Adiciona optgroups se houver mais de um tipo
        const tiposComItens = Object.entries(grupos).filter(([_, g]) => g.items.length > 0);
        
        if (tiposComItens.length > 1) {
          // Usa optgroups
          tiposComItens.forEach(([tipo, grupo]) => {
            const optgroup = $(`<optgroup label="${grupo.label}"></optgroup>`);
            grupo.items.forEach(j => {
              optgroup.append(`<option value="${j.id}">${j.nome}</option>`);
            });
            select.append(optgroup);
          });
        } else {
          // Sem agrupamento
          data.forEach(j => {
            select.append(`<option value="${j.id}">${j.nome}</option>`);
          });
        }
        
        if (currentValue) select.val(currentValue);
      }

      // Filtra jornadas com base no tipo selecionado (para a√ß√£o em massa)
      function filtrarJornadasMassa() {
        const tipoSelecionado = $('#tipoJornadaMassa').val();
        const selectMassa = $('#jornadaMassa');
        
        selectMassa.html('<option value="">Selecione a jornada</option>');
        
        if (!cacheData.jornadas) return;
        
        let jornadasFiltradas = cacheData.jornadas;
        
        if (tipoSelecionado) {
          jornadasFiltradas = cacheData.jornadas.filter(j => (j.tipo || 'NORMAL') === tipoSelecionado);
        }
        
        jornadasFiltradas.forEach(j => {
          selectMassa.append(`<option value="${j.id}">${j.nome}</option>`);
        });
      }

      // Carrega secretarias baseado na unidade gestora
      async function carregarSecretarias() {
        const unidadeId = $('#unidade_gestora_id').val();
        const select = $('#secretaria_id');
        
        if (!unidadeId) {
          select.html('<option value="">Selecione a unidade primeiro</option>');
          $('#lotacao_id').html('<option value="">Selecione a secretaria primeiro</option>');
          return;
        }

        // Mostra indicador de carregamento
        select.html('<option value="">Carregando...</option>').prop('disabled', true);

        try {
          const response = await fetch(`/api/secretarias?unidade_gestora_id=${unidadeId}`);
          const result = await response.json();
          cacheData.secretarias = result.data || [];
          select.prop('disabled', false);
          popularSelect('#secretaria_id', cacheData.secretarias, 'id', 'nome');
        } catch (error) {
          console.error('Erro ao carregar secretarias:', error);
          select.html('<option value="">Erro ao carregar</option>').prop('disabled', false);
        }
      }

      async function carregarSecretariasFiltro() {
        const unidadeId = $('#filtroUnidadeGestora').val();
        const select = $('#filtroSecretaria');

        if (!unidadeId) {
          select.html('<option value="">Todas</option>');
          $('#filtroLotacao').html('<option value="">Todas</option>');
          reinicializarFiltroSelect2('#filtroSecretaria');
          reinicializarFiltroSelect2('#filtroLotacao');
          return;
        }

        try {
          const response = await fetch(`/api/secretarias?unidade_gestora_id=${unidadeId}`);
          const result = await response.json();
          select.html('<option value="">Todas</option>');
          (result.data || []).forEach(s => {
            select.append(`<option value="${s.id}">${s.nome}</option>`);
          });
          // Reinicializa Select2 ap√≥s popular
          reinicializarFiltroSelect2('#filtroSecretaria');
          // Limpa lota√ß√£o quando muda secretaria
          $('#filtroLotacao').html('<option value="">Todas</option>');
          reinicializarFiltroSelect2('#filtroLotacao');
        } catch (error) {
          console.error('Erro:', error);
        }
      }

      // Carrega lota√ß√µes baseado na secretaria
      async function carregarLotacoes() {
        const secretariaId = $('#secretaria_id').val();
        const select = $('#lotacao_id');
        
        if (!secretariaId) {
          select.html('<option value="">Selecione a secretaria primeiro</option>');
          return;
        }

        // Mostra indicador de carregamento
        select.html('<option value="">Carregando...</option>').prop('disabled', true);

        try {
          const response = await fetch(`/api/lotacoes?secretaria_id=${secretariaId}`);
          const result = await response.json();
          cacheData.lotacoes = result.data || [];
          select.prop('disabled', false);
          popularSelect('#lotacao_id', cacheData.lotacoes, 'id', 'nome');
        } catch (error) {
          console.error('Erro ao carregar lota√ß√µes:', error);
          select.html('<option value="">Erro ao carregar</option>').prop('disabled', false);
        }
      }

      async function carregarLotacoesFiltro() {
        const secretariaId = $('#filtroSecretaria').val();
        const select = $('#filtroLotacao');

        if (!secretariaId) {
          select.html('<option value="">Todas</option>');
          reinicializarFiltroSelect2('#filtroLotacao');
          return;
        }

        try {
          const response = await fetch(`/api/lotacoes?secretaria_id=${secretariaId}`);
          const result = await response.json();
          select.html('<option value="">Todas</option>');
          (result.data || []).forEach(l => {
            select.append(`<option value="${l.id}">${l.nome}</option>`);
          });
          // Reinicializa Select2 ap√≥s popular
          reinicializarFiltroSelect2('#filtroLotacao');
        } catch (error) {
          console.error('Erro:', error);
        }
      }

      // Carrega cargos (todos, sem filtro por tipo de v√≠nculo)
      async function carregarCargos() {
        const select = $('#cargo_id');

        try {
          // Carrega todos os cargos sem filtrar por tipo de v√≠nculo
          const response = await fetch('/api/cargos');
          const result = await response.json();
          cacheData.cargos = result.data || [];
          popularSelect('#cargo_id', cacheData.cargos, 'id', 'nome');
        } catch (error) {
          console.error('Erro ao carregar cargos:', error);
        }
      }

      // Carrega lista de funcion√°rios com foto
      let funcionariosComFoto = new Set();
      // Carrega lista de funcion√°rios com digital
      let funcionariosComDigital = new Set();
      
      async function carregarCacheFotos() {
        try {
          const response = await fetch('/api/terminal/fotos');
          const result = await response.json();
          if (result.success) {
            funcionariosComFoto = new Set(result.fotos.map(f => f.funcionario_id));
          }
        } catch (e) {
          console.error('Erro ao carregar cache de fotos', e);
        }
      }

      async function carregarCacheDigitais() {
        try {
          const response = await fetch('/api/terminal/digitais');
          const result = await response.json();
          if (result.success) {
            funcionariosComDigital = new Set(result.digitais.map(d => d.funcionario_id));
          }
        } catch (e) {
          console.error('Erro ao carregar cache de digitais', e);
        }
      }

      async function carregarFuncionarios() {
        try {
          // Atualiza caches antes de renderizar
          await Promise.all([carregarCacheFotos(), carregarCacheDigitais()]);

          const params = new URLSearchParams();
          if ($('#filtroUnidadeGestora').val()) params.append('unidade_gestora_id', $('#filtroUnidadeGestora').val());
          if ($('#filtroSecretaria').val()) params.append('secretaria_id', $('#filtroSecretaria').val());
          if ($('#filtroLotacao').val()) params.append('lotacao_id', $('#filtroLotacao').val());
          if ($('#filtroStatus').val()) params.append('ativo', $('#filtroStatus').val());
          if ($('#filtroCargo').val()) params.append('cargo_id', $('#filtroCargo').val());
          if ($('#filtroVinculo').val()) params.append('tipo_vinculo_id', $('#filtroVinculo').val());

          const response = await fetch(`/api/funcionarios?${params.toString()}`);
          const result = await response.json();

          // Atualiza cache de funcion√°rios para valida√ß√£o de CPF/PIS
          funcionariosData = result.data || [];

          // Aplica filtro de jornada no frontend (inclui "sem_jornada")
          const filtroJornada = $('#filtroJornada').val();
          let dadosFiltrados = funcionariosData;
          if (filtroJornada === 'sem_jornada') {
            dadosFiltrados = funcionariosData.filter(f => !f.jornada_id);
          } else if (filtroJornada) {
            dadosFiltrados = funcionariosData.filter(f => f.jornada_id == filtroJornada);
          }
          
          if (dataTable) {
            dataTable.destroy();
          }

          dataTable = $('#tabelaFuncionarios').DataTable({
            data: dadosFiltrados,
            columns: [
              {
                data: null,
                orderable: false,
                render: function(data) {
                  return `<input type="checkbox" class="check-funcionario" data-id="${data.id}">`;
                }
              },
              { data: 'matricula' },
              { 
                data: 'nome',
                render: function(data, type, row) {
                  let icones = '';
                  if (funcionariosComFoto.has(row.id)) {
                    icones += '<i class="bi bi-person-bounding-box text-success ms-2" title="Foto cadastrada"></i>';
                  }
                  if (funcionariosComDigital.has(row.id)) {
                    icones += '<i class="bi bi-fingerprint text-info ms-1" title="Digital cadastrada"></i>';
                  }
                  if (row.intervalo_presenca) {
                    icones += '<i class="bi bi-clock-history text-warning ms-1" title="Presenca: a cada ' + row.intervalo_presenca + ' min"></i>';
                  }
                  return data + icones;
                }
              },
              {
                data: 'cpf',
                render: function(data) {
                  return formatarCPF(data);
                }
              },
              { data: 'cargo_nome', defaultContent: '-' },
              { data: 'lotacao_nome', defaultContent: '-' },
              { data: 'tipo_vinculo_nome', defaultContent: '-' },
              {
                data: 'jornada_nome',
                render: function(data) {
                  if (!data) return '<span class="badge bg-warning text-dark">N√£o definida</span>';
                  return data;
                }
              },
              {
                data: 'pis',
                orderable: false,
                render: function(data, type, row) {
                  return renderStatusREP(data, row.id);
                }
              },
              {
                data: 'ativo',
                render: function(data) {
                  return data !== false 
                    ? '<span class="badge bg-success">Ativo</span>'
                    : '<span class="badge bg-danger">Inativo</span>';
                }
              },
              {
                data: null,
                orderable: false,
                render: function(data) {
                  return `
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-info" onclick="cadastrarFoto(${data.id}, '${data.nome}')" title="Foto Facial">
                        <i class="bi bi-camera"></i>
                      </button>
                      <button class="btn btn-outline-secondary" onclick="gerenciarDigitais(${data.id}, '${data.nome}')" title="Digitais">
                        <i class="bi bi-fingerprint"></i>
                      </button>
                      <button class="btn btn-outline-primary" onclick="editarFuncionario(${data.id})" title="Editar">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-outline-warning" onclick="resetarSenha(${data.id}, '${data.nome}', '${data.cpf}')" title="Resetar Senha">
                        <i class="bi bi-key"></i>
                      </button>
                      <button class="btn btn-outline-danger" onclick="excluirFuncionario(${data.id}, '${data.nome}')" title="Excluir">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  `;
                }
              }
            ],
            order: [[2, 'asc']],
            drawCallback: function() {
              // Handler para checkboxes
              $('.check-funcionario').off('change').on('change', atualizarBarraAcoesMassa);
            }
          });
        } catch (error) {
          console.error('Erro:', error);
          toastr.error('Erro ao carregar funcion√°rios');
        }
      }

      function novoFuncionario() {
        editandoId = null;
        $('#modalFuncionarioTitle').text('Novo Funcion√°rio');
        $('#formFuncionario')[0].reset();
        $('#funcionarioId').val('');
        $('#secretaria_id').html('<option value="">Selecione a unidade primeiro</option>');
        $('#lotacao_id').html('<option value="">Selecione a secretaria primeiro</option>');
        // Mant√©m cargos j√° carregados
        popularSelect('#cargo_id', cacheData.cargos, 'id', 'nome');

        // Switch ativo = true
        $('#ativo').prop('checked', true);
        $('#ativoLabel').text('Ativo');

        // Reset valida√ß√µes visuais
        $('#cpf, #pis').removeClass('is-valid is-invalid');
        $('#cpfStatus').html('<i class="bi bi-question-circle text-muted"></i>');
        $('#pisStatus').html('<i class="bi bi-question-circle text-muted"></i>');

        // Reinicializa Select2
        reinicializarSelect2();

        // Reinicializa Flatpickr
        reinicializarFlatpickr();

        // Esconde bot√£o excluir (apenas vis√≠vel em edi√ß√£o)
        $('#btnExcluirFuncionario').addClass('d-none');
      }

      async function editarFuncionario(id) {
        try {
          // Reset do formul√°rio antes de carregar novos dados
          $('#formFuncionario')[0].reset();
          $('.is-invalid').removeClass('is-invalid');
          
          editandoId = id;
          const response = await fetch(`/api/funcionarios/${id}`);
          const func = await response.json();
          
          console.log('[Editar] Dados recebidos:', func);
          console.log('[Editar] unidade_gestora_id:', func.unidade_gestora_id);
          console.log('[Editar] secretaria_id:', func.secretaria_id);
          console.log('[Editar] lotacao_id:', func.lotacao_id);

          $('#modalFuncionarioTitle').text('Editar Funcion√°rio');
          $('#funcionarioId').val(func.id);
          $('#matricula').val(func.matricula);
          $('#cpf').val(formatarCPF(func.cpf));
          $('#pis').val(formatarPIS(func.pis));
          $('#sexo').val(func.sexo);
          $('#nome').val(func.nome);

          // Datas
          if (func.data_nascimento) {
            dataNascimentoPicker.setDate(func.data_nascimento.split('T')[0], true);
          }
          if (func.data_admissao) {
            dataAdmissaoPicker.setDate(func.data_admissao.split('T')[0], true);
          }
          if (func.data_demissao) {
            dataDemissaoPicker.setDate(func.data_demissao.split('T')[0], true);
          }

          // Switch ativo
          const isAtivo = func.ativo !== false;
          $('#ativo').prop('checked', isAtivo);
          $('#ativoLabel').text(isAtivo ? 'Ativo' : 'Inativo');

          // Reset valida√ß√µes visuais (CPF/PIS j√° existem, ent√£o mostra check verde)
          $('#cpf, #pis').removeClass('is-invalid');
          $('#cpfStatus').html('<i class="bi bi-check-circle text-success"></i>');
          $('#pisStatus').html('<i class="bi bi-check-circle text-success"></i>');

          // Popula os selects com os dados do cache
          popularSelect('#unidade_gestora_id', cacheData.unidadesGestoras, 'id', 'nome');
          popularSelect('#tipo_vinculo_id', cacheData.tiposVinculo, 'id', 'nome');
          popularSelectJornada('#jornada_id', cacheData.jornadas);
          popularSelect('#cargo_id', cacheData.cargos, 'id', 'nome');

          // Seta os valores dos selects simples
          $('#tipo_vinculo_id').val(func.tipo_vinculo_id);
          $('#jornada_id').val(func.jornada_id);
          $('#cargo_id').val(func.cargo_id);
          $('#intervalo_presenca').val(func.intervalo_presenca || '');

          // Carrega cascata: unidade -> secretaria -> lota√ß√£o
          console.log('[Editar] Iniciando cascata...');
          if (func.unidade_gestora_id) {
            console.log('[Editar] Setando unidade_gestora_id:', func.unidade_gestora_id);
            $('#unidade_gestora_id').val(func.unidade_gestora_id);
            
            // Carrega secretarias da unidade
            const secResponse = await fetch(`/api/secretarias?unidade_gestora_id=${func.unidade_gestora_id}`);
            const secResult = await secResponse.json();
            cacheData.secretarias = secResult.data || [];
            popularSelect('#secretaria_id', cacheData.secretarias, 'id', 'nome');
            
            if (func.secretaria_id) {
              $('#secretaria_id').val(func.secretaria_id);
              
              // Carrega lota√ß√µes da secretaria
              const lotResponse = await fetch(`/api/lotacoes?secretaria_id=${func.secretaria_id}`);
              const lotResult = await lotResponse.json();
              cacheData.lotacoes = lotResult.data || [];
              popularSelect('#lotacao_id', cacheData.lotacoes, 'id', 'nome');
              
              if (func.lotacao_id) {
                $('#lotacao_id').val(func.lotacao_id);
              }
            }
          }

          // Mostra bot√£o excluir apenas se funcion√°rio pode ser exclu√≠do (sem registros)
          if (func.podeExcluir) {
            $('#btnExcluirFuncionario').removeClass('d-none');
          } else {
            $('#btnExcluirFuncionario').addClass('d-none');
          }

          new bootstrap.Modal(document.getElementById('modalFuncionario')).show();
        } catch (error) {
          console.error('Erro ao editar:', error);
          toastr.error('Erro ao carregar funcion√°rio');
        }
      }

      // Excluir funcion√°rio
      async function excluirFuncionario() {
        if (!editandoId) {
          toastr.error('Nenhum funcion√°rio selecionado');
          return;
        }

        const confirmado = await confirmar(
          'Deseja excluir permanentemente este funcion√°rio? Esta a√ß√£o n√£o pode ser desfeita.',
          { 
            tipo: 'danger', 
            titulo: 'Excluir Funcion√°rio',
            textoBtnConfirmar: 'Sim, Excluir'
          }
        );
        
        if (!confirmado) return;

        try {
          const response = await fetch(`/api/funcionarios/${editandoId}`, {
            method: 'DELETE',
            headers: {
              'X-CSRF-TOKEN': getCsrfToken()
            }
          });

          const result = await response.json();

          if (response.ok && result.success) {
            toastr.success(result.message || 'Funcion√°rio exclu√≠do com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('modalFuncionario'))?.hide();
            dataTable.ajax.reload();
          } else {
            toastr.error(result.error || 'Erro ao excluir funcion√°rio');
          }
        } catch (error) {
          console.error('Erro:', error);
          toastr.error('Erro ao processar exclus√£o');
        }
      }

      // Submit do form
      $('#formFuncionario').on('submit', async function(e) {
        e.preventDefault();

        // Valida√ß√£o manual dos campos obrigat√≥rios
        const camposObrigatorios = [
          { id: 'unidade_gestora_id', nome: 'Unidade' },
          { id: 'secretaria_id', nome: 'Departamento' },
          { id: 'lotacao_id', nome: 'Setor' },
          { id: 'cargo_id', nome: 'Cargo' },
          { id: 'jornada_id', nome: 'Jornada' },
          { id: 'tipo_vinculo_id', nome: 'Tipo de V√≠nculo' }
        ];

        for (const campo of camposObrigatorios) {
          const valor = $('#' + campo.id).val();
          if (!valor) {
            toastr.error('Campo obrigat√≥rio: ' + campo.nome);
            $('#' + campo.id).addClass('is-invalid').focus();
            return;
          }
          $('#' + campo.id).removeClass('is-invalid');
        }

        // Pega o valor do CPF
        const cpfValue = ($('#cpf').val() || '').replace(/\D/g, '');
        
        // Valida CPF se fornecido (n√£o obrigat√≥rio para dados do REP)
        if (cpfValue && cpfValue.length > 0) {
          // Verifica d√≠gitos verificadores
          if (!validarCPF(cpfValue)) {
            toastr.error('CPF inv√°lido - d√≠gitos verificadores n√£o conferem');
            $('#cpf').addClass('is-invalid').focus();
            return;
          }
        }

        // Verifica se CPF est√° marcado como duplicado
        if ($('#cpf').hasClass('is-invalid')) {
          toastr.error('CPF j√° cadastrado em outro funcion√°rio');
          $('#cpf').focus();
          return;
        }

        // Verifica se PIS est√° v√°lido (n√£o duplicado)
        if ($('#pis').hasClass('is-invalid')) {
          toastr.error('PIS j√° cadastrado em outro funcion√°rio');
          $('#pis').focus();
          return;
        }

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        const id = data.id;
        delete data.id;
        delete data.unidade_gestora_id;
        delete data.secretaria_id;

        // Ativo vem do checkbox (switch)
        data.ativo = $('#ativo').is(':checked');

        // Limpa m√°scara do CPF e PIS antes de enviar
        data.cpf = (data.cpf || '').replace(/\D/g, '');
        data.pis = (data.pis || '').replace(/\D/g, '');

        // Converte IDs para n√∫meros
        ['lotacao_id', 'cargo_id', 'tipo_vinculo_id', 'jornada_id'].forEach(field => {
          if (data[field]) data[field] = parseInt(data[field]);
          else delete data[field];
        });

        // Intervalo de presenca (pode ser null/vazio)
        if (data.intervalo_presenca) {
          data.intervalo_presenca = parseInt(data.intervalo_presenca);
        } else {
          data.intervalo_presenca = null;
        }

        try {
          const url = id ? `/api/funcionarios/${id}` : '/api/funcionarios';
          const method = id ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content
            },
            body: JSON.stringify(data)
          });

          if (response.ok) {
            toastr.success(id ? 'Funcion√°rio atualizado!' : 'Funcion√°rio cadastrado!');
            bootstrap.Modal.getInstance(document.getElementById('modalFuncionario')).hide();
            carregarFuncionarios();
          } else {
            const err = await response.json();
            toastr.error(err.error || 'Erro ao salvar');
          }
        } catch (error) {
          console.error(error);
          toastr.error('Erro ao processar requisi√ß√£o');
        }
      });

      async function excluirFuncionario(id, nome) {
        if (!await confirmar(`Deseja realmente excluir o funcion√°rio "${nome}"?`, { tipo: 'danger', titulo: 'Excluir Funcion√°rio' })) return;

        try {
          const response = await fetch(`/api/funcionarios/${id}`, {
            method: 'DELETE',
            headers: {
              'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content
            }
          });

          if (response.ok) {
            toastr.success('Funcion√°rio exclu√≠do!');
            carregarFuncionarios();
          } else {
            toastr.error('Erro ao excluir');
          }
        } catch (error) {
          toastr.error('Erro ao processar');
        }
      }

      // ============ A√á√ïES EM MASSA ============
      function toggleCheckAll(checkbox) {
        $('.check-funcionario').prop('checked', checkbox.checked);
        atualizarBarraAcoesMassa();
      }

      function atualizarBarraAcoesMassa() {
        const selecionados = $('.check-funcionario:checked').length;
        $('#qtdSelecionados').text(selecionados);
        
        if (selecionados > 0) {
          $('#barraAcoesMassa').removeClass('d-none');
        } else {
          $('#barraAcoesMassa').addClass('d-none');
        }
      }

      function desmarcarTodos() {
        $('#checkAll').prop('checked', false);
        $('.check-funcionario').prop('checked', false);
        atualizarBarraAcoesMassa();
      }

      async function vincularJornadaMassa() {
        const jornadaId = $('#jornadaMassa').val();
        if (!jornadaId) {
          toastr.warning('Selecione uma jornada');
          return;
        }

        const ids = [];
        $('.check-funcionario:checked').each(function() {
          ids.push($(this).data('id'));
        });

        if (ids.length === 0) {
          toastr.warning('Nenhum funcion√°rio selecionado');
          return;
        }

        if (!await confirmar(`Deseja vincular ${ids.length} funcion√°rio(s) √† jornada selecionada?`, { tipo: 'info', titulo: 'Vincular Jornada' })) {
          return;
        }

        try {
          const response = await fetch('/api/funcionarios/vincular-jornada', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content
            },
            body: JSON.stringify({
              funcionario_ids: ids,
              jornada_id: parseInt(jornadaId)
            })
          });

          const result = await response.json();

          if (response.ok) {
            toastr.success(`${result.atualizados || ids.length} funcion√°rio(s) vinculado(s) √† jornada!`);
            desmarcarTodos();
            carregarFuncionarios();
          } else {
            toastr.error(result.error || 'Erro ao vincular');
          }
        } catch (error) {
          console.error(error);
          toastr.error('Erro ao processar requisi√ß√£o');
        }
      }

      function limparFiltros() {
        $('#filtroUnidadeGestora').val('').trigger('change');
        $('#filtroSecretaria').val('').trigger('change');
        $('#filtroLotacao').val('').trigger('change');
        $('#filtroCargo').val('').trigger('change');
        $('#filtroVinculo').val('').trigger('change');
        $('#filtroJornada').val('').trigger('change');
        $('#filtroStatus').val('').trigger('change');
        carregarFuncionarios();
      }
    </script>
  @end
@end
