<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="refresh" content="30">
  <title>{{ municipio.nome }} - Painel de Votação</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root { --cor-primaria: {{ municipio.cor_primaria || '#1a56db' }}; --cor-secundaria: {{ municipio.cor_secundaria || '#1e40af' }}; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; min-height: 100vh; overflow: hidden; }
    .header { background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.75rem; font-weight: 700; }
    .main-content { padding: 2rem; display: flex; gap: 2rem; height: calc(100vh - 100px); }
    .votacao-panel { flex: 2; display: flex; flex-direction: column; }
    .materia-box { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; }
    .materia-tipo { background: var(--cor-primaria); display: inline-block; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; margin-bottom: 1rem; }
    .materia-numero { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
    .materia-ementa { font-size: 1.25rem; opacity: 0.9; }
    .votos-container { display: flex; gap: 2rem; flex: 1; }
    .votos-box { flex: 1; background: rgba(255,255,255,0.05); border-radius: 16px; padding: 2rem; display: flex; flex-direction: column; }
    .votos-box.sim { border: 3px solid #10b981; }
    .votos-box.nao { border: 3px solid #ef4444; }
    .votos-box.abstencao { border: 3px solid #6b7280; }
    .votos-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .votos-label { font-size: 1.5rem; font-weight: 600; text-transform: uppercase; }
    .votos-count { font-size: 4rem; font-weight: 700; }
    .votos-box.sim .votos-count { color: #10b981; }
    .votos-box.nao .votos-count { color: #ef4444; }
    .votos-box.abstencao .votos-count { color: #6b7280; }
    .votos-list { flex: 1; overflow-y: auto; }
    .voto-item { display: flex; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 0.5rem; }
    .voto-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 1rem; }
    .voto-item .nome { font-weight: 600; }
    .voto-item .partido { font-size: 0.875rem; opacity: 0.7; }
    .side-panel { width: 350px; display: flex; flex-direction: column; gap: 1.5rem; }
    .quorum-box { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 1.5rem; }
    .quorum-title { font-size: 1rem; opacity: 0.7; margin-bottom: 0.5rem; }
    .quorum-numbers { display: flex; align-items: baseline; gap: 0.5rem; }
    .quorum-presente { font-size: 3rem; font-weight: 700; color: #10b981; }
    .quorum-total { font-size: 1.5rem; opacity: 0.5; }
    .aguardando-box { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 1.5rem; flex: 1; overflow-y: auto; }
    .aguardando-title { font-size: 1rem; opacity: 0.7; margin-bottom: 1rem; display: flex; justify-content: space-between; }
    .aguardando-item { display: flex; align-items: center; padding: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .sem-votacao { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .sem-votacao i { font-size: 6rem; opacity: 0.3; margin-bottom: 1rem; }
    .vereadores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; padding: 1rem; }
    .vereador-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1rem; text-align: center; border: 2px solid transparent; }
    .vereador-card.presente { border-color: #10b981; }
    .vereador-card.ausente { opacity: 0.4; }
    .vereador-card img { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 0.5rem; }
    .vereador-card .nome { font-weight: 600; font-size: 0.8rem; }
    .vereador-card .partido { font-size: 0.7rem; opacity: 0.7; }
  </style>
</head>
<body x-data="painelVotacao()" x-init="init()">
  <div class="header">
    <h1><i class="bi bi-bank me-2"></i>{{ municipio.nome }}</h1>
    <div class="text-end">
      <div class="fw-bold">Sessão {{ sessao.tipo }} {{ sessao.numero }}/{{ sessao.ano }}</div>
      <div style="opacity: 0.8;">{{ new Date(sessao.data).toLocaleDateString('pt-BR') }}</div>
    </div>
  </div>

  <div class="main-content">
    @if(votacao)
      <div class="votacao-panel">
        <div class="materia-box">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              @if(votacao.materia_prefixo)
                <span class="materia-tipo">{{ votacao.tipo }}</span>
                <div class="materia-numero">{{ votacao.materia_prefixo }} {{ votacao.materia_numero }}/{{ votacao.materia_ano }}</div>
                <div class="materia-ementa">{{ votacao.materia_ementa }}</div>
              @else
                <span class="materia-tipo pulse">VOTAÇÃO EM ANDAMENTO</span>
                <div class="materia-numero">{{ votacao.descricao }}</div>
              @endif
            </div>
            <div class="badge bg-warning text-dark fs-5 pulse"><i class="bi bi-broadcast me-1"></i> AO VIVO</div>
          </div>
        </div>

        <div class="votos-container">
          <div class="votos-box sim">
            <div class="votos-header">
              <span class="votos-label"><i class="bi bi-hand-thumbs-up-fill me-2"></i>SIM</span>
              <span class="votos-count" x-text="contagem.sim">{{ contagem?.sim || 0 }}</span>
            </div>
            <div class="votos-list">
              @if(votacao.tipo === 'nominal')
                @each(v in votos.filter(x => x.voto === 'sim'))
                  <div class="voto-item">
                    <div class="rounded-circle bg-success d-flex align-items-center justify-content-center" style="width:40px;height:40px;margin-right:1rem;"><i class="bi bi-check-lg"></i></div>
                    <div><div class="nome">{{ v.nome_parlamentar || v.nome }}</div><div class="partido">{{ v.partido_sigla }}</div></div>
                  </div>
                @endeach
              @endif
            </div>
          </div>

          <div class="votos-box nao">
            <div class="votos-header">
              <span class="votos-label"><i class="bi bi-hand-thumbs-down-fill me-2"></i>NÃO</span>
              <span class="votos-count" x-text="contagem.nao">{{ contagem?.nao || 0 }}</span>
            </div>
            <div class="votos-list">
              @if(votacao.tipo === 'nominal')
                @each(v in votos.filter(x => x.voto === 'nao'))
                  <div class="voto-item">
                    <div class="rounded-circle bg-danger d-flex align-items-center justify-content-center" style="width:40px;height:40px;margin-right:1rem;"><i class="bi bi-x-lg"></i></div>
                    <div><div class="nome">{{ v.nome_parlamentar || v.nome }}</div><div class="partido">{{ v.partido_sigla }}</div></div>
                  </div>
                @endeach
              @endif
            </div>
          </div>

          <div class="votos-box abstencao">
            <div class="votos-header">
              <span class="votos-label"><i class="bi bi-dash-circle-fill me-2"></i>ABST.</span>
              <span class="votos-count" x-text="contagem.abstencao">{{ contagem?.abstencao || 0 }}</span>
            </div>
            <div class="votos-list">
              @if(votacao.tipo === 'nominal')
                @each(v in votos.filter(x => x.voto === 'abstencao'))
                  <div class="voto-item"><div><div class="nome">{{ v.nome_parlamentar || v.nome }}</div><div class="partido">{{ v.partido_sigla }}</div></div></div>
                @endeach
              @endif
            </div>
          </div>
        </div>
      </div>

      <div class="side-panel">
        <div class="quorum-box">
          <div class="quorum-title">QUÓRUM</div>
          <div class="quorum-numbers">
            <span class="quorum-presente">{{ quorum.presentes }}</span>
            <span class="quorum-total">/ {{ quorum.total }}</span>
          </div>
          <div class="small mt-2">Mínimo: {{ quorum.minimo }} @if(quorum.atingido)<i class="bi bi-check-circle-fill text-success"></i>@endif</div>
        </div>
        <div class="aguardando-box">
          <div class="aguardando-title"><span>AGUARDANDO</span><span class="badge bg-warning text-dark">{{ aguardandoVoto.length }}</span></div>
          @each(v in aguardandoVoto)
            <div class="aguardando-item"><i class="bi bi-hourglass-split me-2 text-warning"></i>{{ v.nome_parlamentar || v.nome }}<span class="ms-auto opacity-50">{{ v.partido }}</span></div>
          @endeach
        </div>
      </div>
    @else
      <div class="votacao-panel">
        <div class="sem-votacao"><i class="bi bi-hand-thumbs-up"></i><h2>Aguardando votação</h2></div>
        <div class="vereadores-grid">
          @each(v in vereadores)
            <div class="vereador-card {{ v.presente ? 'presente' : 'ausente' }}">
              <div class="rounded-circle bg-secondary mx-auto mb-2 d-flex align-items-center justify-content-center" style="width:50px;height:50px;"><i class="bi bi-person"></i></div>
              <div class="nome">{{ v.nome_parlamentar || v.nome }}</div>
              <div class="partido">{{ v.partido_sigla }}</div>
            </div>
          @endeach
        </div>
      </div>
      <div class="side-panel">
        <div class="quorum-box">
          <div class="quorum-title">QUÓRUM DA SESSÃO</div>
          <div class="quorum-numbers"><span class="quorum-presente">{{ quorum.presentes }}</span><span class="quorum-total">/ {{ quorum.total }}</span></div>
        </div>
      </div>
    @endif
  </div>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    function painelVotacao() {
      return {
        contagem: { sim: {{ contagem?.sim || 0 }}, nao: {{ contagem?.nao || 0 }}, abstencao: {{ contagem?.abstencao || 0 }} },
        init() {
          // Polling simples a cada 5s
          setInterval(() => {
            fetch('/api/painel/{{ municipio.codigo || municipio.id }}/estado')
              .then(r => r.json())
              .then(data => {
                if (data.votacao) {
                  this.contagem = data.votacao.contagem || this.contagem;
                }
              });
          }, 5000);
        }
      }
    }
  </script>
</body>
</html>
